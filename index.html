<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SurveyLight | 輕量級問卷平台</title>
  <meta name="theme-color" content="#2563eb" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="SurveyLight" />
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20192%20192'%3E%3Crect%20width='192'%20height='192'%20rx='40'%20fill='%232563eb'/%3E%3Cpath%20d='M60%2050h72a10%2010%200%200%201%2010%2010v88a10%2010%200%200%201-10%2010H60a10%2010%200%200%201-10-10V60a10%2010%200%200%201%2010-10z'%20fill='%23ffffff'/%3E%3Cpath%20d='M72%2076h48'%20stroke='%232563eb'%20stroke-width='10'%20stroke-linecap='round'/%3E%3Cpath%20d='M72%20100h48'%20stroke='%232563eb'%20stroke-width='10'%20stroke-linecap='round'/%3E%3Cpath%20d='M72%20124h34'%20stroke='%232563eb'%20stroke-width='10'%20stroke-linecap='round'/%3E%3C/svg%3E" />
  <link rel="manifest" href="./manifest.webmanifest" />

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel Standalone (CDN) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase Compat CDN (避免 ES Module / 子目錄路徑問題) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

  <!-- Phosphor Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <!-- Canvas Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
    
    :root {
      --primary: #4F46E5;
      --primary-soft: #EEF2FF;
      --primary-hover: #4338CA;
      --bg: #F8FAFC;
      --surface: #FFFFFF;
      --text-main: #0F172A;
      --text-muted: #64748B;
      --border: #E2E8F0;
      --radius-xl: 1.5rem;
      --radius-2xl: 2rem;
      --radius-3xl: 3rem;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    }

    html, body { height: 100%; scroll-behavior: smooth; }
    body { 
      font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
      background-color: var(--bg); 
      color: var(--text-main);
      overflow-x: hidden; 
      -webkit-font-smoothing: antialiased;
    }

    /* Layout & Containers */
    .app-container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 0 1.5rem;
    }

    /* Refined Components */
    .card {
      background: var(--surface);
      border-radius: var(--radius-2xl);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card-hover:hover {
      box-shadow: var(--shadow-xl);
      transform: translateY(-4px);
      border-color: var(--primary);
    }

    /* Buttons */
    .btn-base {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      border-radius: 1rem;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 14px 0 rgba(79, 70, 229, 0.3);
    }

    .btn-primary:hover {
      background: var(--primary-hover);
      box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--primary-soft);
      color: var(--primary);
    }

    .btn-secondary:hover {
      background: #E0E7FF;
      transform: translateY(-1px);
    }

    /* Smooth transitions - Only apply to specific properties to avoid layout issues */
    .transition-base { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }

    .spinner { 
      border: 3px solid var(--primary-soft); 
      width: 40px; 
      height: 40px; 
      border-radius: 50%; 
      border-left-color: var(--primary); 
      animation: spin 0.8s linear infinite; 
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .fade-in { animation: fadeIn 0.4s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .fade-in-up { animation: fadeInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes fadeInUp { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    /* Glassmorphism */
    .glass {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: var(--shadow-lg);
    }

    /* War Room Design (Enhanced Clarity) */
    .war-room-bg {
      background: #020617;
      color: #F8FAFC;
      min-height: 100vh;
      position: relative;
      overflow: hidden;
    }

    .war-room-card {
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-radius: var(--radius-xl);
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }

    .war-room-glow {
      box-shadow: 0 0 20px rgba(99, 102, 241, 0.15), inset 0 0 10px rgba(99, 102, 241, 0.05);
    }

    .war-room-text-glow {
      text-shadow: 0 0 10px rgba(129, 140, 248, 0.4);
    }

    .war-room-pulse {
      animation: war-room-pulse 2s infinite;
    }

    @keyframes war-room-pulse {
      0% { opacity: 0.4; text-shadow: 0 0 5px rgba(129, 140, 248, 0.2); }
      50% { opacity: 1; text-shadow: 0 0 15px rgba(129, 140, 248, 0.6); }
      100% { opacity: 0.4; text-shadow: 0 0 5px rgba(129, 140, 248, 0.2); }
    }

    .war-room-cyber-border {
      position: relative;
    }

    .war-room-cyber-border::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 20px;
      height: 2px;
      background: var(--primary);
      box-shadow: 0 0 10px var(--primary);
    }

    .war-room-cyber-border::after {
      content: '';
      position: absolute;
      bottom: 0;
      right: 0;
      width: 2px;
      height: 20px;
      background: var(--primary);
      box-shadow: 0 0 10px var(--primary);
    }

    .war-room-accent {
      color: #818CF8;
      text-shadow: 0 0 8px rgba(129, 140, 248, 0.4);
    }

    .war-room-grid {
      background-image: linear-gradient(rgba(99, 102, 241, 0.05) 1px, transparent 1px), 
                        linear-gradient(90deg, rgba(99, 102, 241, 0.05) 1px, transparent 1px);
      background-size: 30px 30px;
    }
    
    .floating-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      background: radial-gradient(circle at 50% 50%, #f8fafc 0%, #f1f5f9 100%);
      overflow: hidden;
    }
    .blob {
      position: absolute;
      width: 600px;
      height: 600px;
      background: linear-gradient(135deg, rgba(79, 70, 229, 0.05) 0%, rgba(129, 140, 248, 0.05) 100%);
      filter: blur(80px);
      border-radius: 50%;
      animation: blob-float 20s infinite alternate;
    }
    @keyframes blob-float {
      from { transform: translate(-10%, -10%) scale(1); }
      to { transform: translate(20%, 20%) scale(1.2); }
    }

    .shake {
      animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
    }
    @keyframes shake {
      10%, 90% { transform: translate3d(-1px, 0, 0); }
      20%, 80% { transform: translate3d(2px, 0, 0); }
      30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
      40%, 60% { transform: translate3d(4px, 0, 0); }
    }

    /* Input styling */
    .input-elegant {
      width: 100%;
      background-color: rgba(255, 255, 255, 0.6);
      border: 1px solid #E2E8F0;
      border-radius: 1rem;
      padding: 1rem 1.25rem;
      outline: none;
      transition: all 0.3s;
      font-weight: 500;
    }
    .input-elegant:focus {
      border-color: #4F46E5;
      box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
    }

    /* Card styling */
    .card-modern {
      background-color: white;
      border-radius: 2.5rem;
      border: 1px solid #F1F5F9;
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      transition: all 0.5s;
      position: relative;
      z-index: 1;
    }
    .card-modern:hover {
      box-shadow: 0 20px 25px -5px rgba(79, 70, 229, 0.05);
      transform: translateY(-0.25rem);
      z-index: 10;
    }

    /* Custom Button Animation */
    .btn-hover-effect {
      position: relative;
      overflow: hidden;
    }
    .btn-hover-effect::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s ease-out, height 0.6s ease-out;
    }
    .btn-hover-effect:hover::after {
      width: 300%;
      height: 300%;
    }
    /* Responsive Adjustments */
    @media (max-width: 640px) {
      .card-modern { @apply rounded-[2rem] p-6; }
      .glass { @apply rounded-[2rem] p-6; }
      h1 { @apply text-3xl; }
      .text-5xl { @apply text-3xl; }
      .text-4xl { @apply text-2xl; }
    }
  </style>
</head>
<body>
  <!-- 避免 React 載入前白屏 -->
  <div id="boot-loading" class="min-h-screen flex items-center justify-center p-6">
    <div class="bg-white rounded-2xl shadow-lg p-8 w-full max-w-sm text-center">
      <div class="w-20 h-20 mx-auto mb-4 bg-primary rounded-2xl flex items-center justify-center shadow-lg overflow-hidden p-3">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 192" class="w-full h-full">
          <rect width="192" height="192" rx="40" fill="#4F46E5"/>
          <path d="M60 50h72a10 10 0 0 1 10 10v88a10 10 0 0 1-10 10H60a10 10 0 0 1-10-10V60a10 10 0 0 1 10-10z" fill="#ffffff"/>
          <path d="M72 76h48" stroke="#4F46E5" stroke-width="10" stroke-linecap="round"/>
          <path d="M72 100h48" stroke="#4F46E5" stroke-width="10" stroke-linecap="round"/>
          <path d="M72 124h34" stroke="#4F46E5" stroke-width="10" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="text-gray-800 font-bold text-lg">SurveyLight</div>
      <div class="text-gray-500 text-sm mt-1">載入中...</div>
    </div>
  </div>
  <div id="root"></div>

  <!-- 全域錯誤捕捉：任何致命錯誤都直接顯示在畫面上方便除錯 -->
  <div id="global-error-overlay" class="hidden fixed inset-0 z-[9999] bg-black/50 p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-3xl mx-auto p-4 border border-red-200">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-red-600 font-bold text-lg">發生未預期的錯誤</div>
          <div class="text-gray-500 text-xs mt-1">請按 F12 開啟開發者工具查看 Console，並將此畫面截圖回報。</div>
        </div>
        <button id="global-error-close" class="text-gray-500 hover:text-gray-800">
          <i class="ph ph-x text-xl"></i>
        </button>
      </div>
      <pre id="global-error-text" class="mt-3 text-sm whitespace-pre-wrap break-words bg-red-50 text-red-700 p-3 rounded-lg overflow-auto max-h-[60vh]"></pre>
    </div>
  </div>
  <script>
    (function () {
      const overlay = document.getElementById('global-error-overlay');
      const closeBtn = document.getElementById('global-error-close');
      const textEl = document.getElementById('global-error-text');

      function showGlobalError(payload) {
        try {
          textEl.textContent = payload;
          overlay.classList.remove('hidden');
        } catch (e) {
          // fallback
          alert(payload);
        }
      }

      closeBtn.addEventListener('click', function () {
        overlay.classList.add('hidden');
      });

      window.__showGlobalError = showGlobalError;

      window.onerror = function (message, source, lineno, colno, error) {
        const detail = [
          `訊息: ${message}`,
          `來源: ${source}:${lineno}:${colno}`,
          error && error.stack ? `Stack:\n${error.stack}` : ''
        ].filter(Boolean).join('\n');
        console.error("Global Error:", message, error);
        showGlobalError(detail);
        return false;
      };

      window.onunhandledrejection = function (event) {
        const reason = event && event.reason ? event.reason : event;
        console.error("Unhandled Rejection:", reason);
        const detail = typeof reason === 'string'
          ? reason
          : (reason && reason.stack) ? reason.stack : JSON.stringify(reason, null, 2);
        showGlobalError(`Promise 未處理錯誤:\n${detail}`);
      };
    })();
  </script>

  <script type="text/babel" data-presets="react,env">
    const { useEffect, useMemo, useRef, useState } = React;

    // --- Firebase Configuration (依需求直接嵌入) ---
    const firebaseConfig = {
      apiKey: "AIzaSyCkpv2OVqWkY9weBhCDholL8cgulJkDrgw",
      authDomain: "survey-light.firebaseapp.com",
      projectId: "survey-light",
      storageBucket: "survey-light.firebasestorage.app",
      messagingSenderId: "319145934342",
      appId: "1:319145934342:web:55a411eb01d8e2512a8d87",
      measurementId: "G-8Z1PNB2ZH8"
    };

    function safeNow() { return Date.now(); }
    function ms30Days() { return 30 * 24 * 60 * 60 * 1000; }

    // Initialize Firebase
    if (!firebase.apps.length) {
      try {
        firebase.initializeApp(firebaseConfig);
      } catch (e) {
        console.error("Firebase init error:", e);
        window.__showGlobalError?.("Firebase 初始化失敗：\n" + (e && e.stack ? e.stack : e.message));
      }
    }
    const auth = firebase.auth();
    const db = firebase.firestore();
    auth.useDeviceLanguage();

    // --- Firebase Diagnostics ---
    async function checkFirebaseStatus() {
      console.log("DIAG: Checking Firebase status...");
      try {
        // Test auth
        const user = auth.currentUser;
        console.log("DIAG: Current User:", user ? user.uid : "Not logged in");
        
        // Test firestore connection
        const start = Date.now();
        await db.collection("surveys").limit(1).get();
        console.log("DIAG: Firestore connection OK (latency: " + (Date.now() - start) + "ms)");
        return { ok: true };
      } catch (err) {
        console.error("DIAG: Firebase status check FAILED:", err);
        return { ok: false, error: err.message };
      }
    }
    window.__checkFirebase = checkFirebaseStatus;

    // --- UI Primitives ---
    const Button = ({ children, onClick, variant = "primary", className = "", disabled = false, type = "button", ...props }) => {
      const base = "btn-base active:scale-95 disabled:opacity-50 disabled:pointer-events-none";
      const variants = {
        primary: "btn-primary",
        secondary: "btn-secondary",
        danger: "bg-rose-50 text-rose-600 hover:bg-rose-600 hover:text-white shadow-rose-100",
        outline: "border-2 border-slate-100 text-slate-500 hover:border-indigo-600 hover:text-indigo-600 bg-transparent",
      };
      return (
        <button type={type} onClick={onClick} disabled={disabled} className={`${base} ${variants[variant]} ${className}`} {...props}>
          {children}
        </button>
      );
    };

    const Loading = ({ text = "載入中..." }) => (
      <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-slate-50/50 backdrop-blur-sm">
        <div className="card p-12 text-center max-w-sm w-full relative overflow-hidden">
          <div className="absolute top-0 left-0 w-full h-1 bg-slate-100">
            <div className="h-full bg-indigo-600 animate-[loading_1.5s_infinite_ease-in-out]"></div>
          </div>
          <style>{`
            @keyframes loading {
              0% { width: 0; left: 0; }
              50% { width: 70%; left: 15%; }
              100% { width: 0; left: 100%; }
            }
          `}</style>
          <div className="w-16 h-16 mx-auto mb-8 bg-primary rounded-2xl flex items-center justify-center shadow-lg overflow-hidden p-2.5">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 192" className="w-full h-full">
              <rect width="192" height="192" rx="40" fill="#4F46E5"/>
              <path d="M60 50h72a10 10 0 0 1 10 10v88a10 10 0 0 1-10 10H60a10 10 0 0 1-10-10V60a10 10 0 0 1 10-10z" fill="#ffffff"/>
              <path d="M72 76h48" stroke="#4F46E5" stroke-width="10" stroke-linecap="round"/>
              <path d="M72 100h48" stroke="#4F46E5" stroke-width="10" stroke-linecap="round"/>
              <path d="M72 124h34" stroke="#4F46E5" stroke-width="10" stroke-linecap="round"/>
            </svg>
          </div>
          <div className="text-slate-800 font-black text-2xl tracking-tight mb-2">{text}</div>
          <div className="text-indigo-600/40 text-[10px] font-black uppercase tracking-[0.3em]">SurveyLight Engine</div>
        </div>
      </div>
    );

    const Notice = ({ variant = "info", children }) => {
      const styles = {
        info: "bg-indigo-50/80 text-indigo-700 border-indigo-100/50 shadow-indigo-500/5",
        danger: "bg-rose-50/80 text-rose-700 border-rose-100/50 shadow-rose-500/5",
        success: "bg-emerald-50/80 text-emerald-700 border-emerald-100/50 shadow-emerald-500/5",
        warn: "bg-amber-50/80 text-amber-800 border-amber-100/50 shadow-amber-500/5",
      };
      const icon = {
        info: "ph-info",
        danger: "ph-warning-circle",
        success: "ph-check-circle",
        warn: "ph-warning",
      }[variant];
      return (
        <div className={`${styles[variant]} backdrop-blur-md border px-6 py-4 rounded-[1.5rem] text-sm font-bold flex items-start gap-4 fade-in`}>
          <div className="w-8 h-8 rounded-xl bg-white/50 flex items-center justify-center flex-shrink-0">
            <i className={`ph ${icon} text-xl`}></i>
          </div>
          <div className="min-w-0 flex-1 pt-1.5">{children}</div>
        </div>
      );
    };

    const Toast = ({ message, type = "success", onClose }) => {
      useEffect(() => {
        const timer = setTimeout(onClose, 5000);
        return () => clearTimeout(timer);
      }, [onClose, message]);

      const configs = {
        success: { icon: "ph-check-bold", color: "bg-emerald-500", border: "border-emerald-500/20" },
        error: { icon: "ph-x-bold", color: "bg-rose-500", border: "border-rose-500/20" },
        info: { icon: "ph-info-bold", color: "bg-indigo-500", border: "border-indigo-500/20" },
        war: { icon: "ph-broadcast-bold", color: "bg-indigo-600", border: "border-indigo-400/50", glow: "shadow-[0_0_20px_rgba(99,102,241,0.4)]" }
      };
      const config = configs[type] || configs.success;

      return (
        <div className="fixed bottom-10 left-1/2 -translate-x-1/2 z-[9999] fade-in-up">
          <div className={`bg-slate-900/90 backdrop-blur-xl text-white px-6 py-4 rounded-[2rem] shadow-2xl flex items-center gap-4 border ${config.border} ${config.glow || ''}`}>
            <div className={`w-8 h-8 rounded-full ${config.color} flex items-center justify-center shrink-0`}>
              <i className={`ph ${config.icon} text-white`}></i>
            </div>
            <span className="font-bold text-sm tracking-wide">{message}</span>
            <button 
              onClick={onClose} 
              title="關閉通知"
              aria-label="關閉通知"
              className="ml-2 p-1 hover:bg-white/10 rounded-full transition-colors text-white/40 hover:text-white"
            >
              <i className="ph ph-x text-sm"></i>
            </button>
          </div>
        </div>
      );
    };

    const Modal = ({ title, children, onClose, footer, warRoom = false }) => {
      return (
        <div className="fixed inset-0 z-[10000] p-4 flex items-center justify-center">
          <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-xl transition-all duration-500" onClick={onClose}></div>
          <div className={`relative rounded-[2.5rem] shadow-xl w-full max-w-2xl overflow-hidden fade-in border ${
            warRoom 
              ? 'war-room-card border-white/10' 
              : 'bg-white/95 backdrop-blur-2xl border-white'
          }`}>
            <div className={`flex items-center justify-between p-6 sm:p-8 border-b ${warRoom ? 'border-white/5' : 'border-slate-50/50'}`}>
              <h3 className={`font-bold text-xl sm:text-2xl tracking-tight ${warRoom ? 'text-white' : 'text-slate-900'}`}>{title}</h3>
              <button 
                onClick={onClose} 
                title="關閉彈窗"
                aria-label="關閉彈窗"
                className={`w-10 h-10 flex items-center justify-center rounded-2xl transition-all duration-300 ${
                warRoom 
                  ? 'bg-white/5 text-white/40 hover:bg-rose-500/20 hover:text-rose-400' 
                  : 'bg-slate-50 text-slate-400 hover:bg-rose-50 hover:text-rose-600'
              }`}>
                <i className="ph ph-x text-xl"></i>
              </button>
            </div>
            <div className="p-4 sm:p-8 max-h-[75vh] overflow-auto">
              {children}
            </div>
            {footer && <div className={`p-6 sm:p-8 backdrop-blur-md flex justify-end gap-4 border-t ${
              warRoom ? 'bg-white/5 border-white/5' : 'bg-slate-50/30 border-slate-50/50'
            }`}>{footer}</div>}
          </div>
        </div>
      );
    };

    // --- Routing ---
    // 部署在 GitHub Pages 子路徑（/SurveyLight/）時，建議用 hash 路由避免 404。
    // Public Respondent View 仍然使用 URL 參數 ?s=surveyId（依需求）。
    function getHashRoute() {
      const raw = (window.location.hash || "").replace(/^#/, "");
      const route = raw.startsWith("/") ? raw : (raw ? "/" + raw : "/");
      return route;
    }
    function navigateHash(route) {
      const r = route.startsWith("/") ? route : "/" + route;
      window.location.hash = r;
    }

    // --- Auth / Errors ---
    function mapAuthErrorToZh(err) {
      const code = err && err.code;
      if (code === "auth/popup-blocked") return "登入視窗被瀏覽器封鎖，請允許彈跳視窗後重試。";
      if (code === "auth/unauthorized-domain") return `網域授權錯誤：此網域未被 Firebase 授權。\n請到 Firebase Console → Authentication → Settings → Authorized domains 新增：${window.location.hostname}`;
      if (code === "auth/operation-not-allowed") return "此專案尚未啟用 Google 登入方式，請到 Firebase Console 啟用 Google Provider。";
      return (err && err.message) ? err.message : "登入失敗，請稍後再試。";
    }

    // --- Firestore helpers ---
    async function commitBatches(ops, label = "batch") {
      // Firestore batch 每批最多 500 ops；這裡自動分批。
      const MAX = 450; // 留一些 buffer，避免未來擴充時踩到 500
      let idx = 0;
      while (idx < ops.length) {
        const batch = db.batch();
        const slice = ops.slice(idx, idx + MAX);
        slice.forEach(fn => fn(batch));
        await batch.commit();
        idx += slice.length;
        console.log(`[${label}] committed ${idx}/${ops.length}`);
      }
    }

    // --- Views ---
    const InAppBrowserNotice = () => {
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      return (
        <div className="min-h-screen flex items-center justify-center p-6 bg-slate-50">
          {/* Background Decorative Elements */}
          <div className="floating-bg">
            <div className="blob" style={{ top: '-10%', left: '-10%', animationDelay: '0s', background: 'linear-gradient(135deg, rgba(79, 70, 229, 0.05) 0%, rgba(129, 140, 248, 0.05) 100%)' }}></div>
            <div className="blob" style={{ top: '60%', left: '70%', animationDelay: '-5s', width: '500px', height: '500px', background: 'linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(165, 180, 252, 0.05) 100%)' }}></div>
          </div>
          
          <div className="bg-white/80 backdrop-blur-2xl p-12 rounded-[3.5rem] shadow-2xl shadow-slate-200/50 w-full max-w-md text-center border border-white fade-in relative overflow-hidden">
            <div className="absolute top-0 right-0 w-32 h-32 bg-indigo-50/50 rounded-full -mr-16 -mt-16"></div>
            
            <div className="w-28 h-28 bg-indigo-600 text-white rounded-[2.5rem] flex items-center justify-center mx-auto mb-10 shadow-2xl shadow-indigo-200 rotate-3">
              <i className="ph ph-browser text-6xl"></i>
            </div>
            
            <h2 className="text-3xl font-black text-slate-900 mb-4 tracking-tight leading-tight">請使用瀏覽器開啟</h2>
            <p className="text-slate-500 font-medium mb-10 leading-relaxed">
              為了您的帳號安全，Google 不允許在 LINE 或 Facebook 等內建瀏覽器中登入。
            </p>
            
            <div className="space-y-6">
              <div className="p-8 bg-slate-50/50 rounded-[2.5rem] text-left border border-slate-100/50 backdrop-blur-sm">
                <p className="text-slate-900 font-black text-sm mb-6 flex items-center gap-3">
                  <span className="w-8 h-8 bg-indigo-600 text-white rounded-xl flex items-center justify-center">
                    <i className="ph ph-list-numbers text-xl"></i>
                  </span>
                  操作步驟：
                </p>
                <ol className="text-slate-600 font-bold text-sm space-y-4 ml-1">
                  <li className="flex gap-4 items-center">
                    <span className="flex-shrink-0 w-6 h-6 bg-white text-indigo-600 rounded-lg text-xs flex items-center justify-center font-black shadow-sm border border-indigo-50">1</span>
                    點擊右上角的 <span className="px-2 py-1 bg-white rounded-lg shadow-sm border border-slate-100 text-slate-900 mx-1">「⋯」</span>
                  </li>
                  <li className="flex gap-4 items-center">
                    <span className="flex-shrink-0 w-6 h-6 bg-white text-indigo-600 rounded-lg text-xs flex items-center justify-center font-black shadow-sm border border-indigo-50">2</span>
                    選擇 <span className="px-2 py-1 bg-white rounded-lg shadow-sm border border-slate-100 text-slate-900 mx-1">「在瀏覽器開啟」</span>
                  </li>
                </ol>
              </div>
              
              <div className="flex items-center justify-center gap-4 text-slate-400 font-black text-[10px] uppercase tracking-[0.2em] pt-4">
                <div className="h-px flex-1 bg-slate-100"></div>
                推薦使用 {isIOS ? "Safari" : "Chrome"}
                <div className="h-px flex-1 bg-slate-100"></div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const LoginView = () => {
      const [error, setError] = useState(null);
      const [loading, setLoading] = useState(false);
      const handleGoogleLogin = async () => {
        setLoading(true);
        setError(null);
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
          await auth.signInWithPopup(provider);
        } catch (err) {
          console.error("Login Error:", err);
          if (err.code === "auth/popup-blocked") {
            try {
              await auth.signInWithRedirect(provider);
            } catch (reErr) {
              setError(mapAuthErrorToZh(reErr));
              setLoading(false);
            }
          } else {
            setError(mapAuthErrorToZh(err));
            setLoading(false);
          }
        }
      };
      return (
        <div className="min-h-screen flex items-center justify-center p-6 bg-slate-50">
          <div className="floating-bg">
            <div className="blob" style={{ top: '-5%', left: '-5%', animationDelay: '0s' }}></div>
            <div className="blob" style={{ top: '70%', left: '80%', animationDelay: '-8s', width: '500px', height: '500px' }}></div>
          </div>

          <div className="card p-10 sm:p-12 max-w-md w-full text-center relative overflow-hidden bg-white/80 backdrop-blur-xl border-white/50">
            <div className="relative">
              <div className="w-24 h-24 sm:w-28 sm:h-28 bg-primary text-white rounded-[2rem] flex items-center justify-center mx-auto mb-8 shadow-xl shadow-primary/20 rotate-3 hover:rotate-0 transition-transform duration-500 overflow-hidden">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 192" className="w-full h-full">
                  <rect width="192" height="192" rx="40" fill="#4F46E5"/>
                  <path d="M60 50h72a10 10 0 0 1 10 10v88a10 10 0 0 1-10 10H60a10 10 0 0 1-10-10V60a10 10 0 0 1 10-10z" fill="#ffffff"/>
                  <path d="M72 76h48" stroke="#4F46E5" stroke-width="10" stroke-linecap="round"/>
                  <path d="M72 100h48" stroke="#4F46E5" stroke-width="10" stroke-linecap="round"/>
                  <path d="M72 124h34" stroke="#4F46E5" stroke-width="10" stroke-linecap="round"/>
                </svg>
              </div>
              
              <h1 className="text-3xl sm:text-4xl font-extrabold text-slate-900 mb-2 tracking-tight">SurveyLight</h1>
              <p className="text-slate-500 font-medium mb-10">讓問卷收集變得輕而易舉</p>
              
              {error && <div className="mb-6"><Notice variant="danger">{error}</Notice></div>}
              
              <button 
                onClick={handleGoogleLogin} 
                disabled={loading} 
                title="使用 Google 帳號快速登入"
                aria-label="使用 Google 帳號快速登入"
                className="w-full btn-base bg-white border border-slate-200 hover:border-primary hover:shadow-lg hover:shadow-primary/5 py-4 rounded-2xl font-bold text-slate-700 transition-all flex items-center justify-center gap-3 active:scale-95 disabled:opacity-50"
              >
                {loading ? (
                  <span className="spinner w-5 h-5"></span>
                ) : (
                  <>
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-5 h-5" />
                    <span>使用 Google 帳號登入</span>
                  </>
                )}
              </button>
              
              <div className="mt-12 pt-8 border-t border-slate-100 flex flex-col items-center gap-3">
                <p className="text-[10px] text-slate-400 font-bold uppercase tracking-[0.2em]">Powered by Firebase</p>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const optimizeFile = async (file) => {
      // 只針對圖片進行壓縮優化
      if (!file.type.startsWith('image/')) return file;
      
      console.log(`OPTIMIZING FILE: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);
      
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
          const img = new Image();
          img.src = e.target.result;
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            // 設定最大維度為 1600px，超過則等比例縮小
            const MAX_DIM = 1600;
            if (width > height) {
              if (width > MAX_DIM) {
                height *= MAX_DIM / width;
                width = MAX_DIM;
              }
            } else {
              if (height > MAX_DIM) {
                width *= MAX_DIM / height;
                height = MAX_DIM;
              }
            }
            
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // 轉為 JPEG 格式，品質設定為 0.8 (兼顧清晰度與檔案大小)
            canvas.toBlob((blob) => {
              const optimizedFile = new File([blob], file.name.replace(/\.[^/.]+$/, "") + ".jpg", {
                type: 'image/jpeg',
                lastModified: Date.now()
              });
              console.log(`OPTIMIZED RESULT: ${optimizedFile.name} (${(optimizedFile.size / 1024).toFixed(2)} KB)`);
              resolve(optimizedFile);
            }, 'image/jpeg', 0.8);
          };
          img.onerror = () => resolve(file);
        };
        reader.onerror = () => resolve(file);
      });
    };

    const Dashboard = ({ user, onCreate, onAnalytics, onDelete }) => {
      const [surveys, setSurveys] = useState([]);
      const [totalResponsesCount, setTotalResponsesCount] = useState(0);
      const [loading, setLoading] = useState(true);
      const [cleanupStatus, setCleanupStatus] = useState(null);
      const [toast, setToast] = useState(null);
      const [searchTerm, setSearchTerm] = useState("");
      const [sortBy, setSortBy] = useState("newest"); // newest, oldest, responses

      // Handle global delete event
      useEffect(() => {
        const handleDeleted = (e) => {
          const id = e.detail;
          setSurveys(prev => prev.filter(s => s.id !== id));
        };
        window.addEventListener('survey-deleted', handleDeleted);
        return () => window.removeEventListener('survey-deleted', handleDeleted);
      }, []);

      const filteredSurveys = useMemo(() => {
        let list = [...surveys];
        if (searchTerm.trim()) {
          const term = searchTerm.toLowerCase();
          list = list.filter(s => 
            (s.title || "").toLowerCase().includes(term) || 
            (s.description || "").toLowerCase().includes(term)
          );
        }
        
        if (sortBy === "newest") {
          list.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
        } else if (sortBy === "oldest") {
          list.sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
        } else if (sortBy === "alphabetical") {
          list.sort((a, b) => (a.title || "").localeCompare(b.title || ""));
        }
        return list;
      }, [surveys, searchTerm, sortBy]);

      useEffect(() => {
        let cancelled = false;
        const run = async () => {
          setLoading(true);
          setCleanupStatus(null);
          try {
            // Fetch surveys
            const snap = await db.collection("surveys").where("creatorId", "==", user.uid).get();
            let data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            data.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

            // Fetch total responses count
            const respSnapAll = await db.collection("responses")
              .where("surveyCreatorId", "==", user.uid)
              .get();
            
            if (!cancelled) setTotalResponsesCount(respSnapAll.size);

            // Auto-Cleanup：刪除該使用者名下超過 30 天的「問卷」與「回覆」
            const threshold = safeNow() - ms30Days();
            const oldSurveys = data.filter(s => (s.createdAt || 0) < threshold);
            const oldResponseDocs = respSnapAll.docs.filter(d => (d.data().submittedAt || 0) < threshold);

            const ops = [];
            oldResponseDocs.forEach(d => ops.push((batch) => batch.delete(d.ref)));
            oldSurveys.forEach(s => ops.push((batch) => batch.delete(db.collection("surveys").doc(s.id))));

            if (ops.length > 0) {
              await commitBatches(ops, "auto-cleanup");
              setCleanupStatus(`已自動清理：過期回覆 ${oldResponseDocs.length} 筆、過期問卷 ${oldSurveys.length} 筆（>30 天）`);
              // Update local count after cleanup
              if (!cancelled) setTotalResponsesCount(prev => prev - oldResponseDocs.length);
            }

            // 更新列表（移除過期問卷）
            data = data.filter(s => (s.createdAt || 0) >= threshold);
            if (!cancelled) setSurveys(data);
          } catch (err) {
            console.error("Dashboard error:", err);
            setToast({ message: "載入儀表板失敗：" + (err && err.message ? err.message : String(err)), type: "error" });
          } finally {
            if (!cancelled) setLoading(false);
          }
        };
        run();
        return () => { cancelled = true; };
      }, [user.uid]);

      const getPublicSurveyUrl = (id, title) => {
        // 使用 URL 物件來確保路徑解析正確，避免在不同環境下（如 GitHub Pages 或本地 file://）出現雙重路徑問題
        const url = new URL(window.location.href.split('?')[0].split('#')[0]);
        url.searchParams.set("s", id);
        if (title) {
          url.searchParams.set("t", title);
        }
        return url.toString();
      };

      const shareSurvey = async (survey) => {
        const url = getPublicSurveyUrl(survey.id, survey.title);
        
        try {
          await navigator.clipboard.writeText(url);
          setToast({ message: "問卷網址已複製到剪貼簿！✨", type: "success" });
        } catch (e) {
          console.error("Clipboard copy failed:", e);
          setToast({ message: "複製失敗，請手動複製網址", type: "error" });
        }
      };

      const deleteSurvey = (id) => {
        console.log("DASHBOARD: deleteSurvey triggered for ID:", id);
        if (!id) {
          console.error("DASHBOARD: deleteSurvey called without ID");
          return;
        }
        // 使用全域傳進來的 onDelete (即 setDeleteTarget)
        onDelete(id);
        // 提供快速反饋
        setToast({ message: "正在準備刪除問卷...", type: "info" });
      };

      const duplicateSurvey = async (survey) => {
        try {
          setLoading(true);
          const newSurvey = {
            ...survey,
            title: `${survey.title || "未命名問卷"} (副本)`,
            createdAt: safeNow(),
            active: true,
            shareToken: survey.shareToken ? String(Math.random().toString(36).substring(2, 11)) : null
          };
          delete newSurvey.id; // Let Firestore generate a new ID
          const docRef = await db.collection("surveys").add(newSurvey);
          const createdSurvey = { id: docRef.id, ...newSurvey };
          setSurveys(prev => [createdSurvey, ...prev]);
          setToast({ message: "已成功複製問卷副本", type: "success" });
        } catch (err) {
          setToast({ message: "複製失敗：" + (err.message || "未知錯誤"), type: "error" });
        } finally {
          setLoading(false);
        }
      };

      const getPublicAnalyticsUrl = (token) => {
        const url = new URL(window.location.href.split('?')[0].split('#')[0]);
        url.hash = `#/analytics/public/${token}`;
        return url.toString();
      };

      const sharePublicAnalytics = async (survey) => {
        if (!survey.shareToken) return;
        const url = getPublicAnalyticsUrl(survey.shareToken);
        const title = `SurveyLight 分析報告｜${survey.title || "問卷"}`;
        const text = `查看此問卷的即時分析數據：${survey.title}\n公開連結：${url}`;

        if (navigator.share) {
          try {
            await navigator.share({ title, text, url });
            return;
          } catch (e) {}
        }

        try {
          await navigator.clipboard.writeText(url);
          setToast({ message: "已複製公開分析連結", type: "success" });
        } catch (e) {
          setToast({ message: "複製失敗", type: "error" });
        }
      };

      const handleImport = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (event) => {
          try {
            const data = JSON.parse(event.target.result);
            if (!data.questions || !Array.isArray(data.questions)) {
              throw new Error("無效的問卷格式：缺少問題清單");
            }

            setLoading(true);
            const newSurvey = {
              title: (data.title || "匯入的問卷") + " (匯入)",
              description: data.description || "",
              questions: data.questions.map(q => ({
                ...q,
                id: q.id || String(safeNow() + Math.random())
              })),
              creatorId: user.uid,
              active: true,
              createdAt: safeNow(),
              shareToken: Math.random().toString(36).substring(2, 11),
              expireAt: data.expireAt || null,
              limitCount: data.limitCount || null,
            };

            await db.collection("surveys").add(newSurvey);
            setToast({ message: "問卷匯入成功！✨", type: "success" });
            // Clear the input
            e.target.value = "";
          } catch (err) {
            setToast({ message: "匯入失敗：" + (err.message || "未知錯誤"), type: "error" });
          } finally {
            setLoading(false);
          }
        };
        reader.readAsText(file);
      };

      if (loading) return <Loading text="正在整理您的儀表板..." />;

      // Calculate simple stats
      const totalSurveys = surveys.length;
      const totalActive = surveys.filter(s => s.active).length;

      return (
        <div className="app-container py-12 fade-in pb-32">
          {/* Dashboard Background Micro-interactions */}
          <div className="floating-bg">
            <div className="blob" style={{ top: '10%', left: '80%', animationDelay: '-2s' }}></div>
            <div className="blob" style={{ top: '60%', left: '-10%', animationDelay: '-7s', width: '500px', height: '500px' }}></div>
          </div>
          {toast && <Toast message={toast.message} onClose={() => setToast(null)} />}
        
          {/* Dashboard Header */}
          <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-12 gap-8">
            <div className="space-y-4 flex-1 w-full">
              <div className="inline-flex items-center gap-3 px-4 py-1.5 rounded-full bg-primary-soft text-primary text-[10px] font-bold uppercase tracking-widest border border-primary/10">
                <span className="w-1.5 h-1.5 rounded-full bg-primary animate-pulse"></span>
                Creator Dashboard
              </div>
              <h1 className="text-4xl sm:text-5xl font-extrabold text-slate-900 tracking-tight">
                我的問卷庫<span className="text-primary">.</span>
              </h1>
            </div>

            <div className="flex flex-col sm:flex-row items-stretch gap-4 w-full lg:w-auto">
              <div className="grid grid-cols-3 gap-3 flex-1">
                <div className="card px-4 py-4 flex flex-col items-center justify-center min-w-[100px] hover:border-primary/20 transition-all">
                  <span className="text-2xl font-bold text-slate-900 leading-none mb-1">{totalSurveys}</span>
                  <span className="text-[10px] font-bold text-slate-400 uppercase tracking-wider text-center">問卷總數</span>
                </div>
                <div className="card px-4 py-4 flex flex-col items-center justify-center min-w-[100px] hover:border-emerald-200 transition-all">
                  <span className="text-2xl font-bold text-slate-900 leading-none mb-1">{totalActive}</span>
                  <span className="text-[10px] font-bold text-slate-400 uppercase tracking-wider text-center">進行中</span>
                </div>
                <div className="card px-4 py-4 flex flex-col items-center justify-center min-w-[100px] hover:border-blue-200 transition-all">
                  <span className="text-2xl font-bold text-slate-900 leading-none mb-1">{totalResponsesCount}</span>
                  <span className="text-[10px] font-bold text-slate-400 uppercase tracking-wider text-center">總回覆數</span>
                </div>
              </div>
              
              <div className="flex gap-3">
                <Button onClick={onCreate} className="flex-1 sm:flex-none px-8 py-4 bg-slate-900 hover:bg-primary group rounded-2xl">
                  <i className="ph ph-plus-bold text-xl group-hover:rotate-90 transition-transform"></i>
                  <span>建立問卷</span>
                </Button>
                <label className="cursor-pointer" title="匯入問卷 JSON 檔案" aria-label="匯入問卷 JSON 檔案">
                  <input type="file" accept=".json" className="hidden" onChange={handleImport} />
                  <div className="btn-base btn-secondary px-6 py-4 rounded-2xl h-full">
                    <i className="ph ph-upload-simple-bold text-xl"></i>
                  </div>
                </label>
              </div>
            </div>
          </div>

          {cleanupStatus && <div className="mb-8 sm:mb-10"><Notice variant="info">{cleanupStatus}</Notice></div>}

          <div className="mb-8 sm:mb-12 flex flex-col lg:flex-row gap-4 sm:gap-6 items-center justify-between">
            <div className="flex flex-col md:flex-row items-stretch md:items-center gap-4 sm:gap-6 w-full lg:max-w-4xl">
              <div className="relative flex-1 group">
                <i className="ph ph-magnifying-glass-bold absolute left-5 sm:left-6 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-600 transition-colors text-lg sm:text-xl"></i>
                <input 
                  type="text"
                  placeholder="搜尋問卷標題或內容..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="w-full pl-12 sm:pl-14 pr-6 sm:pr-8 py-4 sm:py-5 bg-white border-2 border-slate-100 rounded-2xl sm:rounded-[2rem] focus:outline-none focus:border-indigo-600 focus:shadow-2xl focus:shadow-indigo-500/10 transition-all font-medium text-slate-900 placeholder:text-slate-300 shadow-sm text-sm sm:text-base"
                />
              </div>
              
              <div className="flex items-center bg-white p-1.5 sm:p-2 rounded-2xl sm:rounded-[2rem] border-2 border-slate-100 shadow-sm overflow-x-auto no-scrollbar">
                <button 
                  onClick={() => setSortBy("newest")}
                  title="依建立時間從新到舊排序"
                  aria-label="依建立時間從新到舊排序"
                  className={`flex-1 sm:flex-none whitespace-nowrap px-4 sm:px-6 py-2.5 sm:py-3 rounded-xl sm:rounded-2xl text-[9px] sm:text-[10px] font-black uppercase tracking-widest transition-all ${sortBy === "newest" ? "bg-slate-900 text-white shadow-lg" : "text-slate-400 hover:bg-slate-50"}`}
                >
                  最新
                </button>
                <button 
                  onClick={() => setSortBy("oldest")}
                  title="依建立時間從舊到新排序"
                  aria-label="依建立時間從舊到新排序"
                  className={`flex-1 sm:flex-none whitespace-nowrap px-4 sm:px-6 py-2.5 sm:py-3 rounded-xl sm:rounded-2xl text-[9px] sm:text-[10px] font-black uppercase tracking-widest transition-all ${sortBy === "oldest" ? "bg-slate-900 text-white shadow-lg" : "text-slate-400 hover:bg-slate-50"}`}
                >
                  最舊
                </button>
                <button 
                  onClick={() => setSortBy("alphabetical")}
                  title="依問卷標題名稱排序"
                  aria-label="依問卷標題名稱排序"
                  className={`flex-1 sm:flex-none whitespace-nowrap px-4 sm:px-6 py-2.5 sm:py-3 rounded-xl sm:rounded-2xl text-[9px] sm:text-[10px] font-black uppercase tracking-widest transition-all ${sortBy === "alphabetical" ? "bg-slate-900 text-white shadow-lg" : "text-slate-400 hover:bg-slate-50"}`}
                >
                  名稱
                </button>
              </div>
            </div>
            
            <div className="flex items-center gap-3 sm:gap-4 text-slate-400 text-[9px] sm:text-[10px] font-black uppercase tracking-[0.1em] sm:tracking-[0.2em] bg-slate-50 px-4 sm:px-6 py-2.5 sm:py-3 rounded-xl sm:rounded-2xl border border-slate-100 w-full lg:w-auto justify-center sm:justify-start">
              <i className="ph ph-list-numbers-bold text-base sm:text-lg"></i>
              <span>共 {filteredSurveys.length} 份問卷</span>
            </div>
          </div>

          <div className="relative">
            {surveys.length === 0 ? (
              <div className="text-center py-40 glass rounded-[5rem] border-4 border-dashed border-slate-100 flex flex-col items-center group">
                <div className="relative w-40 h-40 mb-10">
                  <div className="absolute inset-0 bg-slate-50 rounded-[3.5rem] rotate-12 group-hover:rotate-0 transition-transform duration-700 shadow-inner"></div>
                  <div className="absolute inset-4 bg-white rounded-[2.5rem] -rotate-6 group-hover:rotate-0 transition-transform duration-700 shadow-sm flex items-center justify-center">
                    <i className="ph ph-folder-simple-dashed text-7xl text-slate-200 group-hover:text-indigo-200 transition-colors"></i>
                  </div>
                </div>
                <h3 className="text-4xl font-black text-slate-900 mb-6 tracking-tight">目前空空如也</h3>
                <p className="text-slate-400 mb-12 max-w-sm mx-auto text-lg font-medium leading-relaxed">您的問卷庫目前還沒有問卷。立即點擊下方按鈕，開始您的數據收集之旅吧！</p>
                <Button 
                  variant="secondary" 
                  onClick={onCreate} 
                  title="建立您的第一份問卷"
                  aria-label="建立您的第一份問卷"
                  className="px-14 py-6 rounded-[2rem] shadow-xl shadow-slate-200"
                >
                  立即建立第一份問卷
                </Button>
              </div>
            ) : filteredSurveys.length === 0 ? (
              <div className="text-center py-32 glass rounded-[4rem] border-2 border-slate-100 flex flex-col items-center">
                <i className="ph ph-magnifying-glass-bold text-6xl text-slate-200 mb-6"></i>
                <h3 className="text-2xl font-black text-slate-900 mb-2">找不到相關問卷</h3>
                <p className="text-slate-400 font-medium">請嘗試更換搜尋關鍵字</p>
              </div>
            ) : (
              <div className="grid gap-6 grid-cols-1 md:grid-cols-2 xl:grid-cols-3">
                {filteredSurveys.map(s => (
                  <div key={s.id} className="card group flex flex-col p-0 overflow-hidden hover:border-primary/30 transition-all duration-500">
                    {/* Card Header with Status and Actions */}
                    <div className="p-6 pb-0 flex justify-between items-start">
                      <div className={`inline-flex items-center gap-2 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest border ${
                        s.active 
                          ? 'bg-emerald-50 text-emerald-600 border-emerald-100' 
                          : 'bg-rose-50 text-rose-600 border-rose-100'
                      }`}>
                        <span className={`w-1.5 h-1.5 rounded-full ${s.active ? 'bg-emerald-500 animate-pulse' : 'bg-rose-500'}`}></span>
                        {s.active ? '進行中' : '已關閉'}
                      </div>
                      
                      <div className="flex gap-2">
                        <button
                          onClick={(e) => { e.stopPropagation(); window.location.hash = `#/preview/${s.id}`; }}
                          className="w-8 h-8 flex items-center justify-center rounded-lg bg-slate-50 text-slate-400 hover:text-primary hover:bg-primary-soft transition-all"
                          title="預覽問卷"
                          aria-label="預覽問卷"
                        >
                          <i className="ph ph-eye-bold text-lg"></i>
                        </button>
                        <button
                          onClick={(e) => { e.stopPropagation(); shareSurvey(s); }}
                          className="w-8 h-8 flex items-center justify-center rounded-lg bg-slate-50 text-slate-400 hover:text-emerald-500 hover:bg-emerald-50 transition-all"
                          title="分享連結"
                          aria-label="分享連結"
                        >
                          <i className="ph ph-share-network-bold text-lg"></i>
                        </button>
                      </div>
                    </div>

                    {/* Card Body */}
                    <div className="p-6 flex-1">
                      <h3 className="text-xl font-bold text-slate-900 mb-2 line-clamp-1 group-hover:text-primary transition-colors">
                        {s.title}
                      </h3>
                      <p className="text-slate-500 text-sm line-clamp-2 h-10 mb-6 font-medium">
                        {s.description || "尚未設定問卷描述..."}
                      </p>
                      
                      <div className="grid grid-cols-2 gap-4">
                        <div className="bg-slate-50 p-3 rounded-xl border border-slate-100">
                          <div className="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-0.5">問題數量</div>
                          <div className="text-lg font-bold text-slate-900">{(s.questions || []).length} <span className="text-xs text-slate-400">題</span></div>
                        </div>
                        <div className="bg-slate-50 p-3 rounded-xl border border-slate-100">
                          <div className="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-0.5">建立日期</div>
                          <div className="text-sm font-bold text-slate-900">{new Date(s.createdAt).toLocaleDateString()}</div>
                        </div>
                      </div>
                    </div>

                    {/* Card Footer Actions */}
                    <div className="p-6 pt-0 mt-auto flex gap-3">
                      <button
                        onClick={() => onAnalytics(s.id)}
                        title="查看數據分析結果"
                        aria-label="查看數據分析結果"
                        className="flex-[2] btn-base btn-primary py-3 rounded-xl text-sm"
                      >
                        <i className="ph ph-chart-pie-slice-bold text-lg"></i>
                        數據分析
                      </button>
                      <button
                        onClick={() => onEdit(s)}
                        title="編輯問卷內容與設定"
                        aria-label="編輯問卷內容與設定"
                        className="flex-1 btn-base btn-secondary py-3 rounded-xl text-sm"
                      >
                        <i className="ph ph-pencil-simple-line-bold text-lg"></i>
                        編輯
                      </button>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            onDelete(s.id);
                          }}
                          title="刪除這份問卷"
                          aria-label="刪除這份問卷"
                          className="w-12 btn-base bg-rose-50 text-rose-500 border-rose-100 hover:bg-rose-500 hover:text-white rounded-xl transition-all"
                        >
                          <i className="ph ph-trash-bold text-lg"></i>
                        </button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      );
    };

    const CreateSurvey = ({ user, onBack }) => {
      const [title, setTitle] = useState("");
      const [desc, setDesc] = useState("");
      const [questions, setQuestions] = useState([{ id: String(safeNow()), type: "text", title: "", options: [] }]);
      const [saving, setSaving] = useState(false);
      const [toast, setToast] = useState(null);
      const [expireAt, setExpireAt] = useState(""); // ISO string
      const [limitCount, setLimitCount] = useState(""); // Number
      const [showAdvanced, setShowAdvanced] = useState(false);
      const [shareToken, setShareToken] = useState(String(Math.random().toString(36).substring(2, 11)));
      const [sharePublic, setSharePublic] = useState(false);
      const [anonymous, setAnonymous] = useState(false);
      
      {/* Smart Template Logic Removed */}

      const addQuestion = () => setQuestions(prev => [...prev, { id: String(safeNow() + Math.random()), type: "text", title: "", options: [] }]);
      const removeQuestion = (id) => setQuestions(prev => (prev.length <= 1 ? prev : prev.filter(q => q.id !== id)));
      const updateQuestion = (id, patch) => setQuestions(prev => prev.map(q => (q.id === id ? { ...q, ...patch } : q)));
      const addOption = (id) => setQuestions(prev => prev.map(q => q.id === id ? { ...q, options: [...(q.options || []), ""] } : q));
      const updateOption = (id, idx, value) => setQuestions(prev => prev.map(q => {
        if (q.id !== id) return q;
        const next = [...(q.options || [])];
        next[idx] = value;
        return { ...q, options: next };
      }));
      const removeOption = (id, idx) => setQuestions(prev => prev.map(q => {
        if (q.id !== id) return q;
        const next = [...(q.options || [])];
        next.splice(idx, 1);
        return { ...q, options: next };
      }));

      const submit = async () => {
        if (!title.trim()) return setToast({ message: "請輸入問卷標題", type: "error" });
        if (questions.some(q => !q.title.trim())) return setToast({ message: "請填寫所有問題內容", type: "error" });
        if (questions.some(q => q.type === "choice" && (!q.options || q.options.length < 2 || q.options.some(o => !String(o || "").trim())))) {
          return setToast({ message: "選擇題至少需要 2 個非空白選項", type: "error" });
        }
        setSaving(true);
        try {
          await db.collection("surveys").add({
            creatorId: user.uid,
            title: title.trim(),
            description: desc || "",
            questions: questions.map(q => ({
              id: q.id,
              type: q.type,
              title: q.title.trim(),
              options: q.type === "choice" ? (q.options || []).map(o => String(o || "").trim()) : [],
            })),
            createdAt: safeNow(),
            expireAt: expireAt ? new Date(expireAt).getTime() : null,
            limitCount: limitCount ? parseInt(limitCount) : null,
            shareToken: sharePublic ? shareToken : null,
            anonymous: anonymous,
            active: true,
          });
          setToast({ message: "問卷建立成功！", type: "success" });
          setTimeout(() => onBack(), 1500);
        } catch (err) {
          setToast({ message: "建立失敗：" + (err && err.message ? err.message : String(err)), type: "error" });
        } finally {
          setSaving(false);
        }
      };

      return (
        <div className="max-w-4xl mx-auto p-6 sm:p-12 fade-in pb-40 relative z-10">
          {/* Create Survey Background Micro-interactions */}
          <div className="floating-bg">
            <div className="blob" style={{ top: '20%', left: '70%', animationDelay: '-3s', background: 'linear-gradient(135deg, rgba(79, 70, 229, 0.04) 0%, rgba(129, 140, 248, 0.04) 100%)' }}></div>
            <div className="blob" style={{ top: '70%', left: '10%', animationDelay: '-9s', width: '400px', height: '400px', background: 'linear-gradient(135deg, rgba(165, 180, 252, 0.03) 0%, rgba(199, 210, 254, 0.03) 100%)' }}></div>
          </div>
          {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
          <div className="flex items-center justify-between mb-12">
            <button 
              onClick={onBack} 
              title="返回儀表板"
              aria-label="返回儀表板"
              className="group flex items-center gap-3 text-slate-400 hover:text-indigo-600 transition-all font-black uppercase tracking-widest text-xs"
            >
              <div className="w-10 h-10 rounded-xl bg-white border border-slate-100 flex items-center justify-center group-hover:border-indigo-600 group-hover:bg-indigo-50 transition-all">
                <i className="ph ph-arrow-left text-lg"></i>
              </div>
              Back to Dashboard
            </button>
            {/* AI Template UI Removed */}
          </div>

          <div className="glass p-10 md:p-16 rounded-[3.5rem] shadow-2xl shadow-indigo-100/20 mb-12 border-4 border-white relative overflow-hidden group">
            <div className="absolute top-0 right-0 w-64 h-64 bg-indigo-50/50 rounded-full -mr-32 -mt-32 group-hover:scale-110 transition-transform duration-1000"></div>
            
            <div className="relative">
              <div className="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-indigo-600 text-white text-[10px] font-black uppercase tracking-[0.2em] mb-8">
                <i className="ph ph-pencil-line-fill"></i> Survey Identity
              </div>
              <input
                className="w-full text-5xl font-black border-none focus:ring-0 placeholder-slate-200 mb-6 bg-transparent tracking-tight leading-tight"
                placeholder="在此輸入令人印象深刻的標題"
                value={title}
                onChange={e => setTitle(e.target.value)}
              />
              <textarea
                className="w-full text-slate-500 border-none focus:ring-0 resize-none placeholder-slate-200 bg-transparent text-xl font-medium leading-relaxed"
                placeholder="為您的問卷添加一段優雅的描述，讓填答者更了解您的目的..."
                rows="2"
                value={desc}
                onChange={e => setDesc(e.target.value)}
              />
            </div>
          </div>

          {/* Advanced Settings - Ephemeral Mode */}
          <div className="mb-12">
            <button 
              onClick={() => setShowAdvanced(!showAdvanced)}
              title={showAdvanced ? "隱藏進階設定選項" : "顯示進階設定選項"}
              aria-label={showAdvanced ? "隱藏進階設定選項" : "顯示進階設定選項"}
              className="flex items-center gap-3 text-slate-400 hover:text-indigo-600 transition-all font-black uppercase tracking-widest text-[10px] mb-4"
            >
              <i className={`ph ph-caret-${showAdvanced ? 'down' : 'right'}-bold text-sm`}></i>
              {showAdvanced ? '隱藏進階設定' : '顯示進階設定 (限時/限量焚毀模式)'}
            </button>
            
            {showAdvanced && (
              <div className="glass p-8 rounded-[2.5rem] border-2 border-dashed border-slate-100 flex flex-wrap gap-8 items-end fade-in">
                <div className="flex-1 min-w-[200px] space-y-3">
                  <label className="flex items-center gap-2 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                    <i className="ph ph-clock-countdown-fill text-indigo-500 text-lg"></i>
                    自動過期時間 (Optional)
                  </label>
                  <input 
                    type="datetime-local" 
                    className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-6 py-4 text-sm font-bold focus:ring-4 focus:ring-indigo-500/5 focus:border-indigo-600 transition-all"
                    value={expireAt}
                    onChange={e => setExpireAt(e.target.value)}
                  />
                </div>
                <div className="flex-1 min-w-[200px] space-y-3">
                  <label className="flex items-center gap-2 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                    <i className="ph ph-users-four-fill text-emerald-500 text-lg"></i>
                    填答人數上限 (Optional)
                  </label>
                  <input 
                    type="number" 
                    placeholder="例如: 100"
                    className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-6 py-4 text-sm font-bold focus:ring-4 focus:ring-indigo-500/5 focus:border-indigo-600 transition-all"
                    value={limitCount}
                    onChange={e => setLimitCount(e.target.value)}
                  />
                </div>
                <div className="flex-1 min-w-[250px] p-4 bg-indigo-50/50 rounded-2xl border border-indigo-100/50">
                  <p className="text-[10px] leading-relaxed text-indigo-600 font-bold">
                    💡 <b>焚毀模式：</b>設定後，問卷將在到達時間或人數上限時自動關閉，確保數據的時效性與稀缺性。
                  </p>
                </div>
              </div>
            )}
            
            {showAdvanced && (
              <div className="glass p-8 rounded-[2.5rem] border-2 border-dashed border-slate-100 flex flex-wrap gap-8 items-center fade-in mt-6 bg-indigo-50/10">
                <div className="flex items-center gap-4 flex-1 min-w-[300px]">
                  <button 
                    onClick={() => setAnonymous(!anonymous)}
                    title={anonymous ? "關閉匿名模式" : "開啟匿名模式"}
                    aria-label={anonymous ? "關閉匿名模式" : "開啟匿名模式"}
                    className={`w-14 h-8 rounded-full transition-all cursor-pointer relative ${anonymous ? 'bg-indigo-600' : 'bg-slate-200'}`}
                  >
                    <div className={`absolute top-1 w-6 h-6 bg-white rounded-full transition-all ${anonymous ? 'left-7' : 'left-1'}`}></div>
                  </button>
                  <div>
                    <h4 className="text-sm font-black text-slate-700 uppercase tracking-widest flex items-center gap-2">
                      <i className="ph ph-user-circle-gear-fill text-indigo-600"></i>
                      匿名填寫模式 (Anonymous Mode)
                    </h4>
                    <p className="text-[10px] text-slate-400 font-bold">開啟後，填答者無需輸入姓名與 Email 即可提交，保障隱私。</p>
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* Public Insight Share Settings */}
          <div className="mb-12">
            <button 
              onClick={() => setShowAdvanced(!showAdvanced)}
              className="hidden" // Just a dummy to reuse showAdvanced or create a new one
            ></button>
            
            {showAdvanced && (
              <div className="glass p-8 rounded-[2.5rem] border-2 border-dashed border-slate-100 flex flex-wrap gap-8 items-center fade-in mt-4 bg-emerald-50/10">
                <div className="flex items-center gap-4 flex-1 min-w-[300px]">
                  <button 
                    onClick={() => setSharePublic(!sharePublic)}
                    title={sharePublic ? "關閉公開分析連結" : "開啟公開分析連結"}
                    aria-label={sharePublic ? "關閉公開分析連結" : "開啟公開分析連結"}
                    className={`w-14 h-8 rounded-full transition-all cursor-pointer relative ${sharePublic ? 'bg-emerald-500' : 'bg-slate-200'}`}
                  >
                    <div className={`absolute top-1 w-6 h-6 bg-white rounded-full transition-all ${sharePublic ? 'left-7' : 'left-1'}`}></div>
                  </button>
                  <div>
                    <h4 className="text-sm font-black text-slate-700 uppercase tracking-widest flex items-center gap-2">
                      <i className="ph ph-share-network-fill text-emerald-500"></i>
                      公開分析連結 (Insight Share)
                    </h4>
                    <p className="text-[10px] text-slate-400 font-bold">開啟後，任何人持有連結皆可查看去識別化的分析數據。</p>
                  </div>
                </div>
                {sharePublic && (
                  <div className="flex-1 min-w-[300px] flex items-center gap-3 bg-white p-3 rounded-2xl border-2 border-emerald-100">
                    <code className="flex-1 text-[10px] font-mono text-emerald-700 truncate">
                      .../analytics/public/{shareToken}
                    </code>
                    <div className="px-3 py-1 bg-emerald-50 text-emerald-600 text-[10px] font-black rounded-lg">
                      AUTO-TOKEN
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>

          <div className="space-y-10">
            {questions.map((q, idx) => (
              <div key={q.id} className="group card-modern p-10 relative hover:border-indigo-200 transition-all bg-white/70 backdrop-blur-md">
                <div className="absolute -left-1 top-10 w-2 h-16 bg-indigo-600 rounded-r-full opacity-0 group-hover:opacity-100 transition-all duration-500"></div>
                
                <div className="flex items-center justify-between mb-10">
                  <div className="flex items-center gap-6">
                    <div className="w-14 h-14 bg-slate-900 text-white rounded-[1.25rem] flex items-center justify-center font-black text-xl shadow-xl shadow-slate-200 group-hover:bg-indigo-600 transition-colors">
                      {idx + 1}
                    </div>
                    <div className="relative">
                      <select
                        className="appearance-none bg-slate-50 border-2 border-slate-100 rounded-2xl px-6 py-3 pr-12 text-sm font-black text-slate-600 focus:ring-4 focus:ring-indigo-500/5 focus:border-indigo-600 focus:bg-white cursor-pointer transition-all"
                        value={q.type}
                        onChange={e => updateQuestion(q.id, { type: e.target.value, options: e.target.value === "choice" ? (q.options || ["", ""]) : [] })}
                      >
                        <option value="text">💬 簡答題 (Text)</option>
                        <option value="choice">🔘 單選題 (Choice)</option>
                        <option value="rating">⭐ 評分題 (Rating 1-10)</option>
                        <option value="file">📁 檔案上傳 (File Upload)</option>
                      </select>
                      <i className="ph ph-caret-down-bold absolute right-5 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                    </div>
                  </div>
                  {questions.length > 1 && (
                    <button 
                      onClick={() => removeQuestion(q.id)} 
                      title="刪除此題目"
                      aria-label="刪除此題目"
                      className="w-12 h-12 flex items-center justify-center bg-rose-50 text-rose-500 hover:bg-rose-500 hover:text-white rounded-2xl transition-all shadow-sm hover:shadow-rose-100"
                    >
                      <i className="ph ph-trash-bold text-xl"></i>
                    </button>
                  )}
                </div>

                <div className="space-y-8">
                  <div className="space-y-2">
                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] ml-1">Question Content</label>
                    <input
                      className="w-full text-2xl font-bold border-none border-b-4 border-slate-50 focus:border-indigo-600 focus:ring-0 pb-4 placeholder-slate-100 transition-all bg-transparent"
                      placeholder="您的問題內容是？"
                      value={q.title}
                      onChange={e => updateQuestion(q.id, { title: e.target.value })}
                    />
                  </div>

                  {q.type === "choice" && (
                    <div className="space-y-4 pl-4 border-l-4 border-slate-50">
                      <label className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] ml-1 mb-2 block">Options</label>
                      {(q.options || []).map((opt, oIdx) => (
                        <div key={oIdx} className="flex items-center gap-4 group/opt">
                          <div className="w-8 h-8 rounded-full border-2 border-slate-200 flex-shrink-0 flex items-center justify-center group-hover/opt:border-indigo-600 transition-all bg-white">
                            <div className="w-2.5 h-2.5 rounded-full bg-indigo-600 opacity-0 group-hover/opt:opacity-100 transition-opacity"></div>
                          </div>
                          <input
                            className="flex-1 bg-slate-50/50 border-2 border-slate-50 rounded-2xl px-6 py-4 text-sm font-bold focus:ring-4 focus:ring-indigo-500/5 focus:border-indigo-600 focus:bg-white transition-all"
                            value={opt}
                            onChange={e => updateOption(q.id, oIdx, e.target.value)}
                            placeholder={`選項 ${oIdx + 1}`}
                          />
                          <button 
                            onClick={() => removeOption(q.id, oIdx)} 
                            title="刪除此選項"
                            aria-label="刪除此選項"
                            className="w-12 h-12 flex items-center justify-center text-slate-200 hover:text-rose-500 opacity-0 group-hover/opt:opacity-100 transition-all"
                          >
                            <i className="ph ph-minus-circle-bold text-2xl"></i>
                          </button>
                        </div>
                      ))}
                      <button 
                        onClick={() => addOption(q.id)} 
                        title="新增一個選項"
                        aria-label="新增一個選項"
                        className="flex items-center gap-3 text-indigo-600 text-sm font-black hover:bg-indigo-50 px-6 py-3 rounded-2xl transition-all mt-4 w-fit"
                      >
                        <i className="ph ph-plus-circle-bold text-xl"></i> 新增選項
                      </button>
                    </div>
                  )}

                  {q.type === "rating" && (
                    <div className="space-y-4 pl-4 border-l-4 border-slate-50">
                      <div className="p-6 bg-indigo-50/50 rounded-2xl border-2 border-indigo-100/50">
                        <div className="flex items-center gap-3 text-indigo-600 font-black mb-2">
                          <i className="ph ph-info-fill text-xl"></i>
                          <span>評分題預覽 (Rating Scale)</span>
                        </div>
                        <p className="text-xs text-slate-500 font-bold leading-relaxed mb-6">
                          使用者將會看到 1 到 10 的評分圓圈，可以用於滿意度調查、符合程度評估等場景。
                        </p>
                        <div className="grid grid-cols-5 md:grid-cols-10 gap-2">
                          {[...Array(10)].map((_, i) => (
                            <div key={i} className="aspect-square w-full rounded-full border-2 border-indigo-200 flex items-center justify-center text-[10px] font-black text-indigo-300 bg-white">
                              {i + 1}
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                  )}

                  {q.type === "file" && (
                    <div className="space-y-4 pl-4 border-l-4 border-slate-50">
                      <div className="p-8 bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200 flex flex-col items-center justify-center gap-4 group/file">
                        <div className="w-16 h-16 bg-white rounded-2xl flex items-center justify-center shadow-sm group-hover/file:scale-110 transition-transform duration-500">
                          <i className="ph ph-cloud-arrow-up-fill text-3xl text-slate-300 group-hover/file:text-indigo-500 transition-colors"></i>
                        </div>
                        <div className="text-center">
                          <div className="text-sm font-black text-slate-600 mb-1">檔案上傳區域預覽</div>
                          <div className="text-[10px] text-slate-400 font-bold">填答者將可以點擊或拖放檔案進行上傳</div>
                        </div>
                        <div className="px-4 py-1.5 bg-white rounded-xl text-[9px] font-black text-slate-400 border border-slate-100 uppercase tracking-widest">
                          Support: Images, PDF, Docs (Max 5MB)
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            ))}
          </div>

          <div className="fixed bottom-12 left-1/2 -translate-x-1/2 w-[calc(100%-3rem)] max-w-4xl flex justify-between items-center glass p-6 rounded-[3rem] shadow-[0_30px_60px_-15px_rgba(79,70,229,0.4)] border-4 border-white z-50">
            <button 
              onClick={addQuestion} 
              title="新增一個新問題"
              aria-label="新增一個新問題"
              className="group flex items-center gap-4 px-10 py-5 bg-slate-900 text-white rounded-[2rem] font-black text-lg hover:bg-indigo-600 transition-all active:scale-95 shadow-2xl shadow-slate-200"
            >
              <i className="ph ph-plus-circle-fill text-2xl group-hover:rotate-90 transition-transform"></i> 新增問題
            </button>
            <Button 
              onClick={submit} 
              disabled={saving} 
              title="發布並儲存問卷"
              aria-label="發布並儲存問卷"
              className="px-14 py-5 text-xl rounded-[2rem] shadow-2xl shadow-indigo-300/50 hover:-translate-y-1"
            >
              {saving ? (
                <span className="spinner w-7 h-7 border-4 border-white/20 border-l-white"></span>
              ) : (
                <>發布問卷 <i className="ph ph-paper-plane-right-fill text-2xl ml-2"></i></>
              )}
            </Button>
          </div>
        </div>
      );
    };

    const TakeSurvey = ({ surveyId, isPreview = false }) => {
      const [survey, setSurvey] = useState(null);
      const [closedReason, setClosedReason] = useState(null); // 'expired' | 'limited' | 'inactive'
      const [step, setStep] = useState(-1); // -1 intro, 0..n-1 questions, n success
      const [respondent, setRespondent] = useState(isPreview ? { name: "模擬用戶", email: "preview@gmail.com" } : { name: "", email: "" });
      const [answers, setAnswers] = useState({});
      const [localFiles, setLocalFiles] = useState({}); // New: stores File objects before upload
      const [timings, setTimings] = useState({});
      const [loading, setLoading] = useState(true);
      const [submitting, setSubmitting] = useState(false);
      const [toast, setToast] = useState(null);
      const [focusMode, setFocusMode] = useState(true); // Default to Focus Mode
      const startAtRef = useRef(null);

      useEffect(() => {
        let cancelled = false;
        const params = new URLSearchParams(window.location.search);
        const urlTitle = params.get("t");
        if (urlTitle) {
          document.title = `SurveyLight｜${urlTitle}`;
        }

        const fetchSurvey = async () => {
          setLoading(true);
          try {
            const doc = await db.collection("surveys").doc(surveyId).get();
            if (!doc.exists) throw new Error("問卷不存在或已被刪除");
            const data = { id: doc.id, ...doc.data() };
            document.title = isPreview ? `模擬預覽｜${data.title}` : `SurveyLight｜${data.title || "填寫問卷"}`;

            // Check Status only if not in preview mode
            if (!isPreview) {
              // Check Active
              if (!data.active) {
                setClosedReason('inactive');
                if (!cancelled) setSurvey(data);
                return;
              }

              // Check Expire
              if (data.expireAt && safeNow() > data.expireAt) {
                setClosedReason('expired');
                if (!cancelled) setSurvey(data);
                return;
              }

              // Check Limit
              if (data.limitCount) {
                const resSnap = await db.collection("responses").where("surveyId", "==", surveyId).get();
                if (resSnap.size >= data.limitCount) {
                  setClosedReason('limited');
                  if (!cancelled) setSurvey(data);
                  return;
                }
              }
            }

            if (!cancelled) setSurvey(data);
          } catch (err) {
            setToast({ message: (err && err.message) ? err.message : "載入問卷失敗", type: "error" });
          } finally {
            if (!cancelled) setLoading(false);
          }
        };
        fetchSurvey();
        return () => { cancelled = true; };
      }, [surveyId]);

      useEffect(() => {
        if (step >= 0 && survey && step < (survey.questions || []).length) {
          startAtRef.current = safeNow();
        }
      }, [step, survey]);

      const recordTimingForStep = () => {
        if (!survey) return;
        if (step < 0 || step >= (survey?.questions?.length || 0)) return;
        const qId = survey?.questions?.[step]?.id;
        if (!qId) return;
        const elapsed = Math.max(0, (safeNow() - (startAtRef.current || safeNow())) / 1000);
        setTimings(prev => ({ ...prev, [qId]: (prev[qId] || 0) + elapsed }));
      };

      const nextFromIntro = () => {
        if (survey?.anonymous) {
          setRespondent({ name: "匿名填答者", email: "anonymous@surveylight.io" });
          setStep(0);
          return;
        }
        if (!respondent.name.trim() || !respondent.email.trim()) return setToast({ message: "請輸入姓名與 Email", type: "error" });
        const email = respondent.email.trim().toLowerCase();
        const basicOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        const isGmail = email.endsWith("@gmail.com") || email.endsWith("@googlemail.com");
        if (!basicOk) return setToast({ message: "Email 格式不正確，請重新輸入。", type: "error" });
        if (!isGmail) return setToast({ message: "為確保填答者身份，本問卷僅接受 Gmail（@gmail.com）信箱填寫。", type: "error" });
        setStep(0);
      };

      const nextQuestion = () => {
        const q = survey?.questions?.[step];
        if (!q) return;
        const val = answers[q.id];
        const file = localFiles[q.id];
        if (!val && !file) {
          const el = document.getElementById(`q-${q.id}`);
          if (el) {
            el.classList.add('shake');
            setTimeout(() => el.classList.remove('shake'), 500);
          }
          return setToast({ message: "此題為必填，請提供您的回答再繼續 ✨", type: "error" });
        }
        
        // Calculate and update timing
        const elapsed = Math.max(0, (safeNow() - (startAtRef.current || safeNow())) / 1000);
        setTimings(prev => ({ ...prev, [q.id]: (prev[q.id] || 0) + elapsed }));
        
        setStep(prev => prev + 1);
      };

      const submit = async () => {
        const q = survey?.questions?.[step];
        if (!q) return;
        const val = answers[q.id];
        const file = localFiles[q.id];
        if (!val && !file) return setToast({ message: "最後一題也別忘了填寫喔！✨", type: "error" });
        
        // Finalize timings including the last question
        const elapsed = Math.max(0, (safeNow() - (startAtRef.current || safeNow())) / 1000);
        const finalTimings = { ...timings, [q.id]: (timings[q.id] || 0) + elapsed };

        setSubmitting(true);
        try {
          // Detect Geolocation
          let geo = { city: '未知', region: '未知', country: '未知' };
          try {
            const geoRes = await fetch('https://ipapi.co/json/');
            const geoData = await geoRes.json();
            if (geoData && !geoData.error) {
              geo = {
                city: geoData.city || '未知',
                region: geoData.region || '未知',
                country: geoData.country_name || '未知',
                latitude: geoData.latitude,
                longitude: geoData.longitude
              };
            }
          } catch (e) {
            console.error("Geo detection failed:", e);
          }

          // Upload files if any
          const finalAnswers = { ...answers };
          for (const qId of Object.keys(localFiles)) {
            const f = localFiles[qId];
            if (f) {
              try {
                // 執行自動優化與壓縮
                const optimizedFile = await optimizeFile(f);
                
                const storageRef = firebase.storage().ref();
                const fileName = `${safeNow()}_${optimizedFile.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                const fileRef = storageRef.child(`uploads/${survey.id}/${fileName}`);
                
                console.log("UPLOADING FILE:", optimizedFile.name, "to", fileRef.fullPath);
                
                // Use blob for more reliable upload
                const blob = new Blob([optimizedFile], { type: optimizedFile.type });
                await fileRef.put(blob);
                const downloadURL = await fileRef.getDownloadURL();
                finalAnswers[qId] = downloadURL;
                console.log("UPLOAD SUCCESS:", downloadURL);
              } catch (uploadErr) {
                console.error("FILE UPLOAD ERROR:", uploadErr);
                throw new Error(`檔案「${f.name}」上傳失敗：${uploadErr.message || '請檢查網路或 Storage 權限'}`);
              }
            }
          }

          if (isPreview) {
            console.log("PREVIEW MODE: Submission simulated", { respondent, finalAnswers });
            // Simulate a delay
            await new Promise(r => setTimeout(r, 1000));
          } else {
            await db.collection("responses").add({
              surveyId: survey.id,
              surveyCreatorId: survey.creatorId || null,
              respondent: { name: respondent.name.trim(), email: respondent.email.trim() },
              answers: finalAnswers,
              timings: finalTimings,
              geo: geo,
              submittedAt: safeNow(),
            });
          }
          
          // 噴發慶祝紙屑
          if (window.confetti) {
            const duration = 3 * 1000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

            const randomInRange = (min, max) => Math.random() * (max - min) + min;

            const interval = setInterval(function() {
              const timeLeft = animationEnd - Date.now();
              if (timeLeft <= 0) return clearInterval(interval);
              const particleCount = 50 * (timeLeft / duration);
              window.confetti(Object.assign({}, defaults, { 
                particleCount, 
                origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } 
              }));
              window.confetti(Object.assign({}, defaults, { 
                particleCount, 
                origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } 
              }));
            }, 250);
          }

          setStep(survey?.questions?.length || 0); // success
        } catch (err) {
          setToast({ message: "提交失敗：" + (err && err.message ? err.message : String(err)), type: "error" });
        } finally {
          setSubmitting(false);
        }
      };

      if (loading) return <Loading text="載入問卷中..." />;
      if (!survey) return (
        <div className="min-h-screen flex items-center justify-center p-6 text-slate-400 font-medium">
          {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
          找不到問卷
        </div>
      );

      // Survey Closed State
      if (closedReason) {
        const reasonConfig = {
          expired: { icon: "ph-clock-countdown-fill", color: "text-indigo-600", bg: "bg-indigo-50", title: "問卷已過期", desc: "本問卷已達到預設的截止時間，目前不開放填寫。" },
          limited: { icon: "ph-users-four-fill", color: "text-emerald-600", bg: "bg-emerald-50", title: "填答人數已滿", desc: "感謝熱烈參與！本問卷已達到填答人數上限。" },
          inactive: { icon: "ph-lock-fill", color: "text-slate-600", bg: "bg-slate-50", title: "問卷已關閉", desc: "發布者已手動關閉此問卷。" }
        }[closedReason] || { icon: "ph-prohibit-fill", color: "text-rose-600", bg: "bg-rose-50", title: "無法填寫", desc: "此問卷目前不開放填答。" };

        return (
          <div className="min-h-screen flex items-center justify-center p-6 bg-slate-50/50">
            <div className="text-center glass p-16 md:p-24 rounded-[4rem] shadow-2xl shadow-slate-100 max-w-2xl w-full border-4 border-white fade-in relative overflow-hidden">
              <div className={`w-32 h-32 ${reasonConfig.bg} ${reasonConfig.color} rounded-[2.5rem] flex items-center justify-center mx-auto mb-10 shadow-xl border border-white`}>
                <i className={`ph ${reasonConfig.icon} text-6xl`}></i>
              </div>
              <h2 className="text-5xl font-black text-slate-900 mb-6 tracking-tight leading-tight">{reasonConfig.title}</h2>
              <p className="text-slate-500 text-xl font-medium leading-relaxed max-w-md mx-auto">
                {reasonConfig.desc}
              </p>
              <div className="mt-16 pt-10 border-t border-slate-100 flex items-center justify-center gap-3 text-slate-400 font-black uppercase tracking-[0.2em] text-xs">
                <i className="ph ph-shield-check-fill text-slate-300"></i>
                SurveyLight Secure Access
              </div>
            </div>
          </div>
        );
      }

      if (step >= (survey.questions || []).length && step !== -1) {
        return (
          <div className="min-h-screen flex items-center justify-center p-6 bg-slate-950 relative overflow-hidden">
            {/* Preview Banner */}
            {isPreview && (
              <div className="fixed top-0 left-0 w-full z-[100] bg-amber-500 text-white px-6 py-3 flex items-center justify-between shadow-lg">
                <div className="flex items-center gap-4">
                  <div className="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                    <i className="ph ph-eye-fill text-2xl"></i>
                  </div>
                  <div>
                    <div className="font-black text-sm uppercase tracking-widest">模擬預覽模式</div>
                    <div className="text-[10px] opacity-80 font-bold">目前為模擬填答，不會記錄任何真實數據或檔案。</div>
                  </div>
                </div>
                <button 
                  onClick={() => window.location.hash = "#/dashboard"}
                  className="px-5 py-2 bg-white text-amber-600 rounded-xl font-black text-xs hover:bg-amber-50 transition-colors"
                >
                  結束預覽
                </button>
              </div>
            )}
            {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
            
            {/* Success Background Effects */}
            <div className="absolute inset-0 pointer-events-none">
              <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full h-full bg-[radial-gradient(circle_at_center,_rgba(99,102,241,0.15)_0%,_transparent_70%)] animate-pulse"></div>
              <div className="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-indigo-500/10 rounded-full blur-[120px] animate-blob"></div>
              <div className="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-emerald-500/10 rounded-full blur-[120px] animate-blob" style={{ animationDelay: '2s' }}></div>
              <div className="war-room-scanline opacity-30"></div>
              <div className="absolute inset-0 war-room-grid opacity-10"></div>
            </div>

            <div className="text-center p-16 md:p-24 rounded-[5rem] bg-white/5 backdrop-blur-3xl border border-white/10 shadow-[0_0_100px_rgba(99,102,241,0.2)] max-w-2xl w-full fade-in relative overflow-hidden group">
              <div className="absolute inset-0 bg-gradient-to-br from-indigo-500/5 to-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-1000"></div>
              
              <div className="relative mb-12">
                <div className="w-40 h-40 bg-gradient-to-tr from-indigo-600 to-indigo-400 text-white rounded-[3.5rem] flex items-center justify-center mx-auto shadow-[0_20px_50px_rgba(79,70,229,0.4)] rotate-6 animate-bounce-subtle relative z-10">
                  <i className="ph ph-check-circle-fill text-8xl"></i>
                </div>
                <div className="absolute inset-0 bg-indigo-500/20 blur-3xl rounded-full scale-150 animate-pulse"></div>
                
                {/* Orbital Rings */}
                <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 border border-indigo-500/20 rounded-full animate-ping opacity-20"></div>
                <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-48 h-48 border border-white/5 rounded-full animate-spin-slow opacity-30"></div>
              </div>

              <div className="relative z-10 space-y-6">
                <div className="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-indigo-500/20 text-indigo-400 text-[10px] font-black uppercase tracking-[0.2em] mb-4 border border-indigo-500/30">
                  <i className="ph ph-sparkle-fill animate-pulse"></i>
                  Transmission Successful
                </div>
                
                <h2 className="text-6xl font-black text-white mb-6 tracking-tighter leading-none glitch-text" data-text="MISSION COMPLETE">
                  MISSION COMPLETE
                </h2>
                <p className="text-slate-400 text-xl font-medium leading-relaxed max-w-md mx-auto">
                  數據已成功穿越時空，抵達我們的戰略指揮中心。感謝您的卓越貢獻！
                </p>
                
                <div className="pt-12 flex flex-col items-center gap-8">
                  <div className="flex items-center gap-4 px-6 py-3 rounded-2xl bg-white/5 border border-white/10">
                    <div className="w-2 h-2 rounded-full bg-emerald-500 animate-ping"></div>
                    <span className="text-[11px] font-black text-emerald-400 uppercase tracking-[0.3em] war-room-text-glow">Data Sync: 100%</span>
                  </div>
                  
                  <button 
                    onClick={() => window.location.reload()}
                    title="重新開始填寫問卷"
                    aria-label="重新開始填寫問卷"
                    className="group relative px-12 py-6 bg-white text-slate-900 rounded-[2.5rem] font-black text-lg transition-all hover:scale-105 active:scale-95 shadow-2xl hover:shadow-white/10 overflow-hidden"
                  >
                    <span className="relative z-10">再填一份問卷</span>
                    <div className="absolute inset-0 rounded-[2.5rem] bg-gradient-to-r from-indigo-500 to-emerald-500 opacity-0 group-hover:opacity-20 transition-opacity"></div>
                    <div className="absolute -bottom-1 left-0 w-full h-1 bg-indigo-600 group-hover:h-full transition-all duration-500 opacity-10"></div>
                  </button>
                </div>
              </div>

              <div className="mt-20 pt-10 border-t border-white/5 flex items-center justify-center gap-4 text-white/20 font-black uppercase tracking-[0.4em] text-[10px]">
                <div className="w-12 h-px bg-white/5"></div>
                <i className="ph ph-shield-check-fill text-indigo-500/40"></i>
                SurveyLight Secure Network
                <div className="w-12 h-px bg-white/5"></div>
              </div>
            </div>
          </div>
        );
      }

      if (isPreview) {
        return (
          <div className="min-h-screen bg-slate-50 p-6 md:p-12 pb-32">
             <div className="fixed top-0 left-0 w-full z-[100] bg-amber-500 text-white px-6 py-3 flex items-center justify-between shadow-lg">
              <div className="flex items-center gap-4">
                <div className="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                  <i className="ph ph-eye-fill text-2xl"></i>
                </div>
                <div>
                  <div className="font-black text-sm uppercase tracking-widest">模擬預覽模式</div>
                  <div className="text-[10px] opacity-80 font-bold">預覽所有題目與選項 (無法填寫)</div>
                </div>
              </div>
              <button 
                onClick={() => window.location.hash = "#/dashboard"}
                className="px-5 py-2 bg-white text-amber-600 rounded-xl font-black text-xs hover:bg-amber-50 transition-colors"
              >
                結束預覽
              </button>
            </div>
            
            <div className="max-w-3xl mx-auto mt-20 space-y-8">
              <div className="bg-white rounded-[2.5rem] p-10 shadow-xl border-4 border-slate-100">
                <h1 className="text-4xl font-black text-slate-900 mb-4">{survey.title}</h1>
                <p className="text-slate-500 whitespace-pre-wrap text-lg font-medium">{survey.description}</p>
              </div>

              {(survey?.questions || []).map((q, idx) => (
                <div key={q.id} className="bg-white rounded-[2.5rem] p-10 shadow-lg border-2 border-slate-100 relative overflow-hidden group hover:shadow-xl transition-all">
                  <div className="absolute top-0 left-0 w-2 h-full bg-slate-200 group-hover:bg-indigo-500 transition-colors"></div>
                  <div className="flex items-start gap-6">
                    <div className="w-12 h-12 rounded-2xl bg-slate-100 flex items-center justify-center flex-shrink-0 text-slate-400 font-black text-xl group-hover:bg-indigo-50 group-hover:text-indigo-600 transition-colors">
                      {idx + 1}
                    </div>
                    <div className="flex-1">
                      <h3 className="text-2xl font-black text-slate-800 mb-6">{q.title}</h3>
                      
                      {q.type === 'text' && (
                        <div className="w-full h-32 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 flex items-center justify-center text-slate-400 font-bold">
                          [文字輸入區塊]
                        </div>
                      )}

                      {q.type === 'rating' && (
                        <div className="flex gap-2 overflow-x-auto pb-2">
                          {[...Array(10)].map((_, i) => (
                            <div key={i} className="w-10 h-10 rounded-full border-2 border-slate-200 flex items-center justify-center font-bold text-slate-400 text-sm">
                              {i + 1}
                            </div>
                          ))}
                        </div>
                      )}

                      {q.type === 'choice' && (
                        <div className="space-y-3">
                          {q.options.map((opt, i) => (
                            <div key={i} className="flex items-center gap-3 p-4 rounded-xl bg-slate-50 border border-slate-100">
                              <div className="w-5 h-5 rounded-full border-2 border-slate-300"></div>
                              <span className="font-bold text-slate-600">{opt}</span>
                            </div>
                          ))}
                        </div>
                      )}

                      {q.type === 'file' && (
                        <div className="w-full h-32 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 flex items-center justify-center gap-3 text-slate-400 font-bold">
                          <i className="ph ph-upload-simple text-2xl"></i>
                          [檔案上傳區塊]
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        );
      }

      if (step === -1) {
        return (
          <div className="min-h-screen flex items-center justify-center p-6 bg-slate-50 relative overflow-hidden">
            {/* Preview Banner */}
            {isPreview && (
              <div className="fixed top-0 left-0 w-full z-[100] bg-amber-500 text-white px-6 py-3 flex items-center justify-between shadow-lg">
                <div className="flex items-center gap-4">
                  <div className="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                    <i className="ph ph-eye-fill text-2xl"></i>
                  </div>
                  <div>
                    <div className="font-black text-sm uppercase tracking-widest">模擬預覽模式</div>
                    <div className="text-[10px] opacity-80 font-bold">目前為模擬填答，不會記錄任何真實數據或檔案。</div>
                  </div>
                </div>
                <button 
                  onClick={() => window.location.hash = "#/dashboard"}
                  className="px-5 py-2 bg-white text-amber-600 rounded-xl font-black text-xs hover:bg-amber-50 transition-colors"
                >
                  結束預覽
                </button>
              </div>
            )}
            {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
            {/* Background Decorations */}
            <div className="absolute top-0 left-0 w-full h-full pointer-events-none">
              <div className="absolute top-[-10%] right-[-10%] w-[40%] h-[40%] bg-indigo-100/40 rounded-full blur-[100px]"></div>
              <div className="absolute bottom-[-10%] left-[-10%] w-[40%] h-[40%] bg-blue-100/40 rounded-full blur-[100px]"></div>
            </div>

            <div className="glass p-10 md:p-20 rounded-[4rem] shadow-2xl shadow-indigo-100/20 max-w-2xl w-full border-4 border-white fade-in relative">
              <div className="w-20 h-20 bg-slate-900 text-white rounded-3xl flex items-center justify-center mb-10 shadow-xl shadow-slate-200">
                <i className="ph ph-article-fill text-4xl"></i>
              </div>
              <h1 className="text-5xl font-black text-slate-900 mb-6 tracking-tight leading-tight">{survey.title}</h1>
              <p className="text-slate-500 mb-12 whitespace-pre-wrap text-xl font-medium leading-relaxed">{survey.description || "歡迎填寫此問卷，您的意見對我們非常重要。"}</p>

              {/* Urgency/Info Badges for Respondent */}
              {(survey.expireAt || survey.limitCount) && (
                <div className="flex flex-wrap gap-3 mb-12">
                  {survey.expireAt && (
                    <div className="px-4 py-2 rounded-2xl bg-indigo-50 text-indigo-600 border border-indigo-100 flex items-center gap-2 text-sm font-black">
                      <i className="ph ph-clock-countdown-fill"></i>
                      <span>截止時間：{new Date(survey.expireAt).toLocaleString()}</span>
                    </div>
                  )}
                  {survey.limitCount && (
                    <div className="px-4 py-2 rounded-2xl bg-amber-50 text-amber-600 border border-amber-100 flex items-center gap-2 text-sm font-black">
                      <i className="ph ph-users-four-fill"></i>
                      <span>限量填答：{survey.limitCount} 人</span>
                    </div>
                  )}
                </div>
              )}

              {!survey.anonymous ? (
                <div className="space-y-8 mb-12">
                  <div className="space-y-3">
                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-[0.3em] ml-2">Your Name</label>
                    <input
                      className="w-full bg-white border-2 border-slate-100 rounded-[1.75rem] px-8 py-5 focus:ring-4 focus:ring-indigo-500/5 focus:border-indigo-600 outline-none transition-all font-black text-slate-700 text-lg placeholder-slate-200"
                      value={respondent.name}
                      onChange={e => setRespondent({ ...respondent, name: e.target.value })}
                      placeholder="請輸入您的姓名"
                    />
                  </div>
                  <div className="space-y-3">
                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-[0.3em] ml-2">Email (Gmail only)</label>
                    <input
                      type="email"
                      className="w-full bg-white border-2 border-slate-100 rounded-[1.75rem] px-8 py-5 focus:ring-4 focus:ring-indigo-500/5 focus:border-indigo-600 outline-none transition-all font-black text-slate-700 text-lg placeholder-slate-200"
                      value={respondent.email}
                      onChange={e => setRespondent({ ...respondent, email: e.target.value })}
                      placeholder="example@gmail.com"
                    />
                  </div>
                </div>
              ) : (
                <div className="mb-12 p-8 bg-indigo-50/50 rounded-3xl border-2 border-dashed border-indigo-100 text-center">
                  <div className="w-12 h-12 bg-indigo-100 text-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i className="ph ph-user-circle-gear-fill text-2xl"></i>
                  </div>
                  <h4 className="text-sm font-black text-indigo-900 mb-2">此問卷已開啟匿名模式</h4>
                  <p className="text-[10px] text-indigo-400 font-bold">為了保障您的隱私，我們不會收集您的姓名與 Email。</p>
                </div>
              )}

              <Button onClick={nextFromIntro} className="w-full py-6 text-xl rounded-[2rem] shadow-2xl shadow-indigo-200">
                開始填寫 <i className="ph ph-arrow-right-bold text-2xl"></i>
              </Button>
            </div>
          </div>
        );
      }

      const q = survey?.questions?.[step];
      if (!q && step !== (survey?.questions?.length || 0)) return null; 
      
      const qLen = survey?.questions?.length || 1;
      const isLast = step === qLen - 1;
      const progress = Math.round(((step) / qLen) * 100);
      const nextProgress = Math.round(((step + 1) / qLen) * 100);

      return (
        <div className={`min-h-screen flex flex-col items-center justify-center p-6 transition-all duration-1000 relative overflow-hidden ${focusMode ? 'bg-slate-950' : 'bg-slate-50'}`}>
          {/* Preview Banner */}
          {isPreview && (
            <div className="fixed top-0 left-0 w-full z-[100] bg-amber-500 text-white px-6 py-3 flex items-center justify-between shadow-lg">
              <div className="flex items-center gap-4">
                <div className="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                  <i className="ph ph-eye-fill text-2xl"></i>
                </div>
                <div>
                  <div className="font-black text-sm uppercase tracking-widest">模擬預覽模式</div>
                  <div className="text-[10px] opacity-80 font-bold">目前為模擬填答，不會記錄任何真實數據或檔案。</div>
                </div>
              </div>
              <button 
                onClick={() => window.location.hash = "#/dashboard"}
                className="px-5 py-2 bg-white text-amber-600 rounded-xl font-black text-xs hover:bg-amber-50 transition-colors"
              >
                結束預覽
              </button>
            </div>
          )}
          {/* Take Survey Background Micro-interactions */}
          <div className="floating-bg">
            <div className="blob" style={{ top: '15%', left: '75%', animationDelay: '-4s', background: focusMode ? 'linear-gradient(135deg, rgba(79, 70, 229, 0.08) 0%, rgba(129, 140, 248, 0.08) 100%)' : 'linear-gradient(135deg, rgba(79, 70, 229, 0.03) 0%, rgba(129, 140, 248, 0.03) 100%)' }}></div>
            <div className="blob" style={{ top: '75%', left: '15%', animationDelay: '-10s', width: '450px', height: '450px', background: focusMode ? 'linear-gradient(135deg, rgba(99, 102, 241, 0.06) 0%, rgba(165, 180, 252, 0.06) 100%)' : 'linear-gradient(135deg, rgba(165, 180, 252, 0.02) 0%, rgba(199, 210, 254, 0.02) 100%)' }}></div>
          </div>
          {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
          
          {/* Focus Mode Background Effects */}
          {focusMode && (
            <div className="absolute inset-0 pointer-events-none overflow-hidden">
              <div className="absolute top-[-20%] left-[-10%] w-[60%] h-[60%] bg-indigo-900/20 rounded-full blur-[120px] animate-pulse"></div>
              <div className="absolute bottom-[-20%] right-[-10%] w-[60%] h-[60%] bg-blue-900/20 rounded-full blur-[120px] animate-pulse" style={{ animationDelay: '2s' }}></div>
              <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full h-full opacity-10" style={{ background: 'radial-gradient(circle, rgba(79,70,229,0.1) 0%, transparent 70%)' }}></div>
            </div>
          )}

          {/* Top Progress Bar */}
          <div className={`fixed top-0 left-0 w-full h-1.5 z-[60] transition-all duration-500 ${focusMode ? 'bg-white/5' : 'bg-slate-200'}`}>
            <div 
              className="h-full bg-gradient-to-r from-indigo-500 via-indigo-600 to-indigo-400 transition-all duration-700 ease-out shadow-[0_0_20px_rgba(79,70,229,0.5)]"
              style={{ width: `${nextProgress}%` }}
            ></div>
          </div>

          <div className={`fixed top-10 left-1/2 -translate-x-1/2 z-[60] flex items-center gap-4 px-6 py-3 rounded-full border transition-all duration-500 ${focusMode ? 'bg-white/5 border-white/10 text-white backdrop-blur-xl' : 'bg-white/80 border-white text-slate-900 shadow-xl shadow-indigo-500/5 backdrop-blur-xl'}`}>
            <span className={`text-[10px] font-black uppercase tracking-[0.3em] ${focusMode ? 'text-indigo-400' : 'text-indigo-600'}`}>Progress</span>
            <div className="flex items-center gap-1.5">
              {(survey?.questions || []).map((_, idx) => (
                <div 
                  key={idx}
                  className={`w-2 h-2 rounded-full transition-all duration-500 ${
                    idx < step 
                      ? (focusMode ? 'bg-indigo-500' : 'bg-indigo-600') 
                      : idx === step 
                        ? (focusMode ? 'bg-indigo-400 w-6' : 'bg-indigo-600 w-8') 
                        : (focusMode ? 'bg-white/10' : 'bg-slate-200')
                  }`}
                ></div>
              ))}
            </div>
            <div className="w-px h-4 bg-white/10 mx-2"></div>
            <button 
                onClick={() => setFocusMode(!focusMode)}
                className={`w-8 h-8 rounded-lg flex items-center justify-center transition-all ${focusMode ? 'bg-indigo-500/20 text-indigo-400 hover:bg-indigo-500/30' : 'bg-slate-100 text-slate-400 hover:bg-indigo-50 hover:text-indigo-600'}`}
                title={focusMode ? "切換至一般模式" : "切換至沈浸模式"}
                aria-label={focusMode ? "切換至一般模式" : "切換至沈浸模式"}
              >
              <i className={`ph ${focusMode ? 'ph-eye-fill' : 'ph-eye-closed-fill'} text-lg`}></i>
            </button>
          </div>

          <div id={`q-${q.id}`} className={`transition-all duration-700 w-full max-w-2xl relative ${focusMode ? 'scale-105' : ''}`}>
            <div className={`p-10 md:p-20 rounded-[4rem] shadow-2xl transition-all duration-700 border-4 relative overflow-hidden ${
              focusMode 
                ? 'bg-white/5 backdrop-blur-3xl border-white/10 shadow-indigo-950/50' 
                : 'glass border-white shadow-indigo-100/20'
            }`}>
              {focusMode && (
                <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-indigo-500/50 to-transparent"></div>
              )}
              
              <div className="flex justify-between items-center mb-10">
                <div className={`px-6 py-2.5 rounded-2xl text-xs font-black tracking-[0.2em] transition-all duration-500 ${
                  focusMode ? 'bg-indigo-500/20 text-indigo-300' : 'bg-slate-900 text-white'
                }`}>
                  QUESTION {step + 1} OF {survey?.questions?.length || 0}
                </div>
                <div className={`font-black italic text-4xl transition-all duration-500 ${
                  focusMode ? 'text-white/5' : 'text-slate-300'
                }`}>
                  {String(step + 1).padStart(2, '0')}
                </div>
              </div>

              <h2 className={`text-4xl font-black mb-12 tracking-tight leading-tight min-h-[5rem] transition-all duration-500 ${
                focusMode ? 'text-white' : 'text-slate-900'
              }`}>{q.title}</h2>

              <div className="space-y-6 mb-16">
                {q.type === "text" ? (
                  <div className="relative group">
                    <textarea
                      className={`w-full border-2 rounded-[2.5rem] px-8 py-7 focus:ring-8 outline-none transition-all font-bold text-xl min-h-[200px] placeholder-slate-400 resize-none shadow-inner ${
                        focusMode 
                          ? 'bg-white/5 border-white/10 text-white focus:ring-indigo-500/20 focus:border-indigo-500/50' 
                          : 'bg-white border-slate-100 text-slate-700 focus:ring-indigo-500/5 focus:border-indigo-600'
                      } ${isPreview ? 'cursor-not-allowed opacity-70' : ''}`}
                      value={answers[q.id] || ""}
                      onChange={e => !isPreview && setAnswers({ ...answers, [q.id]: e.target.value })}
                      placeholder={isPreview ? "預覽模式不可輸入" : "請在此輸入您的回答..."}
                      readOnly={isPreview}
                    />
                    <div className={`absolute bottom-6 right-8 text-[10px] font-black uppercase tracking-widest pointer-events-none transition-colors ${
                      focusMode ? 'text-white/20 group-focus-within:text-indigo-400' : 'text-slate-300 group-focus-within:text-indigo-400'
                    }`}>
                      Character Count: {(answers[q.id] || "").length}
                    </div>
                  </div>
                ) : q.type === "rating" ? (
                  <div className="flex flex-col gap-10">
                    <div className="grid grid-cols-5 md:grid-cols-10 gap-3 md:gap-2">
                      {[...Array(10)].map((_, i) => {
                        const val = i + 1;
                        const isSelected = Number(answers[q.id]) === val;
                        return (
                          <button
                            key={val}
                            onClick={() => !isPreview && setAnswers({ ...answers, [q.id]: val })}
                            title={`評分 ${val} 分`}
                            aria-label={`評分 ${val} 分`}
                            className={`aspect-square w-full rounded-full border-4 font-black text-xl transition-all duration-500 flex items-center justify-center shadow-lg active:scale-90 ${
                              isSelected 
                                ? (focusMode 
                                    ? 'bg-indigo-500 border-white text-white shadow-indigo-500/50 scale-110' 
                                    : 'bg-indigo-600 border-indigo-100 text-white shadow-indigo-200 scale-110')
                                : (focusMode 
                                    ? 'bg-white/5 border-white/10 text-white/40 hover:bg-white/10 hover:border-white/20' 
                                    : 'bg-white border-slate-100 text-slate-400 hover:border-indigo-200 hover:text-indigo-600 hover:bg-indigo-50')
                            } ${isPreview ? 'cursor-not-allowed opacity-60' : ''}`}
                          >
                            {val}
                          </button>
                        );
                      })}
                    </div>
                    <div className="flex justify-between px-2">
                      <span className={`text-[10px] font-black uppercase tracking-[0.2em] ${focusMode ? 'text-white/30' : 'text-slate-400'}`}>非常不符合</span>
                      <span className={`text-[10px] font-black uppercase tracking-[0.2em] ${focusMode ? 'text-white/30' : 'text-slate-400'}`}>非常符合</span>
                    </div>
                  </div>
                ) : q.type === "file" ? (
                  <div className="space-y-6">
                    <div 
                      className={`relative p-12 rounded-[2.5rem] border-4 border-dashed transition-all duration-500 flex flex-col items-center justify-center gap-6 group/file ${
                        localFiles[q.id] 
                          ? (focusMode ? 'bg-indigo-500/10 border-indigo-500/50' : 'bg-indigo-50 border-indigo-200')
                          : (focusMode ? 'bg-white/5 border-white/10 hover:border-white/20' : 'bg-slate-50 border-slate-200 hover:border-indigo-300')
                      }`}
                      onDragOver={e => e.preventDefault()}
                      onDrop={e => {
                        e.preventDefault();
                        const file = e.dataTransfer.files[0];
                        if (file) setLocalFiles({ ...localFiles, [q.id]: file });
                      }}
                    >
                      <input 
                        type="file" 
                        className={`absolute inset-0 opacity-0 ${isPreview ? 'cursor-not-allowed' : 'cursor-pointer'}`} 
                        onChange={e => {
                          if (isPreview) return;
                          const file = e.target.files[0];
                          if (file) setLocalFiles({ ...localFiles, [q.id]: file });
                        }}
                        disabled={isPreview}
                      />
                      
                      {localFiles[q.id] ? (
                        <>
                          <div className="w-20 h-20 bg-indigo-600 text-white rounded-3xl flex items-center justify-center shadow-xl shadow-indigo-500/20">
                            <i className="ph ph-file-check-fill text-4xl"></i>
                          </div>
                          <div className="text-center">
                            <div className={`text-xl font-black mb-1 ${focusMode ? 'text-white' : 'text-slate-900'}`}>{localFiles[q.id].name}</div>
                            <div className={`text-xs font-bold ${focusMode ? 'text-indigo-400' : 'text-indigo-600'}`}>
                              {(localFiles[q.id].size / 1024 / 1024).toFixed(2)} MB • 點擊或拖放以更換檔案
                            </div>
                          </div>
                        </>
                      ) : (
                        <>
                          <div className={`w-20 h-20 rounded-3xl flex items-center justify-center transition-all duration-500 ${
                            focusMode ? 'bg-white/10 text-white/20 group-hover/file:text-white group-hover/file:bg-indigo-600' : 'bg-white text-slate-200 group-hover/file:text-indigo-600 shadow-sm'
                          }`}>
                            <i className="ph ph-cloud-arrow-up-fill text-4xl"></i>
                          </div>
                          <div className="text-center">
                            <div className={`text-xl font-black mb-1 ${focusMode ? 'text-white' : 'text-slate-900'}`}>點擊或拖放檔案至此</div>
                            <div className={`text-xs font-bold ${focusMode ? 'text-white/40' : 'text-slate-400'}`}>支援圖片、PDF、文件 (最大 5MB)</div>
                          </div>
                        </>
                      )}
                    </div>
                    {localFiles[q.id] && (
                      <button 
                        onClick={() => {
                          if (isPreview) return;
                          const newFiles = { ...localFiles };
                          delete newFiles[q.id];
                          setLocalFiles(newFiles);
                        }}
                        title="移除已選擇的檔案"
                        aria-label="移除已選擇的檔案"
                        className={`w-full py-4 rounded-2xl font-black text-xs uppercase tracking-widest transition-all ${
                          isPreview ? 'opacity-50 cursor-not-allowed' : ''
                        } ${
                          focusMode ? 'bg-rose-500/10 text-rose-400 hover:bg-rose-500/20' : 'bg-rose-50 text-rose-500 hover:bg-rose-500 hover:text-white'
                        }`}
                      >
                        移除檔案
                      </button>
                    )}
                  </div>
                ) : (
                  <div className="grid gap-4">
                    {(q.options || []).map((opt, oIdx) => {
                      const isSelected = answers[q.id] === opt;
                      return (
                        <button
                          key={oIdx}
                          onClick={() => !isPreview && setAnswers({ ...answers, [q.id]: opt })}
                          title={`選擇選項 ${String.fromCharCode(65 + oIdx)}: ${opt}`}
                          aria-label={`選擇選項 ${String.fromCharCode(65 + oIdx)}: ${opt}`}
                          className={`group flex items-center gap-6 p-7 rounded-[2rem] border-2 transition-all duration-500 text-left relative overflow-hidden ${
                            isSelected 
                              ? (focusMode 
                                  ? 'border-indigo-500 bg-indigo-500 text-white shadow-2xl shadow-indigo-500/40 scale-[1.02] z-10' 
                                  : 'border-indigo-600 bg-indigo-600 text-white shadow-2xl shadow-indigo-200 scale-[1.02] z-10')
                              : (focusMode 
                                  ? 'border-white/5 bg-white/5 text-white/60 hover:border-white/20 hover:bg-white/10' 
                                  : 'border-slate-100 bg-white text-slate-600 hover:border-indigo-200 hover:bg-indigo-50/30')
                          } ${isPreview ? 'cursor-not-allowed opacity-70' : ''}`}
                        >
                          <div className={`w-10 h-10 rounded-2xl flex items-center justify-center flex-shrink-0 transition-all duration-500 ${
                            isSelected 
                              ? (focusMode ? 'bg-white text-indigo-600 rotate-12' : 'bg-white text-indigo-600 rotate-12')
                              : (focusMode ? 'bg-white/5 text-white/30 group-hover:bg-white/10 group-hover:text-white/50' : 'bg-slate-50 text-slate-300 group-hover:bg-indigo-100 group-hover:text-indigo-400')
                          }`}>
                            <span className="font-black text-lg">{String.fromCharCode(65 + oIdx)}</span>
                          </div>
                          <span className="flex-1 font-bold text-xl tracking-tight">{opt}</span>
                          {isSelected && (
                            <i className="ph ph-check-circle-fill text-3xl animate-in fade-in zoom-in duration-300"></i>
                          )}
                        </button>
                      );
                    })}
                  </div>
                )}
              </div>

              <div className="flex gap-4">
                {step > 0 && (
                  <button
                    onClick={() => setStep(prev => prev - 1)}
                    title="回上一個問題"
                    aria-label="回上一個問題"
                    className={`flex-1 py-6 rounded-[2rem] font-black text-lg transition-all active:scale-95 border-2 ${
                      focusMode 
                        ? 'bg-white/5 border-white/10 text-white/40 hover:text-white hover:border-white/20' 
                        : 'bg-white border-slate-100 text-slate-400 hover:border-indigo-600 hover:text-indigo-600'
                    }`}
                  >
                    上一步
                  </button>
                )}
                {isLast ? (
                  <Button 
                    onClick={submit} 
                    disabled={submitting} 
                    title="完成所有問題並提交問卷"
                    aria-label="完成所有問題並提交問卷"
                    className={`flex-[2] py-6 text-xl rounded-[2rem] shadow-2xl ${
                      focusMode ? 'shadow-indigo-500/20' : 'shadow-indigo-200'
                    }`}
                  >
                    {submitting ? (
                      <span className="spinner w-7 h-7 border-4 border-white/20 border-l-white"></span>
                    ) : (
                      <>完成並提交 <i className="ph ph-paper-plane-right-fill text-2xl ml-2"></i></>
                    )}
                  </Button>
                ) : (
                  <Button 
                    onClick={nextQuestion} 
                    title="回答下一個問題"
                    aria-label="回答下一個問題"
                    className={`flex-[2] py-6 text-xl rounded-[2rem] shadow-2xl ${
                      focusMode ? 'shadow-indigo-500/20' : 'shadow-indigo-200'
                    }`}
                  >
                    下一題 <i className="ph ph-arrow-right-bold text-2xl"></i>
                  </Button>
                )}
              </div>
            </div>
            
            {focusMode && (
              <div className="mt-8 text-center">
                <p className="text-white/20 text-[10px] font-black uppercase tracking-[0.4em] flex items-center justify-center gap-3">
                  <span className="w-8 h-px bg-white/10"></span>
                  Immersive Focus Mode Active
                  <span className="w-8 h-px bg-white/10"></span>
                </p>
              </div>
            )}
          </div>
        </div>
      );
    };

    const Analytics = ({ surveyId, user, onBack, publicToken = null }) => {
      console.log("Analytics component mounting with:", { surveyId, userId: user?.uid, publicToken });
      const [survey, setSurvey] = useState(null);
      const [responses, setResponses] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [selected, setSelected] = useState(null);
      const [toast, setToast] = useState(null);
      const [pulse, setPulse] = useState(false);
      const [warRoom, setWarRoom] = useState(false);
      const [currentTime, setCurrentTime] = useState(new Date());
      const [filters, setFilters] = useState([]); // Array of { id, questionId, value, operator }

      useEffect(() => {
        const timer = setInterval(() => setCurrentTime(new Date()), 1000);
        return () => clearInterval(timer);
      }, []);

      useEffect(() => {
        let cancelled = false;
        let unsubscribeSurvey = () => {};
        let unsubscribeResponses = () => {};

        const init = async () => {
          setLoading(true);
          setError(null);
          console.log("ANALYTICS: init started for surveyId:", surveyId, "publicToken:", publicToken);
          try {
            let sDoc;
            if (publicToken) {
              console.log("ANALYTICS: using publicToken:", publicToken);
              const sSnap = await db.collection("surveys").where("shareToken", "==", publicToken).get();
              if (sSnap.empty) throw new Error("此公開分析連結無效或已關閉");
              sDoc = sSnap.docs[0];
            } else {
              if (!surveyId) throw new Error("缺少問卷 ID，無法進入分析中心");
              console.log("ANALYTICS: fetching survey by ID:", surveyId);
              sDoc = await db.collection("surveys").doc(surveyId).get();
            }

            if (!sDoc.exists) {
              console.error("ANALYTICS: survey not found:", surveyId);
              throw new Error("問卷不存在或已被刪除");
            }
            
            const sData = { id: sDoc.id, ...sDoc.data() };
            console.log("ANALYTICS: survey data loaded:", sData.title);

            if (!publicToken && sData.creatorId !== user?.uid) {
              console.error("ANALYTICS: Permission denied. Creator:", sData.creatorId, "User:", user?.uid);
              throw new Error("權限不足：您不是此問卷的建立者");
            }
            
            if (!cancelled) setSurvey(sData);

            console.log("ANALYTICS: setting up responses listener for:", sData.id);
            // 增加對 surveyCreatorId 的過濾，確保符合安全規則 (security rules)
            let q = db.collection("responses").where("surveyId", "==", sData.id);
            if (!publicToken && user?.uid) {
              console.log("ANALYTICS: adding surveyCreatorId filter for responses query");
              q = q.where("surveyCreatorId", "==", user.uid);
            }

            unsubscribeResponses = q.onSnapshot(snap => {
              try {
                console.log("ANALYTICS: responses updated, count:", snap.size);
                const rData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if (!cancelled) {
                  setResponses(rData);
                  setPulse(true);
                  setTimeout(() => setPulse(false), 1000);
                  setLoading(false);
                }
              } catch (innerErr) {
                console.error("ANALYTICS: Error processing responses snapshot:", innerErr);
                if (!cancelled) setError("處理數據時發生錯誤：" + innerErr.message);
              }
            }, err => {
              console.error("ANALYTICS: responses snapshot error:", err);
              if (!cancelled) setError("獲取回覆數據失敗：" + err.message);
              setLoading(false);
            });

          } catch (err) {
            console.error("ANALYTICS: init error", err);
            if (!cancelled) setError(err.message);
            setLoading(false);
          }
        };

        init();
        return () => { 
          console.log("ANALYTICS: unmounting, cancelling...");
          cancelled = true; 
          unsubscribeSurvey();
          unsubscribeResponses();
        };
      }, [surveyId, user?.uid, publicToken]); // Removed sentimentConfig dependency as it's not needed for fetching

      const formatTime = (seconds) => {
        const s = Number(seconds) || 0;
        if (s < 60) return `${s.toFixed(1)}s`;
        return `${Math.floor(s / 60)}m ${(s % 60).toFixed(0)}s`;
      };

      const filteredResponses = useMemo(() => {
        return responses.filter(r => {
          if (filters.length === 0) return true;
          return filters.every(f => {
            const ans = r.answers?.[f.questionId];
            if (ans === undefined || ans === null) return false;

            if (f.operator === 'equals') return String(ans) === String(f.value);
            if (f.operator === 'gt') return Number(ans) > Number(f.value);
            if (f.operator === 'lt') return Number(ans) < Number(f.value);
            return true;
          });
        });
      }, [responses, filters]);

      const stats = useMemo(() => {
        if (!survey || !filteredResponses) return null;
        
        const rData = filteredResponses;
        let totalTime = 0;
        const qTimings = {};
        const qRatings = {};
        const qChoices = {}; // { qid: { option: count } }
        const geoCounts = {};
        const timeHeatmap = {}; // "day-hour": count

        rData.forEach(r => {
          let rTotal = 0;
          // Time stats
          Object.entries(r.timings || {}).forEach(([qid, time]) => {
            const t = Number(time) || 0;
            rTotal += t;
            if (!qTimings[qid]) qTimings[qid] = { sum: 0, count: 0 };
            qTimings[qid].sum += t;
            qTimings[qid].count += 1;
          });

          // Geo stats
          if (r.geo && r.geo.city && r.geo.city !== '未知') {
            const city = r.geo.city;
            geoCounts[city] = (geoCounts[city] || 0) + 1;
          } else if (r.geo && r.geo.region && r.geo.region !== '未知') {
            const region = r.geo.region;
            geoCounts[region] = (geoCounts[region] || 0) + 1;
          }

          // Heatmap stats
          if (r.submittedAt) {
            const date = new Date(r.submittedAt);
            const day = date.getDay(); // 0-6 (Sun-Sat)
            const hour = date.getHours(); // 0-23
            const key = `${day}-${hour}`;
            timeHeatmap[key] = (timeHeatmap[key] || 0) + 1;
          }

          // Answers stats
          Object.entries(r.answers || {}).forEach(([qid, ans]) => {
            const question = (survey?.questions || []).find(q => q.id === qid);
            if (question) {
              if (question.type === 'rating') {
                const score = Number(ans) || 0;
                if (score > 0) {
                  if (!qRatings[qid]) qRatings[qid] = { sum: 0, count: 0 };
                  qRatings[qid].sum += score;
                  qRatings[qid].count += 1;
                }
              } else if (question.type === 'choice') {
                if (!qChoices[qid]) qChoices[qid] = {};
                qChoices[qid][ans] = (qChoices[qid][ans] || 0) + 1;
              }
            }
          });
          totalTime += rTotal;
        });

        // Sort geo stats
        const sortedGeo = Object.entries(geoCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5);

        return {
          totalCount: rData.length,
          avgCompletionTime: rData.length > 0 ? totalTime / rData.length : 0,
          questionStats: qTimings,
          ratingStats: qRatings,
          choiceStats: qChoices,
          geoStats: sortedGeo,
          heatmap: timeHeatmap
        };
      }, [filteredResponses, survey]);

      const downloadCSV = () => {
        try {
          if (!survey || responses.length === 0) return;
          
          // CSV Headers
          const headers = ["回覆時間", "填答者姓名", "填答者 Email"];
          (survey?.questions || []).forEach((q, idx) => {
            headers.push(`Q${idx + 1}: ${q.title}`);
            headers.push(`Q${idx + 1} 耗時(秒)`);
          });
          
          const rows = [headers];
          
          responses.forEach(r => {
            const row = [
              new Date(r.submittedAt || 0).toLocaleString(),
              r.respondent?.name || "",
              r.respondent?.email || ""
            ];
            
            (survey?.questions || []).forEach(q => {
              row.push(r.answers?.[q.id] || "");
              row.push(r.timings?.[q.id] || 0);
            });
            
            rows.push(row);
          });
          
          const csvContent = "\uFEFF" + rows.map(e => e.map(val => `"${String(val).replace(/"/g, '""')}"`).join(",")).join("\n");
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.setAttribute("href", url);
          link.setAttribute("download", `SurveyLight_${survey.title}_${new Date().toLocaleDateString()}.csv`);
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          setToast({ message: "報表匯出成功！", type: "success" });
        } catch (err) {
          setToast({ message: "匯出失敗：" + err.message, type: "error" });
        }
      };

      if (loading) return <Loading text="正在分析數據..." />;
      
      if (error) {
        return (
          <div className="flex flex-col items-center justify-center min-h-[70vh] p-6 text-center">
            <div className="w-24 h-24 bg-rose-50 text-rose-500 rounded-[2.5rem] flex items-center justify-center mb-8 shadow-xl shadow-rose-100">
              <i className="ph ph-warning-octagon-fill text-5xl"></i>
            </div>
            <h2 className="text-4xl font-black text-slate-900 mb-4 tracking-tight">Oops! Something went wrong</h2>
            <p className="text-slate-500 mb-10 text-lg font-medium max-w-md mx-auto">{error}</p>
            <Button 
              onClick={onBack} 
              title="返回儀表板主頁面"
              aria-label="返回儀表板主頁面"
              className="px-12 py-5 rounded-2xl shadow-xl shadow-slate-200"
            >
              <i className="ph ph-arrow-left-bold"></i> 返回儀表板
            </Button>
          </div>
        );
      }

      return (
        <div className={`min-h-screen transition-all duration-1000 ${warRoom ? 'war-room-bg' : 'bg-slate-50/30'}`}>
          {/* Analytics Background Micro-interactions */}
          {!warRoom && (
            <div className="fixed inset-0 pointer-events-none overflow-hidden -z-10">
              <div className="blob" style={{ top: '5%', left: '80%', animationDelay: '-1s', background: 'linear-gradient(135deg, var(--primary-soft) 0%, rgba(129, 140, 248, 0.04) 100%)' }}></div>
              <div className="blob" style={{ top: '65%', left: '-5%', animationDelay: '-6s', width: '550px', height: '550px', background: 'linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(165, 180, 252, 0.05) 100%)' }}></div>
            </div>
          )}
          
          {/* War Room Data Streams */}
          {warRoom && (
            <div className="fixed inset-0 pointer-events-none overflow-hidden z-0">
              {[...Array(window.innerWidth < 640 ? 8 : 15)].map((_, i) => (
                <div 
                  key={i} 
                  className="data-stream" 
                  style={{ 
                    left: `${Math.random() * 100}%`, 
                    animationDelay: `${Math.random() * 5}s`,
                    animationDuration: `${2 + Math.random() * 4}s`,
                    opacity: 0.1 + Math.random() * 0.2
                  }}
                ></div>
              ))}
              <div className="absolute inset-0 war-room-grid opacity-5 sm:opacity-10"></div>
              <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[300px] h-[300px] sm:w-[800px] sm:h-[800px] border border-primary/20 rounded-full animate-ping opacity-20"></div>
            </div>
          )}

          {warRoom && <div className="war-room-scanline"></div>}
          
          <div className="app-container py-12 relative z-10">
            {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
            
            {/* Header Section */}
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-12">
              <div className="flex items-center gap-6">
                {!publicToken && (
                  <button 
                    onClick={onBack} 
                    title="返回儀表板"
                    aria-label="返回儀表板"
                    className={`w-12 h-12 flex items-center justify-center rounded-xl transition-all border ${
                      warRoom 
                        ? 'bg-slate-900/50 text-white/40 border-white/10 hover:text-white hover:border-primary' 
                        : 'bg-white text-slate-400 hover:text-primary border-slate-100 hover:bg-primary-soft'
                    }`}
                  >
                    <i className="ph ph-arrow-left text-xl"></i>
                  </button>
                )}
                <div>
                  <div className={`inline-flex items-center gap-2 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest mb-2 ${
                    pulse ? 'bg-rose-500 text-white animate-pulse' : (warRoom ? 'bg-primary/20 text-primary' : 'bg-primary text-white')
                  }`}>
                    <i className={`ph ${pulse ? 'ph-broadcast-fill' : 'ph-chart-line-up-fill'}`}></i>
                    {pulse ? 'Live Update' : (warRoom ? 'War Room' : 'Analytics')}
                  </div>
                  <h1 className={`text-3xl font-black tracking-tight ${warRoom ? 'text-white' : 'text-slate-900'}`}>
                    {survey?.title}
                  </h1>
                </div>
              </div>

              <div className="flex flex-wrap items-center gap-3">
                <button
                  onClick={() => setWarRoom(!warRoom)}
                  title={warRoom ? "關閉戰情室視覺化模式" : "開啟戰情室視覺化模式"}
                  aria-label={warRoom ? "關閉戰情室視覺化模式" : "開啟戰情室視覺化模式"}
                  className={`btn-base px-6 py-3 rounded-xl font-bold transition-all ${
                    warRoom 
                      ? 'bg-primary text-white shadow-lg shadow-primary/30' 
                      : 'bg-white text-slate-600 border border-slate-200 hover:border-primary hover:text-primary'
                  }`}
                >
                  <i className={`ph ${warRoom ? 'ph-monitor-fill' : 'ph-monitor-play-fill'} text-lg`}></i>
                  {warRoom ? '關閉戰情室' : '戰情室模式'}
                </button>
                
                {!publicToken && (
                  <>
                    <button 
                      onClick={downloadCSV}
                      title="將所有回覆數據匯出為 CSV 檔案"
                      aria-label="將所有回覆數據匯出為 CSV 檔案"
                      className="btn-base btn-primary px-6 py-3 rounded-xl font-bold"
                    >
                      <i className="ph ph-file-csv-fill text-lg"></i>
                      匯出數據
                    </button>
                    {survey?.shareToken && (
                      <button 
                        onClick={() => {
                          const url = new URL(window.location.href.split('?')[0].split('#')[0]);
                          url.hash = `#/analytics/public/${survey.shareToken}`;
                          navigator.clipboard.writeText(url.toString());
                          setToast({ message: "已複製分析報告連結", type: "success" });
                        }}
                        title="複製公開分析報告的連結"
                        aria-label="複製公開分析報告的連結"
                        className="btn-base bg-slate-900 text-white px-6 py-3 rounded-xl font-bold hover:bg-slate-800"
                      >
                        <i className="ph ph-share-network-fill text-lg"></i>
                        分享報告
                      </button>
                    )}
                  </>
                )}
              </div>
            </div>



          {responses.length === 0 ? (
            <div className="text-center py-40 glass rounded-[5rem] border-4 border-dashed border-slate-100 bg-white/50 fade-in">
              <div className="w-32 h-32 bg-slate-50 text-slate-200 rounded-[3rem] flex items-center justify-center mx-auto mb-10 shadow-inner">
                <i className="ph ph-chart-bar-horizontal-fill text-7xl"></i>
              </div>
              <h3 className="text-4xl font-black text-slate-900 mb-6 tracking-tight">等待第一筆回覆...</h3>
              <p className="text-slate-400 text-xl font-medium max-w-md mx-auto mb-12 leading-relaxed">
                目前還沒有人填寫這份問卷。快將問卷分享出去，收集寶貴的數據吧！
              </p>
              <Button 
                onClick={onBack} 
                title="返回儀表板主頁面"
                aria-label="返回儀表板主頁面"
                className="px-14 py-6 rounded-[2rem] shadow-2xl shadow-indigo-100"
              >
                返回儀表板
              </Button>
            </div>
          ) : (
            <div className="flex flex-col lg:grid lg:grid-cols-12 gap-8 lg:gap-16 fade-in pb-20">
              {/* Left Column: Filters (Sticky) */}
              <div className="lg:col-span-4">
                <div className="lg:sticky lg:top-24 space-y-8">
                  {/* Advanced Filter UI - Only show in WarRoom mode */}
                  {warRoom && (
                    <div className={`p-6 sm:p-10 rounded-[2.5rem] border-2 transition-all ${
                      warRoom 
                        ? 'war-room-card border-white/5 bg-primary/5 shadow-2xl' 
                        : 'glass border-white shadow-xl shadow-primary/5 bg-white/80 backdrop-blur-xl'
                    }`}>
                      <div className="space-y-6 sm:space-y-8">
                        <div className="flex flex-col gap-4">
                          <label className={`flex items-center gap-2 text-[10px] font-black uppercase tracking-widest ${warRoom ? 'text-primary' : 'text-slate-400'}`}>
                            <i className="ph ph-funnel-fill text-lg"></i>
                            數據交叉篩選器
                          </label>
                          <button 
                            onClick={() => {
                              const firstQ = (survey?.questions || []).find(q => q.type !== 'text');
                              if (firstQ) {
                                setFilters([...filters, {
                                  id: Math.random().toString(36).substr(2, 9),
                                  questionId: firstQ.id,
                                  value: firstQ.type === 'choice' ? (firstQ.options?.[0] || "") : (firstQ.type === 'rating' ? 5 : ""),
                                  operator: firstQ.type === 'rating' ? 'gt' : 'equals'
                                }]);
                              }
                            }}
                            title="新增一個篩選條件"
                            aria-label="新增一個篩選條件"
                            className={`w-full px-5 py-4 rounded-2xl text-xs font-black flex items-center justify-center gap-2 transition-all active:scale-95 ${
                              warRoom ? 'bg-primary text-white shadow-lg shadow-primary/20' : 'bg-primary text-white shadow-lg shadow-primary/10'
                            }`}
                          >
                            <i className="ph ph-plus-bold"></i> 新增篩選條件
                          </button>
                        </div>

                        <div className="space-y-4">
                          {filters.length === 0 ? (
                            <div className={`text-center py-10 rounded-2xl border-2 border-dashed ${warRoom ? 'border-white/10 text-white/20' : 'border-slate-100 text-slate-300'}`}>
                              <i className="ph ph-funnel text-3xl mb-2 block mx-auto opacity-50"></i>
                              <p className="text-[10px] font-bold">尚未套用任何篩選條件</p>
                            </div>
                          ) : (
                            filters.map((f, idx) => (
                              <div key={f.id} className={`p-5 rounded-2xl border transition-all space-y-4 ${
                                warRoom ? 'bg-white/5 border-white/10' : 'bg-slate-50/50 border-slate-100 hover:border-primary/20 hover:bg-white hover:shadow-lg'
                              }`}>
                                <div className="flex items-center justify-between">
                                  <span className={`text-[10px] font-black uppercase tracking-widest ${warRoom ? 'text-white/40' : 'text-slate-400'}`}>篩選條件 {idx + 1}</span>
                                  <button 
                                    onClick={() => setFilters(filters.filter(item => item.id !== f.id))}
                                    title="刪除此篩選條件"
                                    aria-label="刪除此篩選條件"
                                    className="text-rose-500 hover:scale-110 transition-all"
                                  >
                                    <i className="ph ph-trash-bold"></i>
                                  </button>
                                </div>
                                
                                <div className="space-y-3">
                                  <div className="relative">
                                    <select 
                                      className={`w-full appearance-none rounded-xl px-4 py-3 text-xs font-black transition-all border-2 cursor-pointer ${
                                        warRoom ? 'bg-white/5 border-white/10 text-white focus:border-primary' : 'bg-white border-slate-100 text-slate-700 focus:border-primary'
                                      }`}
                                      value={f.questionId}
                                      onChange={e => {
                                        const qid = e.target.value;
                                        const q = (survey?.questions || []).find(x => x.id === qid);
                                        if (!q) return;
                                        const newFilters = [...filters];
                                        newFilters[idx] = {
                                          ...f,
                                          questionId: qid,
                                          value: q.type === 'choice' ? (q.options?.[0] || "") : (q.type === 'rating' ? 5 : ""),
                                          operator: q.type === 'rating' ? 'gt' : 'equals'
                                        };
                                        setFilters(newFilters);
                                      }}
                                    >
                                      {(survey?.questions || []).filter(q => q.type !== 'text').map(q => (
                                        <option key={q.id} value={q.id}>
                                          {q.type === 'choice' ? '🔘' : '⭐'} {q.title}
                                        </option>
                                      ))}
                                    </select>
                                    <i className="ph ph-caret-down-bold absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                                  </div>

                                  {(() => {
                                    const q = (survey?.questions || []).find(x => x.id === f.questionId);
                                    if (q?.type === 'rating') {
                                      return (
                                        <div className="grid grid-cols-2 gap-2">
                                          <div className="relative">
                                            <select 
                                              className={`w-full appearance-none rounded-xl px-4 py-3 text-xs font-black transition-all border-2 cursor-pointer ${
                                                warRoom ? 'bg-white/5 border-white/10 text-white focus:border-primary' : 'bg-white border-slate-100 text-slate-700 focus:border-primary'
                                              }`}
                                              value={f.operator}
                                              onChange={e => {
                                                const newFilters = [...filters];
                                                newFilters[idx] = { ...f, operator: e.target.value };
                                                setFilters(newFilters);
                                              }}
                                            >
                                              <option value="gt">大於</option>
                                              <option value="lt">小於</option>
                                              <option value="equals">等於</option>
                                            </select>
                                            <i className="ph ph-caret-down-bold absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                                          </div>
                                          <input 
                                            type="number"
                                            min="1" max="10"
                                            className={`w-full rounded-xl px-4 py-3 text-xs font-black transition-all border-2 ${
                                              warRoom ? 'bg-white/5 border-white/10 text-white focus:border-primary' : 'bg-white border-slate-100 text-slate-700 focus:border-primary'
                                            }`}
                                            value={f.value}
                                            onChange={e => {
                                              const newFilters = [...filters];
                                              newFilters[idx] = { ...f, value: e.target.value };
                                              setFilters(newFilters);
                                            }}
                                          />
                                        </div>
                                      );
                                    }
                                    return (
                                      <div className="relative">
                                        <select 
                                          className={`w-full appearance-none rounded-xl px-4 py-3 text-xs font-black transition-all border-2 cursor-pointer ${
                                            warRoom ? 'bg-white/5 border-white/10 text-white focus:border-primary' : 'bg-white border-slate-100 text-slate-700 focus:border-primary'
                                          }`}
                                          value={f.value}
                                          onChange={e => {
                                            const newFilters = [...filters];
                                            newFilters[idx] = { ...f, value: e.target.value };
                                            setFilters(newFilters);
                                          }}
                                        >
                                          {(q?.options || []).map(opt => (
                                            <option key={opt} value={opt}>{opt}</option>
                                          ))}
                                        </select>
                                        <i className="ph ph-caret-down-bold absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                                      </div>
                                    );
                                  })()}
                                </div>
                              </div>
                            ))
                          )}
                        </div>
                      </div>

                      {filters.length > 0 && (
                        <div className={`pt-6 border-t flex flex-col gap-4 ${warRoom ? 'border-white/5' : 'border-slate-100'}`}>
                          <div className="flex items-center gap-3">
                            <div className={`w-2 h-2 rounded-full animate-pulse ${warRoom ? 'bg-primary shadow-[0_0_10px_var(--primary)]' : 'bg-primary'}`}></div>
                            <p className={`text-[10px] font-bold ${warRoom ? 'text-white/60' : 'text-slate-500'}`}>
                              已篩選出 <span className={`text-base font-black tabular-nums ${warRoom ? 'text-white' : 'text-primary'}`}>{filteredResponses.length}</span> 筆符合條件
                            </p>
                          </div>
                          <button 
                            onClick={() => setFilters([])}
                            title="移除目前所有的篩選條件"
                            aria-label="移除目前所有的篩選條件"
                            className={`w-full px-4 py-3 rounded-xl text-[10px] font-black transition-all ${
                              warRoom ? 'bg-rose-500/10 text-rose-400 hover:bg-rose-500 hover:text-white' : 'bg-rose-50 text-rose-500 hover:bg-rose-500 hover:text-white'
                            }`}
                          >
                            清除所有條件
                          </button>
                        </div>
                      )}
                    </div>
                  )}

                  {/* Intelligence Summary in Sidebar */}
                  <div className={`p-8 rounded-[2.5rem] overflow-hidden relative group transition-all ${
                    warRoom 
                      ? 'war-room-card border-white/5 bg-slate-900/50' 
                      : 'bg-slate-900 text-white shadow-2xl'
                  }`}>
                    <div className="absolute top-0 right-0 w-32 h-32 bg-primary/20 rounded-full -mr-16 -mt-16 group-hover:scale-150 transition-transform duration-1000"></div>
                    <div className="relative">
                      <p className={`text-[9px] font-black uppercase tracking-[0.2em] mb-3 ${warRoom ? 'text-primary' : 'text-primary-soft'}`}>Quick Insights</p>
                      <h4 className="text-xl font-black mb-6 tracking-tight">分析概覽</h4>
                      <div className="space-y-6">
                        <div className="flex items-center justify-between">
                          <span className="text-xs font-bold text-white/40">總樣本數</span>
                          <span className="text-lg font-black tabular-nums">{responses.length}</span>
                        </div>
                        <div className="flex items-center justify-between">
                          <span className="text-xs font-bold text-white/40">目前篩選</span>
                          <span className="text-lg font-black tabular-nums">{filteredResponses.length}</span>
                        </div>
                        <div className="flex items-center justify-between">
                          <span className="text-xs font-bold text-white/40">完成率</span>
                          <span className="text-lg font-black tabular-nums">100%</span>
                        </div>
                        <div className="pt-4 border-t border-white/5">
                          <div className="flex items-center gap-2 text-[10px] font-black text-primary uppercase tracking-widest">
                            <i className="ph ph-lightning-fill"></i>
                            Live status: active
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Right Column: Stats & Data */}
              <div className="lg:col-span-8 space-y-12 sm:space-y-20">
                {/* Stats Cards */}
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-6">
                  {/* Total Responses */}
                  <div className={`p-8 rounded-[2.5rem] border-2 transition-all group hover:-translate-y-1 ${
                    warRoom ? 'war-room-card border-white/5 war-room-glow' : 'glass border-white shadow-lg shadow-primary/5'
                  }`}>
                    <div className={`w-12 h-12 rounded-xl flex items-center justify-center mb-6 transition-colors ${
                      warRoom ? 'bg-primary text-white' : 'bg-slate-900 text-white group-hover:bg-primary'
                    }`}>
                      <i className="ph ph-users-fill text-xl"></i>
                    </div>
                    <p className={`text-[9px] font-black uppercase tracking-widest mb-1 ${warRoom ? 'text-primary' : 'text-slate-400'}`}>Total Count</p>
                    <div className="flex items-baseline gap-2">
                      <span className={`text-4xl font-black ${warRoom ? 'text-white war-room-text-glow' : 'text-slate-900'}`}>{stats?.totalCount || 0}</span>
                      <span className="text-[10px] font-bold text-slate-400">回覆</span>
                    </div>
                  </div>

                  {/* Avg Time */}
                  <div className={`p-8 rounded-[2.5rem] border-2 transition-all group hover:-translate-y-1 ${
                    warRoom ? 'war-room-card border-white/5 war-room-glow' : 'glass border-white shadow-lg shadow-primary/5'
                  }`}>
                    <div className={`w-12 h-12 rounded-xl flex items-center justify-center mb-6 transition-colors ${
                      warRoom ? 'bg-emerald-500 text-white' : 'bg-emerald-500 text-white'
                    }`}>
                      <i className="ph ph-clock-fill text-xl"></i>
                    </div>
                    <p className={`text-[9px] font-black uppercase tracking-widest mb-1 ${warRoom ? 'text-emerald-400' : 'text-slate-400'}`}>Avg. Time</p>
                    <div className="flex items-baseline gap-2">
                      <span className={`text-4xl font-black ${warRoom ? 'text-white war-room-text-glow' : 'text-slate-900'}`}>{formatTime(stats?.avgCompletionTime || 0)}</span>
                    </div>
                  </div>

                  {/* Status */}
                  <div className={`p-8 rounded-[2.5rem] border-2 transition-all group hover:-translate-y-1 ${
                    warRoom ? 'war-room-card border-white/5 war-room-glow' : 'glass border-white shadow-lg shadow-primary/5'
                  }`}>
                    <div className={`w-12 h-12 rounded-xl flex items-center justify-center mb-6 transition-colors ${
                      warRoom ? 'bg-amber-500 text-white' : 'bg-amber-500 text-white'
                    }`}>
                      <i className="ph ph-activity-fill text-xl"></i>
                    </div>
                    <p className={`text-[9px] font-black uppercase tracking-widest mb-1 ${warRoom ? 'text-amber-400' : 'text-slate-400'}`}>System Status</p>
                    <div className="flex items-center gap-2">
                      <div className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                      <span className={`text-xl font-black uppercase ${warRoom ? 'text-white war-room-text-glow' : 'text-slate-900'}`}>Active</span>
                    </div>
                  </div>
                </div>

              {/* Strategic Data Summary (Replacing Charts) */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10 fade-in-up">
                {/* Time Analysis Card */}
                <div className={`rounded-2xl sm:rounded-[4rem] p-4 sm:p-12 border-4 shadow-2xl overflow-hidden relative group ${
                  warRoom ? 'war-room-card border-white/10 war-room-cyber-border war-room-glow' : 'glass border-white shadow-indigo-100/30'
                }`}>
                  <div className="flex items-center justify-between mb-6 sm:mb-10">
                    <div>
                      <h3 className={`text-lg sm:text-2xl font-black tracking-tight mb-1 sm:mb-2 ${warRoom ? 'text-white war-room-text-glow' : 'text-slate-900'}`}>互動時間分佈</h3>
                      <p className={`text-[8px] sm:text-xs font-black uppercase tracking-widest ${warRoom ? 'text-indigo-400' : 'text-indigo-600'}`}>Interaction Time Distribution</p>
                    </div>
                    <div className={`w-8 h-8 sm:w-12 sm:h-12 rounded-xl sm:rounded-2xl flex items-center justify-center ${warRoom ? 'bg-indigo-500/20 text-indigo-400' : 'bg-indigo-50 text-indigo-600'}`}>
                      <i className="ph ph-clock-countdown-fill text-lg sm:text-2xl"></i>
                    </div>
                  </div>

                  <div className="space-y-3 sm:space-y-6">
                    {(() => {
                      const hourlyData = Array(24).fill(0);
                      Object.entries(stats?.heatmap || {}).forEach(([key, count]) => {
                        const hour = parseInt(key.split('-')[1]);
                        hourlyData[hour] += count;
                      });
                      const periods = [
                        { label: '凌晨 (00-06)', range: [0, 6], icon: 'ph-moon-stars-fill' },
                        { label: '上午 (06-12)', range: [6, 12], icon: 'ph-sun-horizon-fill' },
                        { label: '下午 (12-18)', range: [12, 18], icon: 'ph-sun-fill' },
                        { label: '晚上 (18-24)', range: [18, 24], icon: 'ph-moon-fill' }
                      ];

                      return periods.map(p => {
                        const count = hourlyData.slice(p.range[0], p.range[1]).reduce((a, b) => a + b, 0);
                        const percentage = stats.totalCount > 0 ? Math.round((count / stats.totalCount) * 100) : 0;
                        return (
                          <div key={p.label} className="flex items-center justify-between p-2.5 sm:p-4 rounded-xl sm:rounded-2xl bg-white/5 border border-white/5 hover:border-indigo-500/30 transition-all group/period">
                            <div className="flex items-center gap-2.5 sm:gap-4">
                              <div className={`w-7 h-7 sm:w-10 sm:h-10 rounded-lg sm:rounded-xl flex items-center justify-center ${warRoom ? 'bg-white/5 text-indigo-400' : 'bg-slate-50 text-indigo-600'}`}>
                                <i className={`ph ${p.icon} text-base sm:text-xl`}></i>
                              </div>
                              <div>
                                <div className={`text-xs sm:text-base font-black ${warRoom ? 'text-white' : 'text-slate-700'}`}>{p.label}</div>
                                <div className={`text-[7px] sm:text-[10px] font-bold ${warRoom ? 'text-white/40' : 'text-slate-400'}`}>{p.range[0]}:00 - {p.range[1]}:00</div>
                              </div>
                            </div>
                            <div className="text-right">
                              <div className={`text-sm sm:text-xl font-black ${warRoom ? 'text-white' : 'text-slate-900'}`}>{percentage}%</div>
                              <div className={`text-[7px] sm:text-[10px] font-black uppercase tracking-widest ${warRoom ? 'text-white/20' : 'text-slate-300'}`}>{count} 筆</div>
                            </div>
                          </div>
                        );
                      });
                    })()}
                  </div>
                </div>

                {/* Geo Analysis Card */}
                <div className={`rounded-2xl sm:rounded-[4rem] p-4 sm:p-12 border-4 shadow-2xl overflow-hidden group ${
                  warRoom ? 'war-room-card border-white/10 war-room-cyber-border war-room-glow' : 'glass border-white shadow-emerald-100/30'
                }`}>
                  <div className="flex items-center justify-between mb-6 sm:mb-10">
                    <div>
                      <h3 className={`text-lg sm:text-2xl font-black tracking-tight mb-1 sm:mb-2 ${warRoom ? 'text-white war-room-text-glow' : 'text-slate-900'}`}>地理分佈數據</h3>
                      <p className={`text-[8px] sm:text-xs font-black uppercase tracking-widest ${warRoom ? 'text-emerald-400' : 'text-emerald-600'}`}>Geographic Data Analysis</p>
                    </div>
                    <div className={`w-8 h-8 sm:w-12 sm:h-12 rounded-xl sm:rounded-2xl flex items-center justify-center ${warRoom ? 'bg-emerald-500/20 text-emerald-400' : 'bg-emerald-50 text-emerald-600'}`}>
                      <i className="ph ph-map-pin-fill text-lg sm:text-2xl"></i>
                    </div>
                  </div>
                  
                  <div className="space-y-2.5 sm:space-y-4">
                    {(stats?.geoStats || []).length > 0 ? (
                      <div className="grid grid-cols-1 gap-2 sm:gap-3">
                        {stats.geoStats.map(([city, count]) => (
                          <div key={city} className={`flex items-center justify-between p-2.5 sm:p-5 rounded-xl sm:rounded-2xl border-2 transition-all ${
                            warRoom ? 'bg-white/5 border-white/5 hover:border-emerald-500/30' : 'bg-slate-50 border-slate-100 hover:border-emerald-200'
                          }`}>
                            <div className="flex items-center gap-2.5 sm:gap-4">
                              <div className={`w-2 h-2 sm:w-3 sm:h-3 rounded-full ${warRoom ? 'bg-emerald-500' : 'bg-emerald-600'}`}></div>
                              <span className={`text-xs sm:text-lg font-black ${warRoom ? 'text-white' : 'text-slate-700'}`}>{city}</span>
                            </div>
                            <div className="flex items-baseline gap-1 sm:gap-2">
                              <span className={`text-sm sm:text-2xl font-black ${warRoom ? 'text-white' : 'text-slate-900'}`}>
                                {Math.round((count / stats.totalCount) * 100)}%
                              </span>
                              <span className={`text-[7px] sm:text-[10px] font-black uppercase tracking-widest ${warRoom ? 'text-white/20' : 'text-slate-400'}`}>
                                ({count} 筆)
                              </span>
                            </div>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <div className="text-center py-10 sm:py-20">
                        <p className={`text-xs sm:text-base ${warRoom ? 'text-white/20' : 'text-slate-300'}`}>尚未有足夠地理數據</p>
                      </div>
                    )}
                  </div>
                </div>
              </div>

              {/* War Room Specific Metrics (Replacing War Room Charts) */}
              {warRoom && (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10 fade-in-up">
                  {/* Weekly Trend Analysis */}
                  <div className="war-room-card rounded-[2rem] sm:rounded-[4rem] p-5 sm:p-12 border-white/10 war-room-cyber-border overflow-hidden group">
                    <div className="flex items-center justify-between mb-6 sm:mb-10">
                      <div>
                        <h3 className="text-lg sm:text-2xl font-black text-white tracking-tight mb-1 sm:mb-2">週填答趨勢</h3>
                        <p className="text-indigo-400 text-[8px] sm:text-[10px] font-black uppercase tracking-[0.3em]">Weekly Interaction Trend</p>
                      </div>
                      <div className="w-10 h-10 sm:w-12 sm:h-12 bg-indigo-500/20 rounded-xl sm:rounded-2xl flex items-center justify-center border border-indigo-500/30">
                        <i className="ph ph-calendar-bold text-indigo-400 text-lg sm:text-xl"></i>
                      </div>
                    </div>
                    <div className="space-y-3 sm:space-y-4">
                      {['週日', '週一', '週二', '週三', '週四', '週五', '週六'].map((dayName, dayIdx) => {
                        const dayCount = Object.entries(stats?.heatmap || {})
                          .filter(([key]) => key.startsWith(`${dayIdx}-`))
                          .reduce((sum, [_, count]) => sum + count, 0);
                        const percentage = stats.totalCount > 0 ? Math.round((dayCount / stats.totalCount) * 100) : 0;
                        return (
                          <div key={dayName} className="flex items-center justify-between p-3 sm:p-4 rounded-xl bg-white/5 border border-white/5 group/day transition-all hover:bg-white/10">
                            <span className="text-white/60 font-black text-xs sm:text-base">{dayName}</span>
                            <div className="flex items-center gap-3 sm:gap-4">
                              <div className="w-24 sm:w-48 h-1.5 sm:h-2 bg-white/5 rounded-full overflow-hidden">
                                <div className="h-full bg-indigo-500 war-room-glow transition-all duration-1000" style={{ width: `${percentage}%` }}></div>
                              </div>
                              <span className="text-white font-black text-xs sm:text-base w-8 sm:w-10 text-right tabular-nums">{percentage}%</span>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>

                  {/* Data Integrity & Strategic Analysis */}
                  <div className="war-room-card rounded-[2rem] sm:rounded-[4rem] p-5 sm:p-12 border-white/10 war-room-cyber-border overflow-hidden group">
                    <div className="flex items-center justify-between mb-6 sm:mb-10">
                      <div>
                        <h3 className="text-lg sm:text-2xl font-black text-white tracking-tight mb-1 sm:mb-2">數據完整度與戰略分析</h3>
                        <p className="text-emerald-400 text-[8px] sm:text-[10px] font-black uppercase tracking-[0.3em]">Data Integrity & Strategic Analysis</p>
                      </div>
                      <div className="w-10 h-10 sm:w-12 sm:h-12 bg-emerald-500/20 rounded-xl sm:rounded-2xl flex items-center justify-center border border-emerald-500/30">
                        <i className="ph ph-shield-check-fill text-emerald-400 text-lg sm:text-xl"></i>
                      </div>
                    </div>
                    <div className="space-y-6 sm:space-y-8">
                      <div className="p-6 sm:p-8 rounded-2xl sm:rounded-3xl bg-white/5 border border-white/5 hover:border-emerald-500/30 transition-all">
                        <div className="flex items-center gap-2 sm:gap-3 mb-3 sm:mb-4">
                          <div className="w-8 h-8 sm:w-10 sm:h-10 rounded-lg sm:rounded-xl bg-emerald-500/20 flex items-center justify-center">
                            <i className="ph ph-chart-line-up-bold text-emerald-400 text-sm sm:text-base"></i>
                          </div>
                          <div className="text-[8px] sm:text-[10px] font-black text-white/40 uppercase tracking-widest">平均填答深度</div>
                        </div>
                        <div className="text-3xl sm:text-5xl font-black text-white mb-1 sm:mb-2 war-room-text-glow">100%</div>
                        <p className="text-[10px] sm:text-xs text-white/40 font-bold leading-relaxed">所有題目皆已獲得有效回覆，數據結構完整且具備統計意義。</p>
                      </div>
                      
                      <div className="p-6 sm:p-8 rounded-2xl sm:rounded-3xl bg-white/5 border border-white/5 hover:border-emerald-500/30 transition-all">
                        <div className="flex items-center gap-2 sm:gap-3 mb-3 sm:mb-4">
                          <div className="w-8 h-8 sm:w-10 sm:h-10 rounded-lg sm:rounded-xl bg-emerald-500/20 flex items-center justify-center">
                            <i className="ph ph-fingerprint-bold text-emerald-400 text-sm sm:text-base"></i>
                          </div>
                          <div className="text-[8px] sm:text-[10px] font-black text-white/40 uppercase tracking-widest">數據可信度評級</div>
                        </div>
                        <div className="text-3xl sm:text-5xl font-black text-emerald-400 mb-1 sm:mb-2 war-room-text-glow">A+ HIGH</div>
                        <p className="text-[10px] sm:text-xs text-white/40 font-bold leading-relaxed">根據填答時間與來源地理分佈分析，未發現異常自動化填答行為。</p>
                      </div>
                    </div>
                  </div>

                  {/* Sentiment Analysis Summary Removed */}
                 </div>
               )}

              {/* Timing Analysis */}
              <div className="space-y-6 sm:space-y-10">
                <div className="flex items-center justify-between px-2 sm:px-4">
                  <div>
                    <h3 className={`text-xl sm:text-3xl font-black tracking-tight ${warRoom ? 'text-white' : 'text-slate-900'}`}>題目耗時分析</h3>
                    <p className={`${warRoom ? 'text-white/40' : 'text-slate-400'} font-bold mt-1 text-[10px] sm:text-base`}>
                      {filters.length > 0 ? '篩選後的題目停留時間分布' : '了解填答者在哪些題目停留最久'}
                    </p>
                  </div>
                  <div className={`w-10 h-10 sm:w-12 sm:h-12 rounded-xl sm:rounded-2xl flex items-center justify-center ${warRoom ? 'bg-white/5 text-white/20' : 'bg-slate-50 text-slate-300'}`}>
                    <i className="ph ph-timer-bold text-lg sm:text-2xl"></i>
                  </div>
                </div>
                
                <div className="grid gap-4 sm:gap-8">
                  {(survey?.questions || []).map((q, idx) => {
                    const currentStats = stats;
                    const qs = (currentStats?.questionStats || {})[q.id];
                    const avg = qs?.count > 0 ? (qs.sum / qs.count) : 0;
                    const maxTime = Math.max(...Object.values(currentStats?.questionStats || {}).map(s => s.count > 0 ? s.sum / s.count : 0), 1);
                    const widthPercent = Math.max(5, (avg / maxTime) * 100);
                    const choiceData = q.type === 'choice' ? (currentStats?.choiceStats?.[q.id] || {}) : null;

                    return (
                      <div key={q.id} className={`group p-4 sm:p-10 rounded-2xl sm:rounded-[3rem] border-2 transition-all backdrop-blur-md ${
                        warRoom 
                          ? 'war-room-card border-white/5 hover:border-indigo-500/30' 
                          : 'glass border-white hover:border-indigo-100 bg-white/40 shadow-xl shadow-indigo-100/10'
                      }`}>
                        <div className="flex flex-col sm:flex-row sm:items-start gap-4 sm:gap-10">
                          <div className={`w-10 h-10 sm:w-20 sm:h-20 rounded-xl sm:rounded-[2rem] flex items-center justify-center font-black text-sm sm:text-2xl flex-shrink-0 transition-all shadow-lg ${
                            warRoom ? 'bg-indigo-600 text-white' : 'bg-slate-900 text-white group-hover:bg-indigo-600 group-hover:scale-105'
                          }`}>
                            {idx + 1}
                          </div>
                          
                          <div className="flex-1 min-w-0 space-y-4 sm:space-y-6">
                            <div>
                              <div className="flex flex-wrap items-center gap-2 sm:gap-4 mb-2 sm:mb-4">
                                <span className={`text-[8px] sm:text-[11px] font-black uppercase tracking-widest px-2 py-1 sm:px-4 sm:py-1.5 rounded-lg ${
                                  warRoom ? 'bg-white/5 text-white/40' : 'bg-slate-100 text-slate-400'
                                }`}>
                                  {q.type === 'choice' ? '🔘 Choice' : q.type === 'rating' ? '⭐ Rating' : '💬 Text'}
                                </span>
                                <span className={`text-[10px] sm:text-base font-black tabular-nums ${warRoom ? 'text-indigo-400' : 'text-indigo-600'}`}>
                                  平均耗時 {formatTime(avg)}
                                </span>
                                {q.type === 'rating' && currentStats?.ratingStats?.[q.id] && currentStats.ratingStats[q.id].count > 0 && (
                                  <>
                                    <span className={`w-1 h-1 rounded-full ${warRoom ? 'bg-white/10' : 'bg-slate-200'} hidden sm:block`}></span>
                                    <span className={`text-[10px] sm:text-base font-black tabular-nums text-emerald-500`}>
                                      平均評分 {(currentStats.ratingStats[q.id].sum / currentStats.ratingStats[q.id].count).toFixed(1)} / 10
                                    </span>
                                  </>
                                )}
                              </div>
                              <h4 className={`text-base sm:text-2xl font-black leading-tight mb-2 sm:mb-4 ${warRoom ? 'text-white' : 'text-slate-900'}`}>{q.title}</h4>
                            </div>

                            {/* Choice Distribution Visualization */}
                            {q.type === 'choice' && choiceData && (
                              <div className="space-y-2 sm:space-y-3 py-2 sm:py-4 border-y border-white/5">
                                {(q.options || []).map(opt => {
                                  const count = choiceData[opt] || 0;
                                  const total = Object.values(choiceData).reduce((a, b) => a + b, 0) || 1;
                                  const percent = Math.round((count / total) * 100);
                                  return (
                                    <div key={opt} className="space-y-1 sm:space-y-1.5">
                                      <div className="flex justify-between items-end">
                                        <span className={`text-[10px] sm:text-sm font-bold truncate pr-4 ${warRoom ? 'text-white/60' : 'text-slate-600'}`}>{opt}</span>
                                        <span className={`text-[10px] sm:text-sm font-black tabular-nums ${warRoom ? 'text-white' : 'text-slate-900'}`}>{percent}%</span>
                                      </div>
                                      <div className={`h-1.5 sm:h-2 rounded-full overflow-hidden ${warRoom ? 'bg-white/5' : 'bg-slate-50'}`}>
                                        <div 
                                          className={`h-full transition-all duration-1000 ease-out ${warRoom ? 'bg-indigo-500 shadow-[0_0_10px_rgba(99,102,241,0.5)]' : 'bg-indigo-600'}`}
                                          style={{ width: `${percent}%` }}
                                        ></div>
                                      </div>
                                    </div>
                                  );
                                })}
                              </div>
                            )}

                            {/* Time Impact Indicator */}
                            <div className="flex items-center gap-3 sm:gap-6">
                              <div className={`text-[8px] sm:text-[11px] font-black uppercase tracking-[0.2em] whitespace-nowrap ${warRoom ? 'text-white/20' : 'text-slate-300'}`}>
                                時間影響力
                              </div>
                              <div className="flex-1 flex items-center gap-2 sm:gap-4">
                                <div className={`flex-1 h-1 sm:h-2 rounded-full overflow-hidden ${warRoom ? 'bg-white/5' : 'bg-slate-100'}`}>
                                  <div 
                                    className={`h-full transition-all duration-1000 ease-out ${warRoom ? 'bg-rose-500 shadow-[0_0_10px_rgba(244,63,94,0.5)]' : 'bg-rose-500'}`}
                                    style={{ width: `${widthPercent}%` }}
                                  ></div>
                                </div>
                                <span className={`text-[10px] sm:text-base font-black tabular-nums ${warRoom ? 'text-rose-500' : 'text-rose-600'}`}>
                                  {Math.round(widthPercent)}%
                                </span>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>

              {/* Respondent List */}
              <div className="space-y-6 sm:space-y-10">
                <div className="flex items-center justify-between px-2 sm:px-4">
                  <div>
                    <h3 className={`text-xl sm:text-3xl font-black tracking-tight ${warRoom ? 'text-white' : 'text-slate-900'}`}>詳細填答名單</h3>
                    <p className={`${warRoom ? 'text-white/40' : 'text-slate-400'} font-bold mt-1 text-[10px] sm:text-base`}>
                      {filters.length > 0 ? (
                        <>
                          篩選出 <span className={warRoom ? 'text-white' : 'text-indigo-600'}>{filteredResponses.length}</span> 筆
                          <span className="mx-1 opacity-30">/</span>
                          總計 {responses.length} 筆
                        </>
                      ) : (
                        `共 ${responses.length} 筆回覆數據`
                      )}
                    </p>
                  </div>
                  <div className={`w-10 h-10 sm:w-12 sm:h-12 rounded-xl sm:rounded-2xl flex items-center justify-center ${warRoom ? 'bg-white/5 text-white/20' : 'bg-slate-50 text-slate-300'}`}>
                    <i className="ph ph-users-bold text-lg sm:text-2xl"></i>
                  </div>
                </div>

                <div className={`overflow-hidden border-2 transition-all rounded-2xl sm:rounded-[3rem] ${
                  warRoom 
                    ? 'war-room-card border-white/5 shadow-2xl' 
                    : 'card-modern bg-white/70 backdrop-blur-xl border-white shadow-xl shadow-indigo-100/10'
                }`}>
                  <div className="overflow-x-auto scrollbar-hide">
                    <table className="w-full text-left border-collapse whitespace-nowrap">
                      <thead>
                        <tr className={`${warRoom ? 'bg-white/5 text-white/20' : 'bg-slate-50/50 text-slate-400'} text-[8px] sm:text-[10px] font-black uppercase tracking-[0.2em] sm:tracking-[0.3em]`}>
                          <th className="px-4 py-4 sm:px-10 sm:py-8">填答者資訊</th>
                          <th className="px-4 py-4 sm:px-10 sm:py-8">作答總時長</th>
                          <th className="px-4 py-4 sm:px-10 sm:py-8">提交時間</th>
                          <th className="px-4 py-4 sm:px-10 sm:py-8 text-right">操作</th>
                        </tr>
                      </thead>
                      <tbody className={`divide-y ${warRoom ? 'divide-white/5' : 'divide-slate-50'}`}>
                        {filteredResponses
                          .sort((a, b) => (b.submittedAt || 0) - (a.submittedAt || 0))
                          .map((r) => {
                            const totalTime = Object.values(r.timings || {}).reduce((a, b) => a + (Number(b) || 0), 0);
                            return (
                              <tr 
                                key={r.id} 
                                onClick={() => setSelected(r)}
                                className={`group transition-all duration-300 cursor-pointer ${warRoom ? 'hover:bg-white/5' : 'hover:bg-white'}`}
                              >
                                <td className="px-4 py-4 sm:px-10 sm:py-8">
                                   <div className="flex items-center gap-3 sm:gap-6">
                                    <div className={`w-10 h-10 sm:w-16 sm:h-16 rounded-xl sm:rounded-[1.5rem] flex items-center justify-center transition-all duration-500 shadow-inner flex-shrink-0 ${
                                      warRoom ? 'bg-white/5 text-white/20 group-hover:bg-indigo-600 group-hover:text-white' : 'bg-slate-50 text-slate-300 group-hover:bg-indigo-600 group-hover:text-white'
                                    }`}>
                                      <i className="ph ph-user-fill text-base sm:text-2xl"></i>
                                    </div>
                                    <div className="min-w-0">
                                      <div className={`font-black text-xs sm:text-xl mb-0.5 sm:mb-1 truncate ${warRoom ? 'text-white' : 'text-slate-900'}`}>{r.respondent?.name || "匿名"}</div>
                                      <div className={`text-[9px] sm:text-sm font-bold tracking-tight truncate ${warRoom ? 'text-white/30' : 'text-slate-400'}`}>{r.respondent?.email || "無信箱資訊"}</div>
                                    </div>
                                  </div>
                                </td>
                                <td className="px-4 py-4 sm:px-10 sm:py-8">
                                  <div className={`inline-flex items-center gap-2 sm:gap-3 px-3 py-1.5 sm:px-5 sm:py-2.5 rounded-xl sm:rounded-2xl font-black text-[11px] sm:text-lg ${
                                    warRoom ? 'bg-indigo-500/10 text-indigo-400' : 'bg-indigo-50 text-indigo-600'
                                  }`}>
                                    <i className="ph ph-clock-fill"></i>
                                    {formatTime(totalTime)}
                                  </div>
                                </td>
                                <td className="px-4 py-4 sm:px-10 sm:py-8">
                                  <div className="space-y-0.5 sm:space-y-1">
                                    <div className={`font-black text-[11px] sm:text-lg ${warRoom ? 'text-white' : 'text-slate-900'}`}>{new Date(r.submittedAt || 0).toLocaleDateString()}</div>
                                    <div className={`font-bold text-[8px] sm:text-xs uppercase tracking-widest ${warRoom ? 'text-white/20' : 'text-slate-400'}`}>
                                      {new Date(r.submittedAt || 0).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                    </div>
                                  </div>
                                </td>
                                <td className="px-4 py-4 sm:px-10 sm:py-8 text-right">
                                  <button
                                    onClick={() => setSelected(r)}
                                    title="查看此填答的詳細內容"
                                    aria-label="查看此填答的詳細內容"
                                    className={`inline-flex items-center gap-2 sm:gap-3 px-3 py-2 sm:px-10 sm:py-5 rounded-xl sm:rounded-2xl font-black text-[10px] sm:text-sm transition-all active:scale-95 shadow-lg sm:shadow-2xl ${
                                      warRoom 
                                        ? 'bg-indigo-600 text-white hover:bg-indigo-500 shadow-indigo-500/20' 
                                        : 'bg-slate-900 text-white hover:bg-indigo-600 shadow-slate-200 group-hover:shadow-indigo-500/20'
                                    }`}
                                  >
                                    <span className="hidden xs:inline">詳情</span> <i className="ph ph-eye-fill text-sm sm:text-xl"></i>
                                  </button>
                                </td>
                              </tr>
                            );
                          })}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

          {/* Response Detail Modal */}
          {selected && (
            <Modal
              title="填答詳情回顧"
              onClose={() => setSelected(null)}
              warRoom={warRoom}
              footer={
                <div className="flex justify-end w-full">
                  <Button 
                    onClick={() => setSelected(null)} 
                    title="關閉填答詳情彈窗"
                    aria-label="關閉填答詳情彈窗"
                    className={`px-14 py-5 rounded-[2rem] shadow-2xl ${
                      warRoom ? 'bg-indigo-600 text-white shadow-indigo-500/20' : 'shadow-indigo-200'
                    }`}
                  >
                    關閉詳情
                  </Button>
                </div>
              }
            >
              <div className="space-y-6 sm:space-y-12">
                {/* User Profile Header */}
                <div className={`relative overflow-hidden p-5 sm:p-10 rounded-[2rem] sm:rounded-[3.5rem] border-4 shadow-2xl group transition-all duration-500 ${
                  warRoom 
                    ? 'war-room-card border-white/10 war-room-glow' 
                    : 'glass border-white shadow-indigo-100/20 bg-white/50 backdrop-blur-md'
                }`}>
                  <div className={`absolute top-0 right-0 w-24 sm:w-40 h-24 sm:h-40 rounded-full -mr-12 -mt-12 sm:-mr-20 sm:-mt-20 group-hover:scale-110 transition-transform duration-1000 ${
                    warRoom ? 'bg-indigo-500/10' : 'bg-indigo-50'
                  }`}></div>
                  <div className="relative flex flex-col sm:flex-row items-center justify-between gap-6 sm:gap-8">
                    <div className="flex flex-col sm:flex-row items-center gap-4 sm:gap-8">
                      <div className={`w-14 h-14 sm:w-20 sm:h-20 rounded-2xl sm:rounded-[2rem] flex items-center justify-center shadow-2xl transition-all ${
                        warRoom ? 'bg-indigo-600 text-white shadow-indigo-500/20' : 'bg-slate-900 text-white shadow-slate-200 group-hover:bg-indigo-600'
                      }`}>
                        <i className={`ph ph-user-circle-fill text-3xl sm:text-5xl ${warRoom ? 'war-room-pulse' : ''}`}></i>
                      </div>
                      <div className="text-center sm:text-left">
                        <div className={`font-black text-xl sm:text-3xl mb-1 sm:mb-2 ${warRoom ? 'text-white war-room-text-glow' : 'text-slate-900'}`}>{selected.respondent?.name || "匿名"}</div>
                        <div className={`flex items-center justify-center sm:justify-start gap-2 font-bold ${warRoom ? 'text-white/40' : 'text-slate-500'}`}>
                          <i className={`ph ph-envelope-simple-fill ${warRoom ? 'text-indigo-400' : 'text-indigo-400'}`}></i>
                          <span className="text-xs sm:text-base">{selected.respondent?.email || "未提供信箱"}</span>
                        </div>
                      </div>
                    </div>
                    <div className="flex flex-col items-center sm:items-end gap-1 sm:gap-2 w-full sm:w-auto">
                      <div className={`text-[8px] sm:text-[10px] font-black uppercase tracking-[0.2em] ${warRoom ? 'text-indigo-400' : 'text-slate-300'}`}>Total Time Spent</div>
                      <div className={`w-full sm:w-auto text-center px-4 py-2 sm:px-8 sm:py-4 rounded-xl sm:rounded-2xl shadow-sm border text-xl sm:text-3xl font-black tabular-nums transition-all ${
                        warRoom 
                          ? 'bg-white/5 border-white/10 text-white war-room-text-glow' 
                          : 'bg-white border-slate-100 text-indigo-600'
                      }`}>
                        {formatTime(Object.values(selected.timings || {}).reduce((a, b) => a + (Number(b) || 0), 0))}
                      </div>
                    </div>
                  </div>
                </div>

                {/* Data Insights Summary for War Room */}
                {warRoom && (
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                    <div className="p-5 sm:p-8 rounded-[1.5rem] sm:rounded-[2.5rem] bg-emerald-500/5 border border-emerald-500/20 flex flex-col gap-1 sm:gap-2">
                      <span className="text-[8px] sm:text-[10px] font-black text-emerald-400 uppercase tracking-widest">Efficiency Rating</span>
                      <div className="flex items-baseline gap-2">
                        <span className="text-2xl sm:text-4xl font-black text-white">Optimal</span>
                        <span className="text-[10px] sm:text-xs text-emerald-400">94%</span>
                      </div>
                    </div>
                    <div className="p-5 sm:p-8 rounded-[1.5rem] sm:rounded-[2.5rem] bg-indigo-500/5 border border-indigo-500/20 flex flex-col gap-1 sm:gap-2">
                      <span className="text-[8px] sm:text-[10px] font-black text-indigo-400 uppercase tracking-widest">Consistency Score</span>
                      <div className="flex items-baseline gap-2">
                        <span className="text-2xl sm:text-4xl font-black text-white">High</span>
                        <span className="text-[10px] sm:text-xs text-indigo-400">0.82σ</span>
                      </div>
                    </div>
                  </div>
                )}

                {/* Question Responses */}
                <div className="space-y-6 sm:space-y-8">
                  <div className="flex items-center gap-3 sm:gap-4 px-2 sm:px-4">
                    <div className={`w-8 h-8 sm:w-10 sm:h-10 rounded-lg sm:rounded-xl flex items-center justify-center transition-colors ${
                      warRoom ? 'bg-indigo-600 text-white shadow-indigo-500/20' : 'bg-slate-900 text-white'
                    }`}>
                      <i className="ph ph-list-checks-bold text-lg sm:text-xl"></i>
                    </div>
                    <h4 className={`text-xl sm:text-2xl font-black tracking-tight ${warRoom ? 'text-white' : 'text-slate-900'}`}>逐題回答詳情</h4>
                  </div>
                  
                  <div className="space-y-6 sm:space-y-8">
                    {(survey?.questions || []).map((q, idx) => {
                      const ans = (selected.answers || {})[q.id];
                      const t = (selected.timings || {})[q.id];
                      return (
                        <div key={q.id} className={`group p-5 sm:p-10 rounded-[2rem] sm:rounded-[3.5rem] border-2 transition-all backdrop-blur-md ${
                          warRoom 
                            ? 'war-room-card border-white/5 hover:border-indigo-500/30' 
                            : 'glass border-white hover:border-indigo-100 bg-white/50'
                        }`}>
                          <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4 sm:gap-6 mb-5 sm:mb-8">
                            <div className="flex items-center gap-3 sm:gap-5">
                              <div className={`w-8 h-8 sm:w-12 sm:h-12 rounded-xl sm:rounded-2xl flex items-center justify-center font-black transition-all text-sm sm:text-base ${
                                warRoom 
                                  ? 'bg-indigo-600 text-white shadow-indigo-500/20' 
                                  : 'bg-slate-100 text-slate-400 group-hover:bg-indigo-600 group-hover:text-white'
                              }`}>
                                {idx + 1}
                              </div>
                              <div className={`inline-flex items-center gap-2 px-3 py-1 sm:px-4 sm:py-1.5 rounded-xl border text-[8px] sm:text-[10px] font-black uppercase tracking-widest transition-all ${
                                warRoom 
                                  ? 'bg-white/5 border-white/5 text-white/40' 
                                  : 'bg-slate-50 border-slate-100 text-slate-400'
                              }`}>
                                {q.type === 'choice' ? '🔘 Choice' : q.type === 'rating' ? '⭐ Rating' : q.type === 'file' ? '📁 File' : '💬 Text'}
                              </div>
                            </div>
                            <div className={`inline-flex items-center gap-2 px-3 py-1.5 sm:px-5 sm:py-2.5 rounded-xl sm:rounded-2xl border shadow-sm text-[10px] sm:text-xs font-black uppercase tracking-widest tabular-nums transition-all ${
                              warRoom 
                                ? 'bg-white/5 border-white/5 text-indigo-400' 
                                : 'bg-white border-slate-100 text-indigo-600'
                            }`}>
                              <i className="ph ph-timer-bold text-sm sm:text-lg"></i>
                              {formatTime(t || 0)}
                            </div>
                          </div>
                          <h5 className={`font-black mb-4 sm:mb-8 text-lg sm:text-2xl tracking-tight leading-tight transition-colors ${
                            warRoom ? 'text-white group-hover:text-indigo-400' : 'text-slate-900 group-hover:text-indigo-600'
                          }`}>{q.title}</h5>
                          <div className={`rounded-xl sm:rounded-[2rem] p-5 sm:p-8 border-2 font-bold text-base sm:text-xl leading-relaxed shadow-inner transition-all ${
                            warRoom 
                              ? 'bg-white/5 border-white/5 text-white/80' 
                              : 'bg-white/80 border-slate-50 text-slate-700'
                          }`}>
                            {ans ? (
                              <div className="flex items-start gap-3 sm:gap-5">
                                <div className={`w-7 h-7 sm:w-10 sm:h-10 rounded-full flex items-center justify-center flex-shrink-0 transition-colors ${
                                  warRoom ? 'bg-indigo-500/20' : 'bg-indigo-50'
                                }`}>
                                  <i className={`ph ${q.type === 'rating' ? 'ph-star-fill' : q.type === 'file' ? 'ph-file-cloud-fill' : 'ph-chat-centered-dots-fill'} text-lg sm:text-2xl ${warRoom ? 'text-indigo-400' : 'text-indigo-400'}`}></i>
                                </div>
                                <div className="pt-0.5 sm:pt-1 min-w-0 flex-1">
                                  {q.type === 'rating' ? (
                                    <div className="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3">
                                      <div className="flex items-baseline gap-1">
                                        <span className="text-xl sm:text-3xl font-black text-indigo-600">{ans}</span>
                                        <span className="text-[10px] sm:text-sm text-slate-400">/ 10</span>
                                      </div>
                                      <div className="flex gap-1 overflow-x-auto pb-1 sm:pb-0">
                                        {[...Array(10)].map((_, i) => (
                                          <div key={i} className={`w-1 h-1 sm:w-2 sm:h-2 rounded-full flex-shrink-0 ${i < Number(ans) ? 'bg-indigo-500' : 'bg-slate-200'}`}></div>
                                        ))}
                                      </div>
                                    </div>
                                  ) : q.type === 'file' ? (
                                    <div className="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4">
                                      <a 
                                        href={ans} 
                                        target="_blank" 
                                        rel="noopener noreferrer"
                                        className={`inline-flex items-center justify-center gap-2 sm:gap-3 px-5 py-2.5 sm:px-8 sm:py-4 rounded-xl sm:rounded-2xl font-black text-[10px] sm:text-sm transition-all active:scale-95 ${
                                          warRoom ? 'bg-indigo-600 text-white hover:bg-indigo-500' : 'bg-slate-900 text-white hover:bg-indigo-600'
                                        }`}
                                      >
                                        <i className="ph ph-download-simple-bold text-base sm:text-xl"></i>
                                        下載 / 查看檔案
                                      </a>
                                      <div className={`text-[8px] sm:text-[10px] font-black uppercase tracking-widest ${warRoom ? 'text-white/20' : 'text-slate-300'}`}>
                                        Uploaded via Storage
                                      </div>
                                    </div>
                                  ) : <span className="break-words text-sm sm:text-xl">{String(ans)}</span>}
                                </div>
                              </div>
                            ) : (
                              <div className="flex items-center gap-3 sm:gap-5 italic transition-colors">
                                <div className={`w-7 h-7 sm:w-10 sm:h-10 rounded-full flex items-center justify-center flex-shrink-0 ${
                                  warRoom ? 'bg-white/5 text-white/10' : 'bg-slate-50 text-slate-300'
                                }`}>
                                  <i className="ph ph-prohibit-bold text-lg sm:text-2xl"></i>
                                </div>
                                <span className={`text-xs sm:text-base ${warRoom ? 'text-white/20' : 'text-slate-300'}`}>填答者跳過了此題</span>
                              </div>
                            )}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            </Modal>
          )}
          </div>
        </div>
      );
    };

    const DebugStatus = () => {
      const [online, setOnline] = useState(navigator.onLine ? "Online" : "Offline");
      const [dbStatus, setDbStatus] = useState("Checking...");
      const [showInfo, setShowInfo] = useState(false);
      const [lastClick, setLastClick] = useState(window.__lastClick || "None");
      const [dbLatency, setDbLatency] = useState(null);
      const [checking, setChecking] = useState(false);
      const [sessionEvents, setSessionEvents] = useState([]);
      const [lastSync, setLastSync] = useState(null);
      
      const addEvent = (msg) => {
        setSessionEvents(prev => [
          { time: new Date().toLocaleTimeString(), msg },
          ...prev.slice(0, 4)
        ]);
      };

      const check = async () => {
        setChecking(true);
        const start = Date.now();
        try {
          await db.collection("surveys").limit(1).get();
          setDbStatus("Connected");
          setDbLatency(Date.now() - start);
          setLastSync(new Date());
          addEvent("Firestore Health Check: OK");
        } catch (e) {
          console.error("DEBUG: DB Check Failed", e);
          setDbStatus("Error: " + (e.code || e.message));
          setDbLatency(null);
          addEvent(`Sync Failed: ${e.code || 'Unknown'}`);
        } finally {
          setChecking(false);
        }
      };

      useEffect(() => {
        const on = () => { setOnline("Online"); addEvent("Network: Online"); };
        const off = () => { setOnline("Offline"); addEvent("Network: Offline"); };
        window.addEventListener("online", on);
        window.addEventListener("offline", off);
        
        check();
        const interval = setInterval(() => {
          check();
          setLastClick(window.__lastClick || "None");
        }, 60000); // Check every 60s
        
        return () => {
          window.removeEventListener("online", on);
          window.removeEventListener("offline", off);
          clearInterval(interval);
        };
      }, []);

      const user = auth.currentUser;

      return (
        <div className="fixed bottom-4 right-4 z-[9999] flex flex-col items-end gap-2">
          {showInfo && (
            <div className="bg-slate-900/95 backdrop-blur-2xl border border-white/10 p-6 rounded-[2.5rem] shadow-2xl mb-2 text-[11px] font-medium text-slate-300 min-w-[340px] fade-in animate-slide-up ring-1 ring-white/10">
              <div className="flex items-center justify-between mb-6 pb-4 border-b border-white/5">
                <div className="flex items-center gap-3">
                  <div className="relative">
                    <div className={`w-2.5 h-2.5 rounded-full ${checking ? 'bg-indigo-500 animate-ping' : 'bg-emerald-500'}`}></div>
                    <div className={`absolute inset-0 w-2.5 h-2.5 rounded-full ${checking ? 'bg-indigo-500/50' : 'bg-emerald-500/50'}`}></div>
                  </div>
                  <span className="font-black text-white uppercase tracking-[0.2em]">Command Console</span>
                </div>
                <button onClick={() => setShowInfo(false)} className="w-8 h-8 flex items-center justify-center rounded-xl bg-white/5 text-white/40 hover:bg-rose-500/20 hover:text-rose-400 transition-all">
                  <i className="ph ph-x-bold text-xs"></i>
                </button>
              </div>
              
              <div className="space-y-4">
                <div className="flex justify-between items-center p-3 rounded-2xl bg-white/5 border border-white/5">
                  <span className="text-white/40 font-bold uppercase tracking-widest text-[9px]">Auth Node</span>
                  <span className="font-mono text-[10px] text-indigo-400 truncate max-w-[160px] select-all">
                    {user ? user.email.split('@')[0] : "UNAUTHORIZED"}
                  </span>
                </div>
                
                <div className="grid grid-cols-2 gap-3">
                  <div className="p-3 rounded-2xl bg-white/5 border border-white/5">
                    <div className="text-white/40 font-bold uppercase tracking-widest text-[8px] mb-1">Latency</div>
                    <div className="text-white font-black text-sm tabular-nums">{dbLatency || '--'} <span className="text-[10px] font-medium text-white/20">ms</span></div>
                  </div>
                  <div className="p-3 rounded-2xl bg-white/5 border border-white/5">
                    <div className="text-white/40 font-bold uppercase tracking-widest text-[8px] mb-1">Status</div>
                    <div className={`text-sm font-black ${dbStatus === "Connected" ? "text-emerald-400" : "text-rose-400"}`}>{dbStatus === "Connected" ? "STABLE" : "FAIL"}</div>
                  </div>
                </div>

                <div className="space-y-2">
                  <div className="text-white/40 font-bold uppercase tracking-widest text-[8px] px-1">Session Live Log</div>
                  <div className="bg-black/40 rounded-2xl p-4 border border-white/5 font-mono text-[9px] space-y-2 h-28 overflow-y-auto custom-scrollbar">
                    {sessionEvents.length === 0 && <div className="text-white/20 italic">No events recorded...</div>}
                    {sessionEvents.map((e, i) => (
                      <div key={i} className="flex gap-2">
                        <span className="text-white/20">[{e.time}]</span>
                        <span className={e.msg.includes('Fail') ? 'text-rose-400' : 'text-indigo-400'}>{e.msg}</span>
                      </div>
                    ))}
                  </div>
                </div>

                <div className="pt-2 flex gap-3">
                  <button 
                    onClick={check}
                    disabled={checking}
                    title="重新同步系統狀態"
                    aria-label="重新同步系統狀態"
                    className="flex-1 py-3 bg-indigo-600 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-indigo-700 transition-all active:scale-95 flex items-center justify-center gap-2 disabled:opacity-50 shadow-lg shadow-indigo-900/20"
                  >
                    <i className={`ph ${checking ? 'ph-circle-notch animate-spin' : 'ph-arrows-clockwise-bold'} text-sm`}></i>
                    Sync Node
                  </button>
                  <button 
                    onClick={() => {
                      navigator.clipboard.writeText(JSON.stringify({
                        uid: user?.uid,
                        db: dbStatus,
                        latency: dbLatency,
                        route: window.location.hash,
                        lastAction: lastClick,
                        events: sessionEvents,
                        ua: navigator.userAgent,
                        ts: new Date().toISOString()
                      }, null, 2));
                      addEvent("Report Copied");
                    }}
                    title="複製系統診斷報告"
                    aria-label="複製系統診斷報告"
                    className="w-12 h-12 flex items-center justify-center bg-white/5 text-white/40 rounded-2xl border border-white/5 hover:bg-white/10 hover:text-white transition-all active:scale-95"
                  >
                    <i className="ph ph-copy-bold text-lg"></i>
                  </button>
                </div>
              </div>
            </div>
          )}
          
          <button 
            onClick={() => setShowInfo(!showInfo)}
            title={showInfo ? "隱藏系統狀態面板" : "顯示系統狀態面板"}
            aria-label={showInfo ? "隱藏系統狀態面板" : "顯示系統狀態面板"}
            className={`group flex items-center gap-3 px-5 py-3.5 rounded-[1.5rem] border transition-all active:scale-95 shadow-2xl ${
              showInfo 
                ? 'bg-indigo-600 border-indigo-500 text-white' 
                : 'bg-white/90 backdrop-blur-md border-slate-200 text-slate-400 hover:border-indigo-300'
            }`}
          >
            <div className="flex items-center gap-2.5">
              <div className="relative">
                <span className={`block w-2.5 h-2.5 rounded-full ${online === "Online" && dbStatus === "Connected" ? (showInfo ? "bg-white" : "bg-emerald-500") : "bg-rose-500"}`}></span>
                {online === "Online" && dbStatus === "Connected" && <span className={`absolute inset-0 rounded-full animate-ping opacity-40 ${showInfo ? "bg-white" : "bg-emerald-500"}`}></span>}
              </div>
              <span className={`text-[11px] font-black uppercase tracking-[0.1em] ${showInfo ? 'text-white' : 'text-slate-400 group-hover:text-slate-600'}`}>System Node</span>
            </div>
            <div className={`w-px h-3 ${showInfo ? 'bg-white/20' : 'bg-slate-200'}`}></div>
            <div className="flex items-center gap-2">
              <i className={`ph ph-lightning-fill ${dbStatus === "Connected" ? (showInfo ? "text-white" : "text-amber-400") : "text-rose-400"}`}></i>
              <span className={`text-[11px] font-black tabular-nums ${showInfo ? 'text-white' : (dbStatus === "Connected" ? "text-slate-700" : "text-rose-500")}`}>
                {dbStatus === "Connected" ? (dbLatency ? `${dbLatency}ms` : "Live") : "Error"}
              </span>
            </div>
          </button>
        </div>
      );
    };

    const Footer = () => (
      <footer className="py-8 text-center">
        <p className="text-[10px] text-gray-400 font-medium tracking-widest uppercase">By Owen</p>
      </footer>
    );

    // --- Shell ---
    const Shell = ({ user, children, hideHeader = false }) => {
      if (hideHeader) return <React.Fragment>{children}</React.Fragment>;
      
      return (
        <div className="min-h-screen flex flex-col">
          <header className="sticky top-0 z-[100] bg-white/80 backdrop-blur-xl border-b border-slate-100">
            <div className="app-container py-4 flex items-center justify-between">
              <div className="flex items-center gap-3 cursor-pointer group" onClick={() => navigateHash("/dashboard")}>
                <div className="w-10 h-10 rounded-xl bg-primary group-hover:bg-primary-hover flex items-center justify-center shadow-lg transition-all duration-300 overflow-hidden p-1.5">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 192" className="w-full h-full">
                    <rect width="192" height="192" rx="40" fill="#4F46E5"/>
                    <path d="M60 50h72a10 10 0 0 1 10 10v88a10 10 0 0 1-10 10H60a10 10 0 0 1-10-10V60a10 10 0 0 1 10-10z" fill="#ffffff"/>
                    <path d="M72 76h48" stroke="#4F46E5" stroke-width="10" stroke-linecap="round"/>
                    <path d="M72 100h48" stroke="#4F46E5" stroke-width="10" stroke-linecap="round"/>
                    <path d="M72 124h34" stroke="#4F46E5" stroke-width="10" stroke-linecap="round"/>
                  </svg>
                </div>
                <span className="text-xl font-black text-slate-900 tracking-tight">SurveyLight<span className="text-primary">.</span></span>
              </div>
              
              <div className="flex items-center gap-4 sm:gap-6">
                <div className="hidden sm:flex items-center gap-3 p-1.5 pr-4 rounded-xl bg-slate-50 border border-slate-100">
                  <div className="w-8 h-8 rounded-lg overflow-hidden border border-white">
                    {user?.photoURL ? (
                      <img src={user.photoURL} alt={user.displayName} className="w-full h-full object-cover" />
                    ) : (
                      <i className="ph ph-user-circle-fill text-2xl text-slate-200"></i>
                    )}
                  </div>
                  <span className="text-sm font-bold text-slate-700">{user?.displayName || "使用者"}</span>
                </div>
                <button 
                  onClick={() => auth.signOut()} 
                  className="w-10 h-10 flex items-center justify-center rounded-xl text-slate-400 hover:text-rose-500 hover:bg-rose-50 transition-all"
                  title="登出帳號"
                  aria-label="登出帳號"
                >
                  <i className="ph ph-sign-out-bold text-xl"></i>
                </button>
              </div>
            </div>
          </header>
          <main className="flex-1">
            {children}
          </main>
        </div>
      );
    };

    // --- App ---
    const App = () => {
      const [user, setUser] = useState(null);
      const [route, setRoute] = useState(getHashRoute());
      const [activeSurveyId, setActiveSurveyId] = useState(null);
      const [booting, setBooting] = useState(true);
      const [authLoading, setAuthLoading] = useState(true);
      const [isInAppBrowser, setIsInAppBrowser] = useState(false);
      const [globalToast, setGlobalToast] = useState(null);
      
      // Global Deletion State
      const [deleteTarget, setDeleteTarget] = useState(null);
      const [isDeleting, setIsDeleting] = useState(false);

      const confirmDeleteGlobal = async () => {
        const id = deleteTarget;
        if (!id || isDeleting) return;
        setIsDeleting(true);
        console.log("GLOBAL: Deleting survey:", id);
        try {
          const rSnap = await db.collection("responses")
            .where("surveyId", "==", id)
            .where("surveyCreatorId", "==", user.uid)
            .get();
          const ops = rSnap.docs.map(d => (batch => batch.delete(d.ref)));
          ops.push(batch => batch.delete(db.collection("surveys").doc(id)));
          await commitBatches(ops, "global-delete-" + id);
          setGlobalToast({ message: "問卷及其數據已成功移除", type: "success" });
          setDeleteTarget(null);
          // Notify dashboard to refresh
          window.dispatchEvent(new CustomEvent('survey-deleted', { detail: id }));
        } catch (err) {
          console.error("GLOBAL: Delete failed", err);
          setGlobalToast({ message: "刪除失敗：" + (err.message || "權限不足"), type: "error" });
        } finally {
          setIsDeleting(false);
        }
      };

      // --- Lifecycle Logs ---
      useEffect(() => {
        console.log("APP: Component mounted. Current route:", getHashRoute());
        checkFirebaseStatus().then(status => {
          console.log("APP: Firebase diagnostic result:", status);
        });
      }, []);

      // 檢測是否為 App 內建瀏覽器 (LINE, FB, Messenger, etc.)
      useEffect(() => {
        const ua = navigator.userAgent || navigator.vendor || window.opera;
        const isInApp = /Line|FBAN|FBAV|Instagram|Messenger/.test(ua);
        setIsInAppBrowser(isInApp);
      }, []);

      // 處理 Firebase Redirect 登入結果
      useEffect(() => {
        const handleRedirect = async () => {
          try {
            const result = await auth.getRedirectResult();
            if (result && result.user) {
              console.log("Redirect login success:", result.user.email);
              setUser(result.user);
              // 成功登入後，主動導向儀表板
              if (getHashRoute() === "/login" || getHashRoute() === "/") {
                navigateHash("/dashboard");
              }
            }
          } catch (error) {
            console.error("Redirect login error:", error);
            if (error.code === 'auth/unauthorized-domain') {
              setGlobalToast({ message: mapAuthErrorToZh(error), type: "error" });
            }
          } finally {
            // 延遲一點點關閉 authLoading，確保狀態同步
            setTimeout(() => setAuthLoading(false), 100);
          }
        };
        handleRedirect();
      }, []);

      // 1) Public mode: ?s={surveyId} 無需登入
      const publicSurveyId = useMemo(() => {
        const params = new URLSearchParams(window.location.search);
        return params.get("s");
      }, []);

      // 2) Public Analytics Mode
      const publicToken = useMemo(() => {
        const r = getHashRoute();
        if (r.startsWith("/analytics/public/")) {
          return r.replace("/analytics/public/", "");
        }
        return null;
      }, [route]);

      useEffect(() => {
        const onHashChange = () => setRoute(getHashRoute());
        window.addEventListener("hashchange", onHashChange);
        return () => window.removeEventListener("hashchange", onHashChange);
      }, []);

      useEffect(() => {
        // Hide boot-loading once React is alive
        const bootEl = document.getElementById("boot-loading");
        if (bootEl) bootEl.style.display = "none";
        setBooting(false);
      }, []);

      useEffect(() => {
        // PWA: register service worker (best-effort)
        if (!("serviceWorker" in navigator)) return;
        const isLocalhost = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1";
        // GitHub Pages 與 localhost 都可註冊；失敗就忽略（不影響主功能）
        navigator.serviceWorker.register("./sw.js").catch((err) => {
          console.warn("Service worker 註冊失敗：", err);
          if (isLocalhost) {
            // localhost 才提示，避免正式站干擾
            console.warn("（本機提示）若你用 file:// 開啟，SW 會無法註冊，請用 http server。");
          }
        });
      }, []);

      useEffect(() => {
        if (publicSurveyId || publicToken) return; // public mode 不用等 auth
        const unsub = auth.onAuthStateChanged(
          (u) => {
            setUser(u);
            if (!u) {
              // 只有在非 redirect 處理中，才跳轉登入
              if (!authLoading) navigateHash("/login");
            } else {
              if (getHashRoute() === "/" || getHashRoute() === "/login") navigateHash("/dashboard");
            }
          },
          (err) => {
            console.error("Auth State Error:", err);
            if (!authLoading) navigateHash("/login");
          }
        );
        return () => unsub();
      }, [publicSurveyId, authLoading]);

      if (booting || (authLoading && !publicSurveyId && !publicToken)) return <Loading text="正在確認身分..." />;

      const renderContent = () => {
        if (publicSurveyId) return <TakeSurvey surveyId={publicSurveyId} />;
        if (publicToken) return <Analytics surveyId={null} user={null} onBack={null} publicToken={publicToken} />;
        if (isInAppBrowser && !publicSurveyId) return <InAppBrowserNotice />;
        if (!user) return <LoginView />;
        
        const current = route;
        let content;
        
        if (current === "/create") {
          content = <CreateSurvey user={user} onBack={() => navigateHash("/dashboard")} />;
        } else if (current.startsWith("/preview/")) {
          const sid = current.replace("/preview/", "");
          content = <TakeSurvey surveyId={sid} isPreview={true} />;
        } else if (current.startsWith("/analytics")) {
          const parts = current.split("/");
          let sid = parts.length >= 3 && parts[2] ? parts[2] : activeSurveyId;
          if (!sid) {
            content = (
              <div className="max-w-xl mx-auto p-12 text-center">
                <div className="w-20 h-20 bg-rose-50 text-rose-500 rounded-3xl flex items-center justify-center mx-auto mb-6">
                  <i className="ph ph-warning-bold text-4xl"></i>
                </div>
                <h3 className="text-2xl font-black text-slate-900 mb-4">找不到問卷 ID</h3>
                <p className="text-slate-500 mb-8 font-medium">請從儀表板點擊「數據分析中心」進入。</p>
                <Button onClick={() => navigateHash("/dashboard")}>返回儀表板</Button>
              </div>
            );
          } else {
            content = <Analytics surveyId={sid} user={user} onBack={() => navigateHash("/dashboard")} />;
          }
        } else {
          content = <Dashboard user={user} onCreate={() => navigateHash("/create")} onAnalytics={onAnalytics} onDelete={setDeleteTarget} />;
        }

        return <Shell user={user}>{content}</Shell>;
      };

      const onAnalytics = (sid) => {
        console.log("APP: onAnalytics requested for sid:", sid);
        if (!sid) {
          setGlobalToast({ message: "錯誤：無效的問卷 ID", type: "error" });
          return;
        }
        // 僅修改 Hash，讓 hashchange 監聽器統一處理路由狀態更新
        const targetHash = "#/analytics/" + sid;
        console.log("APP: Navigating to hash:", targetHash);
        window.location.hash = targetHash;
        // 備用：確保 activeSurveyId 也更新
        setActiveSurveyId(sid);
      };

      return (
      <React.Fragment>
        {/* Floating Background Micro-interactions */}
        <div className="floating-bg">
          <div className="blob" style={{ top: '-10%', left: '-10%', animationDelay: '0s' }}></div>
          <div className="blob" style={{ top: '60%', left: '70%', animationDelay: '-5s', width: '500px', height: '500px', background: 'linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(165, 180, 252, 0.05) 100%)' }}></div>
          <div className="blob" style={{ top: '20%', left: '80%', animationDelay: '-10s', width: '400px', height: '400px', background: 'linear-gradient(135deg, rgba(244, 63, 94, 0.03) 0%, rgba(251, 113, 133, 0.03) 100%)' }}></div>
        </div>

        {/* Global Deletion Modal */}
          {deleteTarget && (
            <Modal
              title="確認刪除問卷？"
              onClose={() => !isDeleting && setDeleteTarget(null)}
              footer={
                <div className="flex gap-4 w-full">
                  <Button variant="ghost" className="flex-1 py-4" onClick={() => setDeleteTarget(null)} disabled={isDeleting}>
                    取消
                  </Button>
                  <button
                    onClick={confirmDeleteGlobal}
                    disabled={isDeleting}
                    className="flex-1 py-4 bg-rose-600 text-white rounded-2xl font-black hover:bg-rose-700 transition-all active:scale-95 disabled:opacity-50 flex items-center justify-center gap-2"
                  >
                    {isDeleting ? <span className="spinner w-5 h-5 border-white/20 border-l-white"></span> : <i className="ph ph-trash-bold text-xl"></i>}
                    {isDeleting ? "正在刪除..." : "確認永久刪除"}
                  </button>
                </div>
              }
            >
              <div className="text-center p-4">
                <div className="w-20 h-20 bg-rose-50 text-rose-500 rounded-[2rem] flex items-center justify-center mx-auto mb-6">
                  <i className="ph ph-warning-bold text-4xl"></i>
                </div>
                <h4 className="text-xl font-black text-slate-900 mb-2">這項操作無法復原</h4>
                <p className="text-slate-500 font-medium leading-relaxed">
                  刪除問卷後，所有收集到的回覆數據也將一併被永久移除。
                </p>
              </div>
            </Modal>
          )}

          {globalToast && <Toast message={globalToast.message} type={globalToast.type} onClose={() => setGlobalToast(null)} />}
          
          <main className="min-h-screen">
            {renderContent()}
          </main>
          
          <Footer />
          <DebugStatus user={user} lastClick={window.__lastClick} />
        </React.Fragment>
      );
    };

    const rootEl = document.getElementById("root");
    const root = ReactDOM.createRoot(rootEl);
    root.render(<App />);
  </script>
</body>
</html>

