<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SurveyLight | 輕量級問卷平台</title>
  <meta name="theme-color" content="#2563eb" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="SurveyLight" />
  <link rel="manifest" href="./manifest.webmanifest" />

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel Standalone (CDN) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase Compat CDN (避免 ES Module / 子目錄路徑問題) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <!-- Phosphor Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    :root {
      --primary: #4F46E5;
      --primary-hover: #4338CA;
      --bg: #F8FAFC;
    }

    html, body { height: 100%; }
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
      background-color: var(--bg); 
      color: #1E293B;
      overflow-x: hidden; 
    }

    /* Smooth transitions */
    * { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }

    .spinner { 
      border: 3px solid rgba(79, 70, 229, 0.1); 
      width: 40px; 
      height: 40px; 
      border-radius: 50%; 
      border-left-color: var(--primary); 
      animation: spin 0.8s linear infinite; 
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .fade-in-up { animation: fadeInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes fadeInUp { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }

    /* Glassmorphism */
    .glass {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
    }

    .shake {
      animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
    }
    @keyframes shake {
      10%, 90% { transform: translate3d(-1px, 0, 0); }
      20%, 80% { transform: translate3d(2px, 0, 0); }
      30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
      40%, 60% { transform: translate3d(4px, 0, 0); }
    }

    /* Input styling */
    .input-elegant {
      @apply w-full bg-white/60 border border-slate-200 rounded-2xl px-5 py-4 focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all duration-300 placeholder:text-slate-300 font-medium;
    }

    /* Card styling */
    .card-modern {
      @apply bg-white rounded-[2.5rem] border border-slate-100 shadow-sm hover:shadow-xl hover:shadow-indigo-500/5 hover:-translate-y-1 transition-all duration-500;
    }

    /* Custom Button Animation */
    .btn-hover-effect {
      position: relative;
      overflow: hidden;
    }
    .btn-hover-effect::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s ease-out, height 0.6s ease-out;
    }
    .btn-hover-effect:hover::after {
      width: 300%;
      height: 300%;
    }
    /* Responsive Adjustments */
    @media (max-width: 640px) {
      .card-modern { @apply rounded-[2rem] p-6; }
      .glass { @apply rounded-[2rem] p-6; }
      h1 { @apply text-3xl; }
      .text-5xl { @apply text-3xl; }
      .text-4xl { @apply text-2xl; }
    }
  </style>
</head>
<body>
  <!-- 避免 React 載入前白屏 -->
  <div id="boot-loading" class="min-h-screen flex items-center justify-center p-6">
    <div class="bg-white rounded-2xl shadow-lg p-8 w-full max-w-sm text-center">
      <div class="spinner mx-auto mb-4"></div>
      <div class="text-gray-800 font-bold text-lg">SurveyLight</div>
      <div class="text-gray-500 text-sm mt-1">載入中...</div>
    </div>
  </div>
  <div id="root"></div>

  <!-- 全域錯誤捕捉：任何致命錯誤都直接顯示在畫面上方便除錯 -->
  <div id="global-error-overlay" class="hidden fixed inset-0 z-[9999] bg-black/50 p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-3xl mx-auto p-4 border border-red-200">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-red-600 font-bold text-lg">發生未預期的錯誤</div>
          <div class="text-gray-500 text-xs mt-1">請按 F12 開啟開發者工具查看 Console，並將此畫面截圖回報。</div>
        </div>
        <button id="global-error-close" class="text-gray-500 hover:text-gray-800">
          <i class="ph ph-x text-xl"></i>
        </button>
      </div>
      <pre id="global-error-text" class="mt-3 text-sm whitespace-pre-wrap break-words bg-red-50 text-red-700 p-3 rounded-lg overflow-auto max-h-[60vh]"></pre>
    </div>
  </div>
  <script>
    (function () {
      const overlay = document.getElementById('global-error-overlay');
      const closeBtn = document.getElementById('global-error-close');
      const textEl = document.getElementById('global-error-text');

      function showGlobalError(payload) {
        try {
          textEl.textContent = payload;
          overlay.classList.remove('hidden');
        } catch (e) {
          // fallback
          alert(payload);
        }
      }

      closeBtn.addEventListener('click', function () {
        overlay.classList.add('hidden');
      });

      window.__showGlobalError = showGlobalError;

      window.onerror = function (message, source, lineno, colno, error) {
        const detail = [
          `訊息: ${message}`,
          `來源: ${source}:${lineno}:${colno}`,
          error && error.stack ? `Stack:\n${error.stack}` : ''
        ].filter(Boolean).join('\n');
        console.error("Global Error:", message, error);
        showGlobalError(detail);
        return false;
      };

      window.onunhandledrejection = function (event) {
        const reason = event && event.reason ? event.reason : event;
        console.error("Unhandled Rejection:", reason);
        const detail = typeof reason === 'string'
          ? reason
          : (reason && reason.stack) ? reason.stack : JSON.stringify(reason, null, 2);
        showGlobalError(`Promise 未處理錯誤:\n${detail}`);
      };
    })();
  </script>

  <script type="text/babel" data-presets="react,env">
    const { useEffect, useMemo, useRef, useState } = React;

    // --- Firebase Configuration (依需求直接嵌入) ---
    const firebaseConfig = {
      apiKey: "AIzaSyCkpv2OVqWkY9weBhCDholL8cgulJkDrgw",
      authDomain: "survey-light.firebaseapp.com",
      projectId: "survey-light",
      storageBucket: "survey-light.firebasestorage.app",
      messagingSenderId: "319145934342",
      appId: "1:319145934342:web:55a411eb01d8e2512a8d87",
      measurementId: "G-8Z1PNB2ZH8"
    };

    function safeNow() { return Date.now(); }
    function ms30Days() { return 30 * 24 * 60 * 60 * 1000; }

    // Initialize Firebase
    if (!firebase.apps.length) {
      try {
        firebase.initializeApp(firebaseConfig);
      } catch (e) {
        console.error("Firebase init error:", e);
        window.__showGlobalError?.("Firebase 初始化失敗：\n" + (e && e.stack ? e.stack : e.message));
      }
    }
    const auth = firebase.auth();
    const db = firebase.firestore();
    auth.useDeviceLanguage();

    // --- UI Primitives ---
    const Button = ({ children, onClick, variant = "primary", className = "", disabled = false, type = "button" }) => {
      const base = "px-6 py-3.5 rounded-2xl font-bold transition-all flex items-center justify-center gap-2 active:scale-95 disabled:opacity-50 disabled:pointer-events-none btn-hover-effect shadow-lg";
      const variants = {
        primary: "bg-indigo-600 text-white hover:bg-indigo-700 shadow-indigo-200/50 hover:shadow-indigo-300/60",
        secondary: "bg-white text-slate-700 border-2 border-slate-100 hover:border-indigo-600 hover:text-indigo-600 shadow-slate-100",
        danger: "bg-rose-50 text-rose-600 hover:bg-rose-600 hover:text-white shadow-rose-100",
        outline: "border-2 border-slate-100 text-slate-500 hover:border-indigo-600 hover:text-indigo-600 bg-transparent",
      };
      return (
        <button type={type} onClick={onClick} disabled={disabled} className={`${base} ${variants[variant]} ${className}`}>
          {children}
        </button>
      );
    };

    const Loading = ({ text = "載入中..." }) => (
      <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-slate-50/50 backdrop-blur-sm">
        <div className="glass p-12 rounded-[3.5rem] text-center max-w-sm w-full relative overflow-hidden">
          <div className="absolute top-0 left-0 w-full h-1 bg-slate-100">
            <div className="h-full bg-indigo-600 animate-[loading_1.5s_infinite_ease-in-out]"></div>
          </div>
          <style>{`
            @keyframes loading {
              0% { width: 0; left: 0; }
              50% { width: 70%; left: 15%; }
              100% { width: 0; left: 100%; }
            }
          `}</style>
          <div className="spinner mx-auto mb-8 border-l-indigo-600 w-16 h-16 border-4"></div>
          <div className="text-slate-800 font-black text-2xl tracking-tight mb-2">{text}</div>
          <div className="text-indigo-600/40 text-[10px] font-black uppercase tracking-[0.3em]">SurveyLight Engine</div>
        </div>
      </div>
    );

    const Notice = ({ variant = "info", children }) => {
      const styles = {
        info: "bg-indigo-50/80 text-indigo-700 border-indigo-100/50 shadow-indigo-500/5",
        danger: "bg-rose-50/80 text-rose-700 border-rose-100/50 shadow-rose-500/5",
        success: "bg-emerald-50/80 text-emerald-700 border-emerald-100/50 shadow-emerald-500/5",
        warn: "bg-amber-50/80 text-amber-800 border-amber-100/50 shadow-amber-500/5",
      };
      const icon = {
        info: "ph-info",
        danger: "ph-warning-circle",
        success: "ph-check-circle",
        warn: "ph-warning",
      }[variant];
      return (
        <div className={`${styles[variant]} backdrop-blur-md border-2 px-6 py-4 rounded-[1.5rem] text-sm font-bold flex items-start gap-4 fade-in shadow-xl`}>
          <div className="w-8 h-8 rounded-xl bg-white/50 flex items-center justify-center flex-shrink-0">
            <i className={`ph ${icon} text-xl`}></i>
          </div>
          <div className="min-w-0 flex-1 pt-1.5">{children}</div>
        </div>
      );
    };

    const Toast = ({ message, onClose }) => {
      useEffect(() => {
        const timer = setTimeout(onClose, 3000);
        return () => clearTimeout(timer);
      }, [onClose]);

      return (
        <div className="fixed bottom-10 left-1/2 -translate-x-1/2 z-[9999] fade-in-up">
          <div className="bg-slate-900/90 backdrop-blur-xl text-white px-8 py-4 rounded-[2rem] shadow-2xl flex items-center gap-4 border-2 border-white/10">
            <div className="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center">
              <i className="ph ph-check-bold text-white"></i>
            </div>
            <span className="font-black text-sm tracking-wide">{message}</span>
          </div>
        </div>
      );
    };

    const Modal = ({ title, children, onClose, footer }) => (
      <div className="fixed inset-0 z-[1000] p-4 flex items-center justify-center">
        <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-xl transition-all duration-500" onClick={onClose}></div>
        <div className="relative bg-white/90 backdrop-blur-2xl rounded-[3rem] shadow-[0_32px_64px_-12px_rgba(0,0,0,0.15)] w-full max-w-2xl overflow-hidden fade-in border border-white">
          <div className="flex items-center justify-between p-8 border-b border-slate-50/50">
            <h3 className="font-black text-slate-900 text-2xl tracking-tight">{title}</h3>
            <button onClick={onClose} className="w-12 h-12 flex items-center justify-center rounded-2xl bg-slate-50 text-slate-400 hover:bg-rose-50 hover:text-rose-600 transition-all duration-300">
              <i className="ph ph-x text-2xl"></i>
            </button>
          </div>
          <div className="p-8 max-h-[75vh] overflow-auto custom-scrollbar">
            {children}
          </div>
          {footer && <div className="p-8 bg-slate-50/30 backdrop-blur-md flex justify-end gap-4 border-t border-slate-50/50">{footer}</div>}
        </div>
      </div>
    );

    // --- Routing ---
    // 部署在 GitHub Pages 子路徑（/SurveyLight/）時，建議用 hash 路由避免 404。
    // Public Respondent View 仍然使用 URL 參數 ?s=surveyId（依需求）。
    function getHashRoute() {
      const raw = (window.location.hash || "").replace(/^#/, "");
      const route = raw.startsWith("/") ? raw : (raw ? "/" + raw : "/");
      return route;
    }
    function navigateHash(route) {
      const r = route.startsWith("/") ? route : "/" + route;
      window.location.hash = r;
    }

    // --- Auth / Errors ---
    function mapAuthErrorToZh(err) {
      const code = err && err.code;
      if (code === "auth/popup-blocked") return "登入視窗被瀏覽器封鎖，請允許彈跳視窗後重試。";
      if (code === "auth/unauthorized-domain") return `網域授權錯誤：此網域未被 Firebase 授權。\n請到 Firebase Console → Authentication → Settings → Authorized domains 新增：${window.location.hostname}`;
      if (code === "auth/operation-not-allowed") return "此專案尚未啟用 Google 登入方式，請到 Firebase Console 啟用 Google Provider。";
      return (err && err.message) ? err.message : "登入失敗，請稍後再試。";
    }

    // --- Firestore helpers ---
    async function commitBatches(ops, label = "batch") {
      // Firestore batch 每批最多 500 ops；這裡自動分批。
      const MAX = 450; // 留一些 buffer，避免未來擴充時踩到 500
      let idx = 0;
      while (idx < ops.length) {
        const batch = db.batch();
        const slice = ops.slice(idx, idx + MAX);
        slice.forEach(fn => fn(batch));
        await batch.commit();
        idx += slice.length;
        console.log(`[${label}] committed ${idx}/${ops.length}`);
      }
    }

    // --- Views ---
    const InAppBrowserNotice = () => {
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      return (
        <div className="min-h-screen flex items-center justify-center p-6 bg-slate-50 bg-[radial-gradient(circle_at_top_right,rgba(79,70,229,0.05),transparent),radial-gradient(circle_at_bottom_left,rgba(79,70,229,0.05),transparent)]">
          <div className="bg-white/80 backdrop-blur-2xl p-12 rounded-[3.5rem] shadow-2xl shadow-slate-200/50 w-full max-w-md text-center border border-white fade-in relative overflow-hidden">
            <div className="absolute top-0 right-0 w-32 h-32 bg-indigo-50/50 rounded-full -mr-16 -mt-16"></div>
            
            <div className="w-28 h-28 bg-indigo-600 text-white rounded-[2.5rem] flex items-center justify-center mx-auto mb-10 shadow-2xl shadow-indigo-200 rotate-3">
              <i className="ph ph-browser text-6xl"></i>
            </div>
            
            <h2 className="text-3xl font-black text-slate-900 mb-4 tracking-tight leading-tight">請使用瀏覽器開啟</h2>
            <p className="text-slate-500 font-medium mb-10 leading-relaxed">
              為了您的帳號安全，Google 不允許在 LINE 或 Facebook 等內建瀏覽器中登入。
            </p>
            
            <div className="space-y-6">
              <div className="p-8 bg-slate-50/50 rounded-[2.5rem] text-left border border-slate-100/50 backdrop-blur-sm">
                <p className="text-slate-900 font-black text-sm mb-6 flex items-center gap-3">
                  <span className="w-8 h-8 bg-indigo-600 text-white rounded-xl flex items-center justify-center">
                    <i className="ph ph-list-numbers text-xl"></i>
                  </span>
                  操作步驟：
                </p>
                <ol className="text-slate-600 font-bold text-sm space-y-4 ml-1">
                  <li className="flex gap-4 items-center">
                    <span className="flex-shrink-0 w-6 h-6 bg-white text-indigo-600 rounded-lg text-xs flex items-center justify-center font-black shadow-sm border border-indigo-50">1</span>
                    點擊右上角的 <span className="px-2 py-1 bg-white rounded-lg shadow-sm border border-slate-100 text-slate-900 mx-1">「⋯」</span>
                  </li>
                  <li className="flex gap-4 items-center">
                    <span className="flex-shrink-0 w-6 h-6 bg-white text-indigo-600 rounded-lg text-xs flex items-center justify-center font-black shadow-sm border border-indigo-50">2</span>
                    選擇 <span className="px-2 py-1 bg-white rounded-lg shadow-sm border border-slate-100 text-slate-900 mx-1">「在瀏覽器開啟」</span>
                  </li>
                </ol>
              </div>
              
              <div className="flex items-center justify-center gap-4 text-slate-400 font-black text-[10px] uppercase tracking-[0.2em] pt-4">
                <div className="h-px flex-1 bg-slate-100"></div>
                推薦使用 {isIOS ? "Safari" : "Chrome"}
                <div className="h-px flex-1 bg-slate-100"></div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const LoginView = () => {
      const [error, setError] = useState(null);
      const [loading, setLoading] = useState(false);
      const handleGoogleLogin = async () => {
        setLoading(true);
        setError(null);
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
          await auth.signInWithPopup(provider);
        } catch (err) {
          console.error("Login Error:", err);
          if (err.code === "auth/popup-blocked") {
            try {
              await auth.signInWithRedirect(provider);
            } catch (reErr) {
              setError(mapAuthErrorToZh(reErr));
              setLoading(false);
            }
          } else {
            setError(mapAuthErrorToZh(err));
            setLoading(false);
          }
        }
      };
      return (
        <div className="min-h-screen flex items-center justify-center p-6 bg-[#F8FAFC] bg-[radial-gradient(circle_at_top_right,rgba(79,70,229,0.08),transparent_50%),radial-gradient(circle_at_bottom_left,rgba(79,70,229,0.08),transparent_50%)]">
          <div className="bg-white/70 backdrop-blur-3xl p-12 rounded-[4rem] shadow-[0_32px_64px_-12px_rgba(79,70,229,0.15)] w-full max-w-md text-center border border-white/50 fade-in relative overflow-hidden">
            {/* Background decorative elements */}
            <div className="absolute -top-24 -left-24 w-48 h-48 bg-indigo-500/5 rounded-full blur-3xl"></div>
            <div className="absolute -bottom-24 -right-24 w-48 h-48 bg-indigo-500/5 rounded-full blur-3xl"></div>
            
            <div className="relative">
              <div className="relative w-36 h-36 mx-auto mb-12 group">
                {/* Outer glowing ring */}
                <div className="absolute -inset-4 bg-indigo-500/10 rounded-full blur-2xl group-hover:bg-indigo-500/20 transition-all duration-1000"></div>
                
                {/* Main Logo Container */}
                <div className="relative w-full h-full bg-slate-900 rounded-[2.8rem] flex items-center justify-center shadow-[0_20px_50px_rgba(30,41,59,0.3)] overflow-hidden group-hover:-translate-y-2 transition-transform duration-700">
                  {/* Abstract Paper Lines in Background */}
                  <div className="absolute inset-0 opacity-10">
                    <div className="absolute top-8 left-8 right-8 h-1 bg-white rounded-full"></div>
                    <div className="absolute top-14 left-8 right-16 h-1 bg-white rounded-full"></div>
                    <div className="absolute top-20 left-8 right-12 h-1 bg-white rounded-full"></div>
                  </div>
                  
                  {/* Floating Elements */}
                  <div className="relative">
                    {/* The "Light" Sparkle */}
                    <div className="absolute -top-8 -right-8 w-16 h-16 bg-indigo-500/30 blur-xl animate-pulse"></div>
                    
                    {/* Survey Paper Icon */}
                    <div className="relative z-10 w-16 h-20 bg-white rounded-lg shadow-xl flex flex-col p-3 gap-2 -rotate-6 group-hover:rotate-0 transition-transform duration-700">
                      <div className="w-full h-1.5 bg-indigo-100 rounded-full"></div>
                      <div className="w-3/4 h-1.5 bg-indigo-100 rounded-full"></div>
                      <div className="mt-auto flex items-center justify-center w-full h-8 bg-indigo-600 rounded-md shadow-lg shadow-indigo-200">
                        <i className="ph ph-check-bold text-white text-xl"></i>
                      </div>
                    </div>
                    
                    {/* Decorative Lightning for "Light" */}
                    <i className="ph ph-lightning-fill text-indigo-400 text-3xl absolute -bottom-4 -left-6 rotate-12 drop-shadow-[0_0_10px_rgba(129,140,248,0.8)]"></i>
                  </div>
                </div>
              </div>
              <h1 className="text-4xl font-black text-slate-900 mb-3 tracking-tighter">SurveyLight</h1>
              <p className="text-slate-400 font-bold mb-12 tracking-wide text-sm uppercase">讓問卷收集變得輕而易舉</p>
              
              {error && <div className="mb-8"><Notice variant="danger">{error}</Notice></div>}
              
              <button 
                onClick={handleGoogleLogin} 
                disabled={loading} 
                className="w-full bg-white border-2 border-slate-100 hover:border-indigo-600 hover:shadow-xl hover:shadow-indigo-500/10 py-5 rounded-[2rem] font-black text-slate-700 transition-all duration-500 flex items-center justify-center gap-4 group active:scale-95 disabled:opacity-50"
              >
                {loading ? (
                  <span className="spinner w-6 h-6 border-4 border-indigo-600/20 border-l-indigo-600"></span>
                ) : (
                  <>
                    <div className="w-8 h-8 bg-white rounded-xl shadow-sm border border-slate-50 flex items-center justify-center group-hover:scale-110 transition-transform">
                      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-5 h-5" />
                    </div>
                    <span>使用 Google 帳號登入</span>
                  </>
                )}
              </button>
              
              <div className="mt-16 pt-10 border-t border-slate-100/50 flex flex-col items-center gap-4">
                <div className="flex gap-2">
                  <div className="w-2 h-2 rounded-full bg-indigo-600 animate-bounce"></div>
                  <div className="w-2 h-2 rounded-full bg-indigo-400 animate-bounce [animation-delay:0.2s]"></div>
                  <div className="w-2 h-2 rounded-full bg-indigo-200 animate-bounce [animation-delay:0.4s]"></div>
                </div>
                <p className="text-[10px] text-slate-300 font-black uppercase tracking-[0.4em]">Powered by Firebase</p>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const Dashboard = ({ user, onCreate, onAnalytics }) => {
      const [surveys, setSurveys] = useState([]);
      const [totalResponsesCount, setTotalResponsesCount] = useState(0);
      const [loading, setLoading] = useState(true);
      const [cleanupStatus, setCleanupStatus] = useState(null);
      const [toast, setToast] = useState(null);
      const [deleteTarget, setDeleteTarget] = useState(null);
      const [searchTerm, setSearchTerm] = useState("");

      const filteredSurveys = useMemo(() => {
        if (!searchTerm.trim()) return surveys;
        const term = searchTerm.toLowerCase();
        return surveys.filter(s => 
          (s.title || "").toLowerCase().includes(term) || 
          (s.description || "").toLowerCase().includes(term)
        );
      }, [surveys, searchTerm]);

      useEffect(() => {
        let cancelled = false;
        const run = async () => {
          setLoading(true);
          setCleanupStatus(null);
          try {
            // Fetch surveys
            const snap = await db.collection("surveys").where("creatorId", "==", user.uid).get();
            let data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            data.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

            // Fetch total responses count
            const respSnapAll = await db.collection("responses")
              .where("surveyCreatorId", "==", user.uid)
              .get();
            
            if (!cancelled) setTotalResponsesCount(respSnapAll.size);

            // Auto-Cleanup：刪除該使用者名下超過 30 天的「問卷」與「回覆」
            const threshold = safeNow() - ms30Days();
            const oldSurveys = data.filter(s => (s.createdAt || 0) < threshold);
            const oldResponseDocs = respSnapAll.docs.filter(d => (d.data().submittedAt || 0) < threshold);

            const ops = [];
            oldResponseDocs.forEach(d => ops.push((batch) => batch.delete(d.ref)));
            oldSurveys.forEach(s => ops.push((batch) => batch.delete(db.collection("surveys").doc(s.id))));

            if (ops.length > 0) {
              await commitBatches(ops, "auto-cleanup");
              setCleanupStatus(`已自動清理：過期回覆 ${oldResponseDocs.length} 筆、過期問卷 ${oldSurveys.length} 筆（>30 天）`);
              // Update local count after cleanup
              if (!cancelled) setTotalResponsesCount(prev => prev - oldResponseDocs.length);
            }

            // 更新列表（移除過期問卷）
            data = data.filter(s => (s.createdAt || 0) >= threshold);
            if (!cancelled) setSurveys(data);
          } catch (err) {
            console.error("Dashboard error:", err);
            setToast({ message: "載入儀表板失敗：" + (err && err.message ? err.message : String(err)), type: "error" });
          } finally {
            if (!cancelled) setLoading(false);
          }
        };
        run();
        return () => { cancelled = true; };
      }, [user.uid]);

      const getPublicSurveyUrl = (id, title) => {
        // 使用 URL 物件來確保路徑解析正確，避免在不同環境下（如 GitHub Pages 或本地 file://）出現雙重路徑問題
        const url = new URL(window.location.href.split('?')[0].split('#')[0]);
        url.searchParams.set("s", id);
        if (title) {
          url.searchParams.set("t", title);
        }
        return url.toString();
      };

      const shareSurvey = async (survey) => {
        const url = getPublicSurveyUrl(survey.id, survey.title);
        const title = `SurveyLight｜${survey.title || "問卷"}`;
        const text = `我想邀請你填寫問卷：${survey.title || "（未命名）"}\n點此開啟：${url}`;

        if (navigator.share) {
          try {
            await navigator.share({ title, text, url });
            return;
          } catch (e) {
            console.warn("share cancelled or failed:", e);
          }
        }

        try {
          await navigator.clipboard.writeText(url);
          setToast({ message: "已複製問卷連結", type: "success" });
        } catch (e) {
          setToast({ message: "複製失敗，請手動複製", type: "error" });
        }
      };

      const deleteSurvey = async (id) => {
        setDeleteTarget(id);
      };

      const confirmDelete = async () => {
        const id = deleteTarget;
        setDeleteTarget(null);
        try {
          const rSnap = await db.collection("responses").where("surveyId", "==", id).get();
          const ops = [];
          rSnap.docs.forEach(d => ops.push((batch) => batch.delete(d.ref)));
          ops.push((batch) => batch.delete(db.collection("surveys").doc(id)));
          await commitBatches(ops, "delete-survey");
          setSurveys(prev => prev.filter(s => s.id !== id));
          setToast({ message: "問卷已成功刪除", type: "success" });
        } catch (err) {
          setToast({ message: "刪除失敗：" + (err.message || "未知錯誤"), type: "error" });
        }
      };

      const duplicateSurvey = async (survey) => {
        try {
          setLoading(true);
          const newSurvey = {
            ...survey,
            title: `${survey.title || "未命名問卷"} (副本)`,
            createdAt: safeNow(),
            active: true
          };
          delete newSurvey.id; // Let Firestore generate a new ID
          const docRef = await db.collection("surveys").add(newSurvey);
          const createdSurvey = { id: docRef.id, ...newSurvey };
          setSurveys(prev => [createdSurvey, ...prev]);
          setToast({ message: "已成功複製問卷副本", type: "success" });
        } catch (err) {
          setToast({ message: "複製失敗：" + (err.message || "未知錯誤"), type: "error" });
        } finally {
          setLoading(false);
        }
      };

      if (loading) return <Loading text="正在整理您的儀表板..." />;

      // Calculate simple stats
      const totalSurveys = surveys.length;
      const totalActive = surveys.filter(s => s.active).length;

      return (
        <div className="max-w-7xl mx-auto p-6 sm:p-12 fade-in pb-32">
          {toast && <Toast message={toast.message} onClose={() => setToast(null)} />}
        
        {deleteTarget && (
          <Modal onClose={() => setDeleteTarget(null)}>
            <div className="text-center p-8">
              <div className="w-24 h-24 bg-rose-50 text-rose-500 rounded-[2.5rem] flex items-center justify-center mx-auto mb-8 shadow-xl shadow-rose-100">
                <i className="ph ph-trash-fill text-5xl"></i>
              </div>
              <h2 className="text-3xl font-black text-slate-900 mb-4 tracking-tight">確定要刪除嗎？</h2>
              <p className="text-slate-500 mb-10 text-lg font-medium">
                這項操作將永久刪除問卷及其所有收集到的回覆數據，且無法復原。
              </p>
              <div className="flex flex-col sm:flex-row gap-4">
                <button 
                  onClick={() => setDeleteTarget(null)}
                  className="flex-1 py-5 rounded-2xl bg-slate-100 text-slate-600 font-black hover:bg-slate-200 transition-all"
                >
                  取消
                </button>
                <button 
                  onClick={confirmDelete}
                  className="flex-1 py-5 rounded-2xl bg-rose-500 text-white font-black hover:bg-rose-600 shadow-xl shadow-rose-200 transition-all"
                >
                  確認刪除
                </button>
              </div>
            </div>
          </Modal>
        )}

        {/* Dashboard Header & Profile */}
          <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-20 gap-10">
            <div className="space-y-6 flex-1">
              <div className="inline-flex items-center gap-3 px-5 py-2 rounded-full bg-indigo-50 text-indigo-600 text-[10px] font-black uppercase tracking-[0.3em] border border-indigo-100/50">
                <span className="w-2 h-2 rounded-full bg-indigo-600 animate-pulse"></span>
                Creator Dashboard
              </div>
              <h1 className="text-7xl font-black text-slate-900 tracking-tighter leading-none">
                我的問卷庫<span className="text-indigo-600">.</span>
              </h1>
              <div className="flex items-center gap-5 p-2 pr-8 rounded-[2.5rem] bg-white border border-slate-100 w-fit shadow-xl shadow-slate-200/50 hover:shadow-indigo-500/5 transition-all duration-500 group">
                <div className="w-16 h-16 rounded-3xl bg-slate-50 flex items-center justify-center overflow-hidden border-4 border-white shadow-inner group-hover:border-indigo-100 transition-all duration-500">
                  {user.photoURL ? (
                    <img src={user.photoURL} alt={user.displayName} className="w-full h-full object-cover" />
                  ) : (
                    <i className="ph ph-user-circle-fill text-5xl text-slate-200 group-hover:text-indigo-600 transition-colors"></i>
                  )}
                </div>
                <div>
                  <p className="text-slate-400 text-[10px] font-black uppercase tracking-widest mb-1">Authenticated Account</p>
                  <div className="flex items-center gap-4">
                    <p className="text-slate-900 font-black text-2xl tracking-tight">{user.displayName || "使用者"}</p>
                    <button onClick={() => auth.signOut()} className="w-9 h-9 rounded-2xl bg-rose-50 text-rose-500 hover:bg-rose-500 hover:text-white flex items-center justify-center transition-all shadow-sm hover:shadow-rose-200" title="登出">
                      <i className="ph ph-sign-out-bold"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div className="flex flex-col md:flex-row items-stretch md:items-center gap-8 w-full lg:w-auto">
              <div className="grid grid-cols-3 gap-6 flex-1 md:flex-none">
                <div className="glass px-8 py-6 rounded-[2.5rem] border-2 border-white flex flex-col items-center justify-center min-w-[120px] shadow-2xl shadow-indigo-500/5 group hover:border-indigo-200 transition-all relative overflow-hidden">
                  <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-indigo-500/20 to-transparent"></div>
                  <div className="relative w-14 h-14 mb-3 flex items-center justify-center">
                    <div className="absolute inset-0 bg-indigo-50 rounded-2xl rotate-6 group-hover:rotate-45 transition-transform duration-500"></div>
                    <div className="relative w-full h-full bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center group-hover:bg-indigo-600 group-hover:text-white transition-all duration-500 shadow-inner border border-indigo-100/50">
                      <i className="ph ph-stack-bold text-2xl"></i>
                    </div>
                  </div>
                  <span className="text-4xl font-black text-slate-900 leading-none mb-2">{totalSurveys}</span>
                  <span className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">問卷總數</span>
                </div>
                <div className="glass px-8 py-6 rounded-[2.5rem] border-2 border-white flex flex-col items-center justify-center min-w-[120px] shadow-2xl shadow-emerald-500/5 group hover:border-emerald-200 transition-all relative overflow-hidden">
                  <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-emerald-500/20 to-transparent"></div>
                  <div className="relative w-14 h-14 mb-3 flex items-center justify-center">
                    <div className="absolute inset-0 bg-emerald-50 rounded-2xl rotate-6 group-hover:rotate-45 transition-transform duration-500"></div>
                    <div className="relative w-full h-full bg-emerald-50 text-emerald-500 rounded-2xl flex items-center justify-center group-hover:bg-emerald-500 group-hover:text-white transition-all duration-500 shadow-inner border border-emerald-100/50">
                      <i className="ph ph-trend-up-bold text-2xl"></i>
                    </div>
                  </div>
                  <span className="text-4xl font-black text-slate-900 leading-none mb-2">{totalActive}</span>
                  <span className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">進行中</span>
                </div>
                <div className="glass px-8 py-6 rounded-[2.5rem] border-2 border-white flex flex-col items-center justify-center min-w-[120px] shadow-2xl shadow-blue-500/5 group hover:border-blue-200 transition-all relative overflow-hidden">
                  <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-blue-500/20 to-transparent"></div>
                  <div className="relative w-14 h-14 mb-3 flex items-center justify-center">
                    <div className="absolute inset-0 bg-blue-50 rounded-2xl rotate-6 group-hover:rotate-45 transition-transform duration-500"></div>
                    <div className="relative w-full h-full bg-blue-50 text-blue-500 rounded-2xl flex items-center justify-center group-hover:bg-blue-600 group-hover:text-white transition-all duration-500 shadow-inner border border-blue-100/50">
                      <i className="ph ph-chat-circle-dots-bold text-2xl"></i>
                    </div>
                  </div>
                  <span className="text-4xl font-black text-slate-900 leading-none mb-2">{totalResponsesCount}</span>
                  <span className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">總回覆數</span>
                </div>
              </div>
              <Button onClick={onCreate} className="w-full md:w-auto px-12 py-8 text-2xl shadow-2xl shadow-indigo-500/20 hover:-translate-y-2 rounded-[2.5rem] bg-slate-900 hover:bg-indigo-600 group">
                <div className="w-10 h-10 bg-white/10 rounded-xl flex items-center justify-center mr-4 group-hover:rotate-90 transition-transform duration-500">
                  <i className="ph ph-plus-bold text-2xl"></i>
                </div>
                建立新問卷
              </Button>
            </div>
          </div>

          {cleanupStatus && <div className="mb-10"><Notice variant="info">{cleanupStatus}</Notice></div>}

          <div className="mb-12 flex flex-col md:flex-row gap-6 items-center justify-between">
            <div className="relative w-full md:max-w-md group">
              <i className="ph ph-magnifying-glass-bold absolute left-6 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-600 transition-colors text-xl"></i>
              <input 
                type="text"
                placeholder="搜尋問卷標題或內容..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="w-full pl-14 pr-8 py-5 bg-white border-2 border-slate-100 rounded-[2rem] focus:outline-none focus:border-indigo-600 focus:shadow-2xl focus:shadow-indigo-500/10 transition-all font-medium text-slate-900 placeholder:text-slate-300"
              />
            </div>
            <div className="flex items-center gap-4 text-slate-400 text-sm font-black uppercase tracking-widest">
              <span>共 {filteredSurveys.length} 份問卷</span>
            </div>
          </div>

          <div className="relative">
            {surveys.length === 0 ? (
              <div className="text-center py-40 glass rounded-[5rem] border-4 border-dashed border-slate-100 flex flex-col items-center group">
                <div className="relative w-40 h-40 mb-10">
                  <div className="absolute inset-0 bg-slate-50 rounded-[3.5rem] rotate-12 group-hover:rotate-0 transition-transform duration-700 shadow-inner"></div>
                  <div className="absolute inset-4 bg-white rounded-[2.5rem] -rotate-6 group-hover:rotate-0 transition-transform duration-700 shadow-sm flex items-center justify-center">
                    <i className="ph ph-folder-simple-dashed text-7xl text-slate-200 group-hover:text-indigo-200 transition-colors"></i>
                  </div>
                </div>
                <h3 className="text-4xl font-black text-slate-900 mb-6 tracking-tight">目前空空如也</h3>
                <p className="text-slate-400 mb-12 max-w-sm mx-auto text-lg font-medium leading-relaxed">您的問卷庫目前還沒有問卷。立即點擊下方按鈕，開始您的數據收集之旅吧！</p>
                <Button variant="secondary" onClick={onCreate} className="px-14 py-6 rounded-[2rem] shadow-xl shadow-slate-200">
                  立即建立第一份問卷
                </Button>
              </div>
            ) : filteredSurveys.length === 0 ? (
              <div className="text-center py-32 glass rounded-[4rem] border-2 border-slate-100 flex flex-col items-center">
                <i className="ph ph-magnifying-glass-bold text-6xl text-slate-200 mb-6"></i>
                <h3 className="text-2xl font-black text-slate-900 mb-2">找不到相關問卷</h3>
                <p className="text-slate-400 font-medium">請嘗試更換搜尋關鍵字</p>
              </div>
            ) : (
              <div className="grid gap-12 sm:grid-cols-2 lg:grid-cols-3">
                {filteredSurveys.map(s => (
                  <div key={s.id} className="group card-modern p-10 flex flex-col hover:border-indigo-600/30 relative overflow-hidden bg-white/60 backdrop-blur-xl border-2 border-white shadow-2xl shadow-slate-200/50 transition-all duration-700">
                    {/* Decorative card background */}
                    <div className="absolute top-0 right-0 w-56 h-56 bg-indigo-50/50 rounded-full -mr-28 -mt-28 group-hover:scale-150 transition-transform duration-1000 pointer-events-none blur-3xl opacity-50"></div>
                    
                    <div className="flex-1 relative">
                      <div className="flex flex-col gap-6 mb-8">
                        <div className="flex justify-between items-start">
                          <div className="relative w-24 h-24 group-hover:scale-110 transition-transform duration-700">
                            {/* Shadow and glow */}
                            <div className="absolute inset-2 bg-indigo-600/20 blur-xl group-hover:blur-2xl transition-all"></div>
                            
                            {/* Icon Base */}
                            <div className="relative w-full h-full bg-white rounded-3xl shadow-lg border border-slate-100 overflow-hidden flex items-center justify-center">
                              {/* Abstract Paper Decor */}
                              <div className="absolute top-0 left-0 w-full h-2 bg-indigo-600"></div>
                              <div className="flex flex-col gap-2 w-full px-4">
                                <div className="w-full h-1.5 bg-slate-100 rounded-full"></div>
                                <div className="w-4/5 h-1.5 bg-slate-100 rounded-full"></div>
                                <div className="w-full h-1.5 bg-slate-100 rounded-full"></div>
                                <div className="w-2/3 h-1.5 bg-indigo-50 rounded-full"></div>
                              </div>
                              
                              {/* Floating Floating Icon Overlay */}
                              <div className="absolute -right-1 -bottom-1 w-12 h-12 bg-slate-900 rounded-2xl flex items-center justify-center shadow-xl group-hover:bg-indigo-600 transition-colors duration-500 rotate-12 group-hover:rotate-0">
                                <i className="ph ph-file-text-fill text-white text-2xl"></i>
                              </div>
                            </div>
                          </div>

                          <div className="flex flex-col gap-2">
                            <div className="flex gap-2">
                              <button
                                onClick={() => shareSurvey(s)}
                                className="flex items-center gap-2 px-4 py-2 bg-indigo-50 text-indigo-600 hover:bg-indigo-600 hover:text-white rounded-xl transition-all duration-300 font-bold text-xs border border-indigo-100/50 active:scale-95"
                              >
                                <i className="ph ph-share-network-bold text-lg"></i>
                                <span>分享</span>
                              </button>
                              <button
                                onClick={() => duplicateSurvey(s)}
                                className="flex items-center gap-2 px-4 py-2 bg-emerald-50 text-emerald-600 hover:bg-emerald-600 hover:text-white rounded-xl transition-all duration-300 font-bold text-xs border border-emerald-100/50 active:scale-95"
                              >
                                <i className="ph ph-copy-bold text-lg"></i>
                                <span>複製</span>
                              </button>
                            </div>
                            <button
                              onClick={() => deleteSurvey(s.id)}
                              className="flex items-center justify-center gap-2 px-4 py-2 bg-rose-50 text-rose-600 hover:bg-rose-600 hover:text-white rounded-xl transition-all duration-300 font-bold text-xs border border-rose-100/50 active:scale-95"
                            >
                              <i className="ph ph-trash-bold text-lg"></i>
                              <span>刪除問卷</span>
                            </button>
                          </div>
                        </div>
                      </div>
                      
                      <h3 className="font-black text-4xl text-slate-900 line-clamp-2 mb-4 group-hover:text-indigo-600 transition-colors tracking-tight leading-tight min-h-[5rem]">{s.title || "未命名問卷"}</h3>
                      <div className="flex flex-wrap items-center gap-3 text-slate-400 text-[10px] font-black uppercase tracking-[0.2em] mb-12">
                        <div className="px-3 py-1.5 rounded-xl bg-slate-50 border border-slate-100 flex items-center gap-2">
                          <i className="ph ph-calendar-blank-bold text-sm"></i>
                          {new Date(s.createdAt || 0).toLocaleDateString()}
                        </div>
                        {s.active ? (
                          <div className="px-3 py-1.5 rounded-xl bg-emerald-50 text-emerald-600 border border-emerald-100 flex items-center gap-2">
                            <span className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                            進行中
                          </div>
                        ) : (
                          <div className="px-3 py-1.5 rounded-xl bg-slate-100 text-slate-400 border border-slate-200">
                            已關閉
                          </div>
                        )}

                        {/* Ephemeral Mode Badges */}
                        {s.expireAt && (
                          <div className={`px-3 py-1.5 rounded-xl border flex items-center gap-2 ${safeNow() > s.expireAt ? 'bg-rose-50 text-rose-600 border-rose-100' : 'bg-indigo-50 text-indigo-600 border-indigo-100'}`}>
                            <i className="ph ph-clock-countdown-bold"></i>
                            {safeNow() > s.expireAt ? '已過期' : `截止：${new Date(s.expireAt).toLocaleDateString()}`}
                          </div>
                        )}
                        {s.limitCount && (
                          <div className="px-3 py-1.5 rounded-xl bg-amber-50 text-amber-600 border border-amber-100 flex items-center gap-2">
                            <i className="ph ph-users-four-bold"></i>
                            上限：{s.limitCount}人
                          </div>
                        )}
                      </div>
                    </div>

                    <button
                      onClick={() => onAnalytics(s.id)}
                      className="w-full bg-slate-900 text-white py-7 rounded-[2.2rem] font-black text-lg flex items-center justify-center gap-4 hover:bg-indigo-600 active:scale-95 transition-all duration-700 shadow-2xl shadow-slate-200 group-hover:shadow-indigo-500/20 hover:-translate-y-2 border-b-4 border-slate-800 hover:border-indigo-700"
                    >
                      <i className="ph ph-chart-bar-fill text-2xl"></i> 
                      <span>數據分析中心</span>
                    </button>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      );
    };

    const CreateSurvey = ({ user, onBack }) => {
      const [title, setTitle] = useState("");
      const [desc, setDesc] = useState("");
      const [questions, setQuestions] = useState([{ id: String(safeNow()), type: "text", title: "", options: [] }]);
      const [saving, setSaving] = useState(false);
      const [toast, setToast] = useState(null);
      const [expireAt, setExpireAt] = useState(""); // ISO string
      const [limitCount, setLimitCount] = useState(""); // Number
      const [showAdvanced, setShowAdvanced] = useState(false);
      const [shareToken, setShareToken] = useState(String(Math.random().toString(36).substring(2, 11)));
      const [sharePublic, setSharePublic] = useState(false);

      const addQuestion = () => setQuestions(prev => [...prev, { id: String(safeNow() + Math.random()), type: "text", title: "", options: [] }]);
      const removeQuestion = (id) => setQuestions(prev => (prev.length <= 1 ? prev : prev.filter(q => q.id !== id)));
      const updateQuestion = (id, patch) => setQuestions(prev => prev.map(q => (q.id === id ? { ...q, ...patch } : q)));
      const addOption = (id) => setQuestions(prev => prev.map(q => q.id === id ? { ...q, options: [...(q.options || []), ""] } : q));
      const updateOption = (id, idx, value) => setQuestions(prev => prev.map(q => {
        if (q.id !== id) return q;
        const next = [...(q.options || [])];
        next[idx] = value;
        return { ...q, options: next };
      }));
      const removeOption = (id, idx) => setQuestions(prev => prev.map(q => {
        if (q.id !== id) return q;
        const next = [...(q.options || [])];
        next.splice(idx, 1);
        return { ...q, options: next };
      }));

      const submit = async () => {
        if (!title.trim()) return setToast({ message: "請輸入問卷標題", type: "error" });
        if (questions.some(q => !q.title.trim())) return setToast({ message: "請填寫所有問題內容", type: "error" });
        if (questions.some(q => q.type === "choice" && (!q.options || q.options.length < 2 || q.options.some(o => !String(o || "").trim())))) {
          return setToast({ message: "選擇題至少需要 2 個非空白選項", type: "error" });
        }
        setSaving(true);
        try {
          await db.collection("surveys").add({
            creatorId: user.uid,
            title: title.trim(),
            description: desc || "",
            questions: questions.map(q => ({
              id: q.id,
              type: q.type,
              title: q.title.trim(),
              options: q.type === "choice" ? (q.options || []).map(o => String(o || "").trim()) : [],
            })),
            createdAt: safeNow(),
            expireAt: expireAt ? new Date(expireAt).getTime() : null,
            limitCount: limitCount ? parseInt(limitCount) : null,
            shareToken: sharePublic ? shareToken : null,
            active: true,
          });
          setToast({ message: "問卷建立成功！", type: "success" });
          setTimeout(() => onBack(), 1500);
        } catch (err) {
          setToast({ message: "建立失敗：" + (err && err.message ? err.message : String(err)), type: "error" });
        } finally {
          setSaving(false);
        }
      };

      return (
        <div className="max-w-4xl mx-auto p-6 sm:p-12 fade-in pb-40">
          {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
          <div className="flex items-center justify-between mb-12">
            <button 
              onClick={onBack} 
              className="group flex items-center gap-3 text-slate-400 hover:text-indigo-600 transition-all font-black uppercase tracking-widest text-xs"
            >
              <div className="w-10 h-10 rounded-xl bg-white border border-slate-100 flex items-center justify-center group-hover:border-indigo-600 group-hover:bg-indigo-50 transition-all">
                <i className="ph ph-arrow-left text-lg"></i>
              </div>
              Back to Dashboard
            </button>
            <div className="hidden md:flex items-center gap-3 text-slate-300 font-bold text-sm">
              <span className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
              Draft Autosaved
            </div>
          </div>

          <div className="glass p-10 md:p-16 rounded-[3.5rem] shadow-2xl shadow-indigo-100/20 mb-12 border-4 border-white relative overflow-hidden group">
            <div className="absolute top-0 right-0 w-64 h-64 bg-indigo-50/50 rounded-full -mr-32 -mt-32 group-hover:scale-110 transition-transform duration-1000"></div>
            
            <div className="relative">
              <div className="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-indigo-600 text-white text-[10px] font-black uppercase tracking-[0.2em] mb-8">
                <i className="ph ph-pencil-line-fill"></i> Survey Identity
              </div>
              <input
                className="w-full text-5xl font-black border-none focus:ring-0 placeholder-slate-200 mb-6 bg-transparent tracking-tight leading-tight"
                placeholder="在此輸入令人印象深刻的標題"
                value={title}
                onChange={e => setTitle(e.target.value)}
              />
              <textarea
                className="w-full text-slate-500 border-none focus:ring-0 resize-none placeholder-slate-200 bg-transparent text-xl font-medium leading-relaxed"
                placeholder="為您的問卷添加一段優雅的描述，讓填答者更了解您的目的..."
                rows="2"
                value={desc}
                onChange={e => setDesc(e.target.value)}
              />
            </div>
          </div>

          {/* Advanced Settings - Ephemeral Mode */}
          <div className="mb-12">
            <button 
              onClick={() => setShowAdvanced(!showAdvanced)}
              className="flex items-center gap-3 text-slate-400 hover:text-indigo-600 transition-all font-black uppercase tracking-widest text-[10px] mb-4"
            >
              <i className={`ph ph-caret-${showAdvanced ? 'down' : 'right'}-bold text-sm`}></i>
              {showAdvanced ? '隱藏進階設定' : '顯示進階設定 (限時/限量焚毀模式)'}
            </button>
            
            {showAdvanced && (
              <div className="glass p-8 rounded-[2.5rem] border-2 border-dashed border-slate-100 flex flex-wrap gap-8 items-end fade-in">
                <div className="flex-1 min-w-[200px] space-y-3">
                  <label className="flex items-center gap-2 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                    <i className="ph ph-clock-countdown-fill text-indigo-500 text-lg"></i>
                    自動過期時間 (Optional)
                  </label>
                  <input 
                    type="datetime-local" 
                    className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-6 py-4 text-sm font-bold focus:ring-4 focus:ring-indigo-500/5 focus:border-indigo-600 transition-all"
                    value={expireAt}
                    onChange={e => setExpireAt(e.target.value)}
                  />
                </div>
                <div className="flex-1 min-w-[200px] space-y-3">
                  <label className="flex items-center gap-2 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                    <i className="ph ph-users-four-fill text-emerald-500 text-lg"></i>
                    填答人數上限 (Optional)
                  </label>
                  <input 
                    type="number" 
                    placeholder="例如: 100"
                    className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-6 py-4 text-sm font-bold focus:ring-4 focus:ring-indigo-500/5 focus:border-indigo-600 transition-all"
                    value={limitCount}
                    onChange={e => setLimitCount(e.target.value)}
                  />
                </div>
                <div className="flex-1 min-w-[250px] p-4 bg-indigo-50/50 rounded-2xl border border-indigo-100/50">
                  <p className="text-[10px] leading-relaxed text-indigo-600 font-bold">
                    💡 <b>焚毀模式：</b>設定後，問卷將在到達時間或人數上限時自動關閉，確保數據的時效性與稀缺性。
                  </p>
                </div>
              </div>
            )}
          </div>

          {/* Public Insight Share Settings */}
          <div className="mb-12">
            <button 
              onClick={() => setShowAdvanced(!showAdvanced)}
              className="hidden" // Just a dummy to reuse showAdvanced or create a new one
            ></button>
            
            {showAdvanced && (
              <div className="glass p-8 rounded-[2.5rem] border-2 border-dashed border-slate-100 flex flex-wrap gap-8 items-center fade-in mt-4 bg-emerald-50/10">
                <div className="flex items-center gap-4 flex-1 min-w-[300px]">
                  <div 
                    onClick={() => setSharePublic(!sharePublic)}
                    className={`w-14 h-8 rounded-full transition-all cursor-pointer relative ${sharePublic ? 'bg-emerald-500' : 'bg-slate-200'}`}
                  >
                    <div className={`absolute top-1 w-6 h-6 bg-white rounded-full transition-all ${sharePublic ? 'left-7' : 'left-1'}`}></div>
                  </div>
                  <div>
                    <h4 className="text-sm font-black text-slate-700 uppercase tracking-widest flex items-center gap-2">
                      <i className="ph ph-share-network-fill text-emerald-500"></i>
                      公開分析連結 (Insight Share)
                    </h4>
                    <p className="text-[10px] text-slate-400 font-bold">開啟後，任何人持有連結皆可查看去識別化的分析數據。</p>
                  </div>
                </div>
                {sharePublic && (
                  <div className="flex-1 min-w-[300px] flex items-center gap-3 bg-white p-3 rounded-2xl border-2 border-emerald-100">
                    <code className="flex-1 text-[10px] font-mono text-emerald-700 truncate">
                      .../analytics/public/{shareToken}
                    </code>
                    <div className="px-3 py-1 bg-emerald-50 text-emerald-600 text-[10px] font-black rounded-lg">
                      AUTO-TOKEN
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>

          <div className="space-y-10">
            {questions.map((q, idx) => (
              <div key={q.id} className="group card-modern p-10 relative hover:border-indigo-200 transition-all bg-white/70 backdrop-blur-md">
                <div className="absolute -left-1 top-10 w-2 h-16 bg-indigo-600 rounded-r-full opacity-0 group-hover:opacity-100 transition-all duration-500"></div>
                
                <div className="flex items-center justify-between mb-10">
                  <div className="flex items-center gap-6">
                    <div className="w-14 h-14 bg-slate-900 text-white rounded-[1.25rem] flex items-center justify-center font-black text-xl shadow-xl shadow-slate-200 group-hover:bg-indigo-600 transition-colors">
                      {idx + 1}
                    </div>
                    <div className="relative">
                      <select
                        className="appearance-none bg-slate-50 border-2 border-slate-100 rounded-2xl px-6 py-3 pr-12 text-sm font-black text-slate-600 focus:ring-4 focus:ring-indigo-500/5 focus:border-indigo-600 focus:bg-white cursor-pointer transition-all"
                        value={q.type}
                        onChange={e => updateQuestion(q.id, { type: e.target.value, options: e.target.value === "choice" ? (q.options || ["", ""]) : [] })}
                      >
                        <option value="text">💬 簡答題 (Text)</option>
                        <option value="choice">🔘 單選題 (Choice)</option>
                      </select>
                      <i className="ph ph-caret-down-bold absolute right-5 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                    </div>
                  </div>
                  {questions.length > 1 && (
                    <button 
                      onClick={() => removeQuestion(q.id)} 
                      className="w-12 h-12 flex items-center justify-center bg-rose-50 text-rose-500 hover:bg-rose-500 hover:text-white rounded-2xl transition-all shadow-sm hover:shadow-rose-100"
                      title="刪除題目"
                    >
                      <i className="ph ph-trash-bold text-xl"></i>
                    </button>
                  )}
                </div>

                <div className="space-y-8">
                  <div className="space-y-2">
                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] ml-1">Question Content</label>
                    <input
                      className="w-full text-2xl font-bold border-none border-b-4 border-slate-50 focus:border-indigo-600 focus:ring-0 pb-4 placeholder-slate-100 transition-all bg-transparent"
                      placeholder="您的問題內容是？"
                      value={q.title}
                      onChange={e => updateQuestion(q.id, { title: e.target.value })}
                    />
                  </div>

                  {q.type === "choice" && (
                    <div className="space-y-4 pl-4 border-l-4 border-slate-50">
                      <label className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] ml-1 mb-2 block">Options</label>
                      {(q.options || []).map((opt, oIdx) => (
                        <div key={oIdx} className="flex items-center gap-4 group/opt">
                          <div className="w-8 h-8 rounded-full border-2 border-slate-200 flex-shrink-0 flex items-center justify-center group-hover/opt:border-indigo-600 transition-all bg-white">
                            <div className="w-2.5 h-2.5 rounded-full bg-indigo-600 opacity-0 group-hover/opt:opacity-100 transition-opacity"></div>
                          </div>
                          <input
                            className="flex-1 bg-slate-50/50 border-2 border-slate-50 rounded-2xl px-6 py-4 text-sm font-bold focus:ring-4 focus:ring-indigo-500/5 focus:border-indigo-600 focus:bg-white transition-all"
                            value={opt}
                            onChange={e => updateOption(q.id, oIdx, e.target.value)}
                            placeholder={`選項 ${oIdx + 1}`}
                          />
                          <button 
                            onClick={() => removeOption(q.id, oIdx)} 
                            className="w-12 h-12 flex items-center justify-center text-slate-200 hover:text-rose-500 opacity-0 group-hover/opt:opacity-100 transition-all"
                          >
                            <i className="ph ph-minus-circle-bold text-2xl"></i>
                          </button>
                        </div>
                      ))}
                      <button 
                        onClick={() => addOption(q.id)} 
                        className="flex items-center gap-3 text-indigo-600 text-sm font-black hover:bg-indigo-50 px-6 py-3 rounded-2xl transition-all mt-4 w-fit"
                      >
                        <i className="ph ph-plus-circle-bold text-xl"></i> 新增選項
                      </button>
                    </div>
                  )}
                </div>
              </div>
            ))}
          </div>

          <div className="fixed bottom-12 left-1/2 -translate-x-1/2 w-[calc(100%-3rem)] max-w-4xl flex justify-between items-center glass p-6 rounded-[3rem] shadow-[0_30px_60px_-15px_rgba(79,70,229,0.4)] border-4 border-white z-50">
            <button 
              onClick={addQuestion} 
              className="group flex items-center gap-4 px-10 py-5 bg-slate-900 text-white rounded-[2rem] font-black text-lg hover:bg-indigo-600 transition-all active:scale-95 shadow-2xl shadow-slate-200"
            >
              <i className="ph ph-plus-circle-fill text-2xl group-hover:rotate-90 transition-transform"></i> 新增問題
            </button>
            <Button 
              onClick={submit} 
              disabled={saving} 
              className="px-14 py-5 text-xl rounded-[2rem] shadow-2xl shadow-indigo-300/50 hover:-translate-y-1"
            >
              {saving ? (
                <span className="spinner w-7 h-7 border-4 border-white/20 border-l-white"></span>
              ) : (
                <>發布問卷 <i className="ph ph-paper-plane-right-fill text-2xl ml-2"></i></>
              )}
            </Button>
          </div>
        </div>
      );
    };

    const TakeSurvey = ({ surveyId }) => {
      const [survey, setSurvey] = useState(null);
      const [closedReason, setClosedReason] = useState(null); // 'expired' | 'limited' | 'inactive'
      const [step, setStep] = useState(-1); // -1 intro, 0..n-1 questions, n success
      const [respondent, setRespondent] = useState({ name: "", email: "" });
      const [answers, setAnswers] = useState({});
      const [timings, setTimings] = useState({});
      const [loading, setLoading] = useState(true);
      const [submitting, setSubmitting] = useState(false);
      const [toast, setToast] = useState(null);
      const [focusMode, setFocusMode] = useState(true); // Default to Focus Mode
      const startAtRef = useRef(null);

      useEffect(() => {
        let cancelled = false;
        const params = new URLSearchParams(window.location.search);
        const urlTitle = params.get("t");
        if (urlTitle) {
          document.title = `SurveyLight｜${urlTitle}`;
        }

        const fetchSurvey = async () => {
          setLoading(true);
          try {
            const doc = await db.collection("surveys").doc(surveyId).get();
            if (!doc.exists) throw new Error("問卷不存在或已被刪除");
            const data = { id: doc.id, ...doc.data() };
            document.title = `SurveyLight｜${data.title || "填寫問卷"}`;

            // Check Active
            if (!data.active) {
              setClosedReason('inactive');
              if (!cancelled) setSurvey(data);
              return;
            }

            // Check Expire
            if (data.expireAt && safeNow() > data.expireAt) {
              setClosedReason('expired');
              if (!cancelled) setSurvey(data);
              return;
            }

            // Check Limit
            if (data.limitCount) {
              const resSnap = await db.collection("responses").where("surveyId", "==", surveyId).get();
              if (resSnap.size >= data.limitCount) {
                setClosedReason('limited');
                if (!cancelled) setSurvey(data);
                return;
              }
            }

            if (!cancelled) setSurvey(data);
          } catch (err) {
            setToast({ message: (err && err.message) ? err.message : "載入問卷失敗", type: "error" });
          } finally {
            if (!cancelled) setLoading(false);
          }
        };
        fetchSurvey();
        return () => { cancelled = true; };
      }, [surveyId]);

      useEffect(() => {
        if (step >= 0 && survey && step < (survey.questions || []).length) {
          startAtRef.current = safeNow();
        }
      }, [step, survey]);

      const recordTimingForStep = () => {
        if (!survey) return;
        if (step < 0 || step >= survey.questions.length) return;
        const qId = survey.questions[step].id;
        const elapsed = Math.max(0, (safeNow() - (startAtRef.current || safeNow())) / 1000);
        setTimings(prev => ({ ...prev, [qId]: (prev[qId] || 0) + elapsed }));
      };

      const nextFromIntro = () => {
        if (!respondent.name.trim() || !respondent.email.trim()) return setToast({ message: "請輸入姓名與 Email", type: "error" });
        const email = respondent.email.trim().toLowerCase();
        const basicOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        const isGmail = email.endsWith("@gmail.com") || email.endsWith("@googlemail.com");
        if (!basicOk) return setToast({ message: "Email 格式不正確，請重新輸入。", type: "error" });
        if (!isGmail) return setToast({ message: "為確保填答者身份，本問卷僅接受 Gmail（@gmail.com）信箱填寫。", type: "error" });
        setStep(0);
      };

      const nextQuestion = () => {
        const q = survey.questions[step];
        const val = answers[q.id];
        if (!val) {
          const el = document.getElementById(`q-${q.id}`);
          if (el) {
            el.classList.add('shake');
            setTimeout(() => el.classList.remove('shake'), 500);
          }
          return setToast({ message: "此題為必填，請提供您的回答再繼續 ✨", type: "error" });
        }
        
        // Calculate and update timing
        const elapsed = Math.max(0, (safeNow() - (startAtRef.current || safeNow())) / 1000);
        setTimings(prev => ({ ...prev, [q.id]: (prev[q.id] || 0) + elapsed }));
        
        setStep(prev => prev + 1);
      };

      const submit = async () => {
        const q = survey.questions[step];
        const val = answers[q.id];
        if (!val) return setToast({ message: "最後一題也別忘了填寫喔！✨", type: "error" });
        
        // Finalize timings including the last question
        const elapsed = Math.max(0, (safeNow() - (startAtRef.current || safeNow())) / 1000);
        const finalTimings = { ...timings, [q.id]: (timings[q.id] || 0) + elapsed };

        setSubmitting(true);
        try {
          await db.collection("responses").add({
            surveyId: survey.id,
            surveyCreatorId: survey.creatorId || null,
            respondent: { name: respondent.name.trim(), email: respondent.email.trim() },
            answers,
            timings: finalTimings,
            submittedAt: safeNow(),
          });
          setStep(survey.questions.length); // success
        } catch (err) {
          setToast({ message: "提交失敗：" + (err && err.message ? err.message : String(err)), type: "error" });
        } finally {
          setSubmitting(false);
        }
      };

      if (loading) return <Loading text="載入問卷中..." />;
      if (!survey) return (
        <div className="min-h-screen flex items-center justify-center p-6 text-slate-400 font-medium">
          {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
          找不到問卷
        </div>
      );

      // Survey Closed State
      if (closedReason) {
        const reasonConfig = {
          expired: { icon: "ph-clock-countdown-fill", color: "text-indigo-600", bg: "bg-indigo-50", title: "問卷已過期", desc: "本問卷已達到預設的截止時間，目前不開放填寫。" },
          limited: { icon: "ph-users-four-fill", color: "text-emerald-600", bg: "bg-emerald-50", title: "填答人數已滿", desc: "感謝熱烈參與！本問卷已達到填答人數上限。" },
          inactive: { icon: "ph-lock-fill", color: "text-slate-600", bg: "bg-slate-50", title: "問卷已關閉", desc: "發布者已手動關閉此問卷。" }
        }[closedReason] || { icon: "ph-prohibit-fill", color: "text-rose-600", bg: "bg-rose-50", title: "無法填寫", desc: "此問卷目前不開放填答。" };

        return (
          <div className="min-h-screen flex items-center justify-center p-6 bg-slate-50/50">
            <div className="text-center glass p-16 md:p-24 rounded-[4rem] shadow-2xl shadow-slate-100 max-w-2xl w-full border-4 border-white fade-in relative overflow-hidden">
              <div className={`w-32 h-32 ${reasonConfig.bg} ${reasonConfig.color} rounded-[2.5rem] flex items-center justify-center mx-auto mb-10 shadow-xl border border-white`}>
                <i className={`ph ${reasonConfig.icon} text-6xl`}></i>
              </div>
              <h2 className="text-5xl font-black text-slate-900 mb-6 tracking-tight leading-tight">{reasonConfig.title}</h2>
              <p className="text-slate-500 text-xl font-medium leading-relaxed max-w-md mx-auto">
                {reasonConfig.desc}
              </p>
              <div className="mt-16 pt-10 border-t border-slate-100 flex items-center justify-center gap-3 text-slate-400 font-black uppercase tracking-[0.2em] text-xs">
                <i className="ph ph-shield-check-fill text-slate-300"></i>
                SurveyLight Secure Access
              </div>
            </div>
          </div>
        );
      }

      if (step >= (survey.questions || []).length && step !== -1) {
        return (
        <div className="min-h-screen flex items-center justify-center p-6 bg-indigo-50/20">
          {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
          <div className="text-center glass p-16 md:p-24 rounded-[4rem] shadow-2xl shadow-indigo-100/30 max-w-2xl w-full border-4 border-white fade-in relative overflow-hidden">
              <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 to-emerald-500"></div>
              <div className="w-32 h-32 bg-indigo-600 text-white rounded-[2.5rem] flex items-center justify-center mx-auto mb-10 shadow-2xl shadow-indigo-200 rotate-6 animate-bounce-subtle">
                <i className="ph ph-check-circle-fill text-6xl"></i>
              </div>
              <h2 className="text-5xl font-black text-slate-900 mb-6 tracking-tight leading-tight">感謝您的參與！</h2>
              <p className="text-slate-500 text-xl font-medium leading-relaxed max-w-md mx-auto">
                您的回覆已成功送出。我們非常重視您的寶貴意見，這將幫助我們做得更好。
              </p>
              <div className="mt-16 pt-10 border-t border-slate-100 flex items-center justify-center gap-3 text-slate-400 font-black uppercase tracking-[0.2em] text-xs">
                <i className="ph ph-sparkle-fill text-indigo-500"></i>
                Powered by SurveyLight
              </div>
            </div>
          </div>
        );
      }

      if (step === -1) {
        return (
          <div className="min-h-screen flex items-center justify-center p-6 bg-slate-50 relative overflow-hidden">
            {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
            {/* Background Decorations */}
            <div className="absolute top-0 left-0 w-full h-full pointer-events-none">
              <div className="absolute top-[-10%] right-[-10%] w-[40%] h-[40%] bg-indigo-100/40 rounded-full blur-[100px]"></div>
              <div className="absolute bottom-[-10%] left-[-10%] w-[40%] h-[40%] bg-blue-100/40 rounded-full blur-[100px]"></div>
            </div>

            <div className="glass p-10 md:p-20 rounded-[4rem] shadow-2xl shadow-indigo-100/20 max-w-2xl w-full border-4 border-white fade-in relative">
              <div className="w-20 h-20 bg-slate-900 text-white rounded-3xl flex items-center justify-center mb-10 shadow-xl shadow-slate-200">
                <i className="ph ph-article-fill text-4xl"></i>
              </div>
              <h1 className="text-5xl font-black text-slate-900 mb-6 tracking-tight leading-tight">{survey.title}</h1>
              <p className="text-slate-500 mb-12 whitespace-pre-wrap text-xl font-medium leading-relaxed">{survey.description || "歡迎填寫此問卷，您的意見對我們非常重要。"}</p>

              {/* Urgency/Info Badges for Respondent */}
              {(survey.expireAt || survey.limitCount) && (
                <div className="flex flex-wrap gap-3 mb-12">
                  {survey.expireAt && (
                    <div className="px-4 py-2 rounded-2xl bg-indigo-50 text-indigo-600 border border-indigo-100 flex items-center gap-2 text-sm font-black">
                      <i className="ph ph-clock-countdown-fill"></i>
                      <span>截止時間：{new Date(survey.expireAt).toLocaleString()}</span>
                    </div>
                  )}
                  {survey.limitCount && (
                    <div className="px-4 py-2 rounded-2xl bg-amber-50 text-amber-600 border border-amber-100 flex items-center gap-2 text-sm font-black">
                      <i className="ph ph-users-four-fill"></i>
                      <span>限量填答：{survey.limitCount} 人</span>
                    </div>
                  )}
                </div>
              )}

              <div className="space-y-8 mb-12">
                <div className="space-y-3">
                  <label className="text-[10px] font-black text-slate-400 uppercase tracking-[0.3em] ml-2">Your Name</label>
                  <input
                    className="w-full bg-white border-2 border-slate-100 rounded-[1.75rem] px-8 py-5 focus:ring-4 focus:ring-indigo-500/5 focus:border-indigo-600 outline-none transition-all font-black text-slate-700 text-lg placeholder-slate-200"
                    value={respondent.name}
                    onChange={e => setRespondent({ ...respondent, name: e.target.value })}
                    placeholder="請輸入您的姓名"
                  />
                </div>
                <div className="space-y-3">
                  <label className="text-[10px] font-black text-slate-400 uppercase tracking-[0.3em] ml-2">Email (Gmail only)</label>
                  <input
                    type="email"
                    className="w-full bg-white border-2 border-slate-100 rounded-[1.75rem] px-8 py-5 focus:ring-4 focus:ring-indigo-500/5 focus:border-indigo-600 outline-none transition-all font-black text-slate-700 text-lg placeholder-slate-200"
                    value={respondent.email}
                    onChange={e => setRespondent({ ...respondent, email: e.target.value })}
                    placeholder="example@gmail.com"
                  />
                </div>
              </div>

              <Button onClick={nextFromIntro} className="w-full py-6 text-xl rounded-[2rem] shadow-2xl shadow-indigo-200">
                開始填寫 <i className="ph ph-arrow-right-bold text-2xl"></i>
              </Button>
            </div>
          </div>
        );
      }

      const q = survey.questions[step];
      const isLast = step === survey.questions.length - 1;
      const progress = Math.round(((step) / survey.questions.length) * 100);
      const nextProgress = Math.round(((step + 1) / survey.questions.length) * 100);

      return (
        <div className={`min-h-screen flex flex-col items-center justify-center p-6 transition-all duration-1000 relative overflow-hidden ${focusMode ? 'bg-slate-950' : 'bg-slate-50'}`}>
          {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
          
          {/* Focus Mode Background Effects */}
          {focusMode && (
            <div className="absolute inset-0 pointer-events-none overflow-hidden">
              <div className="absolute top-[-20%] left-[-10%] w-[60%] h-[60%] bg-indigo-900/20 rounded-full blur-[120px] animate-pulse"></div>
              <div className="absolute bottom-[-20%] right-[-10%] w-[60%] h-[60%] bg-blue-900/20 rounded-full blur-[120px] animate-pulse" style={{ animationDelay: '2s' }}></div>
              <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full h-full opacity-10" style={{ background: 'radial-gradient(circle, rgba(79,70,229,0.1) 0%, transparent 70%)' }}></div>
            </div>
          )}

          {/* Top Progress Bar */}
          <div className={`fixed top-0 left-0 w-full h-1.5 z-[60] transition-all duration-500 ${focusMode ? 'bg-white/5' : 'bg-slate-200'}`}>
            <div 
              className="h-full bg-gradient-to-r from-indigo-500 via-indigo-600 to-indigo-400 transition-all duration-700 ease-out shadow-[0_0_20px_rgba(79,70,229,0.5)]"
              style={{ width: `${nextProgress}%` }}
            ></div>
          </div>

          <div className={`fixed top-10 left-1/2 -translate-x-1/2 z-[60] flex items-center gap-4 px-6 py-3 rounded-full border transition-all duration-500 ${focusMode ? 'bg-white/5 border-white/10 text-white backdrop-blur-xl' : 'bg-white/80 border-white text-slate-900 shadow-xl shadow-indigo-500/5 backdrop-blur-xl'}`}>
            <span className={`text-[10px] font-black uppercase tracking-[0.3em] ${focusMode ? 'text-indigo-400' : 'text-indigo-600'}`}>Progress</span>
            <div className="flex items-center gap-1.5">
              {survey.questions.map((_, idx) => (
                <div 
                  key={idx}
                  className={`w-2 h-2 rounded-full transition-all duration-500 ${
                    idx < step 
                      ? (focusMode ? 'bg-indigo-500' : 'bg-indigo-600') 
                      : idx === step 
                        ? (focusMode ? 'bg-indigo-400 w-6' : 'bg-indigo-600 w-8') 
                        : (focusMode ? 'bg-white/10' : 'bg-slate-200')
                  }`}
                ></div>
              ))}
            </div>
            <div className="w-px h-4 bg-white/10 mx-2"></div>
            <button 
              onClick={() => setFocusMode(!focusMode)}
              className={`w-8 h-8 rounded-lg flex items-center justify-center transition-all ${focusMode ? 'bg-indigo-500/20 text-indigo-400 hover:bg-indigo-500/30' : 'bg-slate-100 text-slate-400 hover:bg-indigo-50 hover:text-indigo-600'}`}
              title={focusMode ? "切換至一般模式" : "切換至沈浸模式"}
            >
              <i className={`ph ${focusMode ? 'ph-eye-fill' : 'ph-eye-closed-fill'} text-lg`}></i>
            </button>
          </div>

          <div id={`q-${q.id}`} className={`transition-all duration-700 w-full max-w-2xl relative ${focusMode ? 'scale-105' : ''}`}>
            <div className={`p-10 md:p-20 rounded-[4rem] shadow-2xl transition-all duration-700 border-4 relative overflow-hidden ${
              focusMode 
                ? 'bg-white/5 backdrop-blur-3xl border-white/10 shadow-indigo-950/50' 
                : 'glass border-white shadow-indigo-100/20'
            }`}>
              {focusMode && (
                <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-indigo-500/50 to-transparent"></div>
              )}
              
              <div className="flex justify-between items-center mb-10">
                <div className={`px-6 py-2.5 rounded-2xl text-xs font-black tracking-[0.2em] transition-all duration-500 ${
                  focusMode ? 'bg-indigo-500/20 text-indigo-300' : 'bg-slate-900 text-white'
                }`}>
                  QUESTION {step + 1} OF {survey.questions.length}
                </div>
                <div className={`font-black italic text-4xl transition-all duration-500 ${
                  focusMode ? 'text-white/5' : 'text-slate-300'
                }`}>
                  {String(step + 1).padStart(2, '0')}
                </div>
              </div>

              <h2 className={`text-4xl font-black mb-12 tracking-tight leading-tight min-h-[5rem] transition-all duration-500 ${
                focusMode ? 'text-white' : 'text-slate-900'
              }`}>{q.title}</h2>

              <div className="space-y-6 mb-16">
                {q.type === "text" ? (
                  <div className="relative group">
                    <textarea
                      className={`w-full border-2 rounded-[2.5rem] px-8 py-7 focus:ring-8 outline-none transition-all font-bold text-xl min-h-[200px] placeholder-slate-400 resize-none shadow-inner ${
                        focusMode 
                          ? 'bg-white/5 border-white/10 text-white focus:ring-indigo-500/20 focus:border-indigo-500/50' 
                          : 'bg-white border-slate-100 text-slate-700 focus:ring-indigo-500/5 focus:border-indigo-600'
                      }`}
                      value={answers[q.id] || ""}
                      onChange={e => setAnswers({ ...answers, [q.id]: e.target.value })}
                      placeholder="請在此輸入您的回答..."
                    />
                    <div className={`absolute bottom-6 right-8 text-[10px] font-black uppercase tracking-widest pointer-events-none transition-colors ${
                      focusMode ? 'text-white/20 group-focus-within:text-indigo-400' : 'text-slate-300 group-focus-within:text-indigo-400'
                    }`}>
                      Character Count: {(answers[q.id] || "").length}
                    </div>
                  </div>
                ) : (
                  <div className="grid gap-4">
                    {(q.options || []).map((opt, oIdx) => {
                      const isSelected = answers[q.id] === opt;
                      return (
                        <button
                          key={oIdx}
                          onClick={() => setAnswers({ ...answers, [q.id]: opt })}
                          className={`group flex items-center gap-6 p-7 rounded-[2rem] border-2 transition-all duration-500 text-left relative overflow-hidden ${
                            isSelected 
                              ? (focusMode 
                                  ? 'border-indigo-500 bg-indigo-500 text-white shadow-2xl shadow-indigo-500/40 scale-[1.02] z-10' 
                                  : 'border-indigo-600 bg-indigo-600 text-white shadow-2xl shadow-indigo-200 scale-[1.02] z-10')
                              : (focusMode 
                                  ? 'border-white/5 bg-white/5 text-white/60 hover:border-white/20 hover:bg-white/10' 
                                  : 'border-slate-100 bg-white text-slate-600 hover:border-indigo-200 hover:bg-indigo-50/30')
                          }`}
                        >
                          <div className={`w-10 h-10 rounded-2xl flex items-center justify-center flex-shrink-0 transition-all duration-500 ${
                            isSelected 
                              ? (focusMode ? 'bg-white text-indigo-600 rotate-12' : 'bg-white text-indigo-600 rotate-12')
                              : (focusMode ? 'bg-white/5 text-white/30 group-hover:bg-white/10 group-hover:text-white/50' : 'bg-slate-50 text-slate-300 group-hover:bg-indigo-100 group-hover:text-indigo-400')
                          }`}>
                            <span className="font-black text-lg">{String.fromCharCode(65 + oIdx)}</span>
                          </div>
                          <span className="flex-1 font-bold text-xl tracking-tight">{opt}</span>
                          {isSelected && (
                            <i className="ph ph-check-circle-fill text-3xl animate-in fade-in zoom-in duration-300"></i>
                          )}
                        </button>
                      );
                    })}
                  </div>
                )}
              </div>

              <div className="flex gap-4">
                {step > 0 && (
                  <button
                    onClick={() => setStep(prev => prev - 1)}
                    className={`flex-1 py-6 rounded-[2rem] font-black text-lg transition-all active:scale-95 border-2 ${
                      focusMode 
                        ? 'bg-white/5 border-white/10 text-white/40 hover:text-white hover:border-white/20' 
                        : 'bg-white border-slate-100 text-slate-400 hover:border-indigo-600 hover:text-indigo-600'
                    }`}
                  >
                    上一步
                  </button>
                )}
                {isLast ? (
                  <Button 
                    onClick={submit} 
                    disabled={submitting} 
                    className={`flex-[2] py-6 text-xl rounded-[2rem] shadow-2xl ${
                      focusMode ? 'shadow-indigo-500/20' : 'shadow-indigo-200'
                    }`}
                  >
                    {submitting ? (
                      <span className="spinner w-7 h-7 border-4 border-white/20 border-l-white"></span>
                    ) : (
                      <>完成並提交 <i className="ph ph-paper-plane-right-fill text-2xl ml-2"></i></>
                    )}
                  </Button>
                ) : (
                  <Button 
                    onClick={nextQuestion} 
                    className={`flex-[2] py-6 text-xl rounded-[2rem] shadow-2xl ${
                      focusMode ? 'shadow-indigo-500/20' : 'shadow-indigo-200'
                    }`}
                  >
                    下一題 <i className="ph ph-arrow-right-bold text-2xl"></i>
                  </Button>
                )}
              </div>
            </div>
            
            {focusMode && (
              <div className="mt-8 text-center">
                <p className="text-white/20 text-[10px] font-black uppercase tracking-[0.4em] flex items-center justify-center gap-3">
                  <span className="w-8 h-px bg-white/10"></span>
                  Immersive Focus Mode Active
                  <span className="w-8 h-px bg-white/10"></span>
                </p>
              </div>
            )}
          </div>
        </div>
      );
    };

    const Analytics = ({ surveyId, user, onBack, publicToken = null }) => {
      const [survey, setSurvey] = useState(null);
      const [responses, setResponses] = useState([]);
      const [stats, setStats] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [selected, setSelected] = useState(null);
      const [toast, setToast] = useState(null);
      const [pulse, setPulse] = useState(false);

      useEffect(() => {
        let cancelled = false;
        let unsubscribeSurvey = () => {};
        let unsubscribeResponses = () => {};

        const init = async () => {
          setLoading(true);
          try {
            let sDoc;
            if (publicToken) {
              const sSnap = await db.collection("surveys").where("shareToken", "==", publicToken).get();
              if (sSnap.empty) throw new Error("此公開分析連結無效或已關閉");
              sDoc = sSnap.docs[0];
            } else {
              sDoc = await db.collection("surveys").doc(surveyId).get();
            }

            if (!sDoc.exists) throw new Error("問卷不存在");
            const sData = { id: sDoc.id, ...sDoc.data() };

            if (!publicToken && sData.creatorId !== user?.uid) {
              throw new Error("權限不足：您不是此問卷的建立者");
            }
            if (!cancelled) setSurvey(sData);

            // Real-time listener for Live Pulse
            unsubscribeResponses = db.collection("responses")
              .where("surveyId", "==", sData.id)
              .onSnapshot(snap => {
                const rData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if (!cancelled) {
                  setResponses(rData);
                  setPulse(true);
                  setTimeout(() => setPulse(false), 1000);
                  
                  if (rData.length > 0) {
                    let totalTime = 0;
                    const qTimings = {};
                    rData.forEach(r => {
                      let rTotal = 0;
                      Object.entries(r.timings || {}).forEach(([qid, time]) => {
                        const t = Number(time) || 0;
                        rTotal += t;
                        if (!qTimings[qid]) qTimings[qid] = { sum: 0, count: 0 };
                        qTimings[qid].sum += t;
                        qTimings[qid].count += 1;
                      });
                      totalTime += rTotal;
                    });
                    setStats({
                      totalCount: rData.length,
                      avgCompletionTime: totalTime / rData.length,
                      questionStats: qTimings,
                    });
                  } else {
                    setStats({ totalCount: 0, avgCompletionTime: 0, questionStats: {} });
                  }
                }
              }, err => {
                if (!cancelled) setError(err.message);
              });

          } catch (err) {
            if (!cancelled) setError(err.message);
          } finally {
            if (!cancelled) setLoading(false);
          }
        };

        init();
        return () => { 
          cancelled = true; 
          unsubscribeSurvey();
          unsubscribeResponses();
        };
      }, [surveyId, user?.uid, publicToken]);

      const formatTime = (seconds) => {
        const s = Number(seconds) || 0;
        if (s < 60) return `${s.toFixed(1)}s`;
        return `${Math.floor(s / 60)}m ${(s % 60).toFixed(0)}s`;
      };

      const downloadCSV = () => {
        try {
          if (!survey || responses.length === 0) return;
          
          // CSV Headers
          const headers = ["回覆時間", "填答者姓名", "填答者 Email"];
          survey.questions.forEach((q, idx) => {
            headers.push(`Q${idx + 1}: ${q.title}`);
            headers.push(`Q${idx + 1} 耗時(秒)`);
          });
          
          const rows = [headers];
          
          responses.forEach(r => {
            const row = [
              new Date(r.submittedAt || 0).toLocaleString(),
              r.respondent?.name || "",
              r.respondent?.email || ""
            ];
            
            survey.questions.forEach(q => {
              row.push(r.answers?.[q.id] || "");
              row.push(r.timings?.[q.id] || 0);
            });
            
            rows.push(row);
          });
          
          const csvContent = "\uFEFF" + rows.map(e => e.map(val => `"${String(val).replace(/"/g, '""')}"`).join(",")).join("\n");
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.setAttribute("href", url);
          link.setAttribute("download", `SurveyLight_${survey.title}_${new Date().toLocaleDateString()}.csv`);
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          setToast({ message: "報表匯出成功！", type: "success" });
        } catch (err) {
          setToast({ message: "匯出失敗：" + err.message, type: "error" });
        }
      };

      if (loading) return <Loading text="正在分析數據..." />;
      
      if (error) {
        return (
          <div className="flex flex-col items-center justify-center min-h-[70vh] p-6 text-center">
            <div className="w-24 h-24 bg-rose-50 text-rose-500 rounded-[2.5rem] flex items-center justify-center mb-8 shadow-xl shadow-rose-100">
              <i className="ph ph-warning-octagon-fill text-5xl"></i>
            </div>
            <h2 className="text-4xl font-black text-slate-900 mb-4 tracking-tight">Oops! Something went wrong</h2>
            <p className="text-slate-500 mb-10 text-lg font-medium max-w-md mx-auto">{error}</p>
            <Button onClick={onBack} className="px-12 py-5 rounded-2xl shadow-xl shadow-slate-200">
              <i className="ph ph-arrow-left-bold"></i> 返回儀表板
            </Button>
          </div>
        );
      }

      return (
        <div className="max-w-6xl mx-auto p-6 sm:p-12 fade-in pb-32">
          {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
          {/* Header */}
          <div className="flex flex-col md:flex-row md:items-center justify-between gap-8 mb-16">
            <div className="flex items-center gap-8">
              {!publicToken && (
                <button 
                  onClick={onBack} 
                  className="group w-14 h-14 flex items-center justify-center bg-white rounded-2xl shadow-sm text-slate-400 hover:text-indigo-600 transition-all border border-slate-100 hover:border-indigo-100 hover:bg-indigo-50"
                >
                  <i className="ph ph-arrow-left text-2xl group-hover:-translate-x-1 transition-transform"></i>
                </button>
              )}
              <div className="min-w-0">
                <div className={`inline-flex items-center gap-2 px-4 py-1.5 rounded-full text-white text-[10px] font-black uppercase tracking-[0.2em] mb-4 transition-all duration-500 ${pulse ? 'bg-rose-500 scale-110 shadow-lg shadow-rose-200' : 'bg-indigo-600'}`}>
                  <i className={`ph ${pulse ? 'ph-broadcast-fill animate-pulse' : 'ph-chart-line-up-fill'}`}></i>
                  {pulse ? 'Live Update Incoming!' : 'Insight Analytics'}
                </div>
                <h1 className="text-4xl font-black text-slate-900 truncate tracking-tight leading-tight">{survey?.title}</h1>
                <div className="flex items-center gap-4 mt-2">
                  <span className="text-slate-400 text-sm font-bold flex items-center gap-1.5">
                    <i className="ph ph-calendar-blank-bold"></i>
                    建立於：{new Date((survey?.createdAt || 0)).toLocaleDateString()}
                  </span>
                  <span className="w-1 h-1 rounded-full bg-slate-200"></span>
                  <span className="text-slate-400 text-sm font-bold flex items-center gap-1.5">
                    <i className="ph ph-hash-bold"></i>
                    ID: {surveyId.slice(0, 8)}...
                  </span>
                  {publicToken && (
                    <>
                      <span className="w-1 h-1 rounded-full bg-slate-200"></span>
                      <span className="px-2 py-0.5 bg-emerald-50 text-emerald-600 rounded text-[10px] font-black uppercase tracking-widest border border-emerald-100">Public View</span>
                    </>
                  )}
                </div>
              </div>
            </div>

            {responses.length > 0 && !publicToken && (
              <Button 
                onClick={downloadCSV}
                className="bg-emerald-600 hover:bg-emerald-700 shadow-xl shadow-emerald-100/50 px-8 py-4 rounded-2xl flex items-center gap-3"
              >
                <i className="ph ph-file-csv-fill text-2xl"></i>
                匯出數據報表 (CSV)
              </Button>
            )}
          </div>

          {responses.length === 0 ? (
            <div className="text-center py-40 glass rounded-[5rem] border-4 border-dashed border-slate-100 bg-white/50 fade-in">
              <div className="w-32 h-32 bg-slate-50 text-slate-200 rounded-[3rem] flex items-center justify-center mx-auto mb-10 shadow-inner">
                <i className="ph ph-chart-bar-horizontal-fill text-7xl"></i>
              </div>
              <h3 className="text-4xl font-black text-slate-900 mb-6 tracking-tight">等待第一筆回覆...</h3>
              <p className="text-slate-400 text-xl font-medium max-w-md mx-auto mb-12 leading-relaxed">
                目前還沒有人填寫這份問卷。快將問卷分享出去，收集寶貴的數據吧！
              </p>
              <Button onClick={onBack} className="px-14 py-6 rounded-[2rem] shadow-2xl shadow-indigo-100">返回儀表板</Button>
            </div>
          ) : (
            <div className="space-y-20 fade-in">
              {/* Stats Cards */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10">
                <div className={`glass p-12 rounded-[4rem] border-4 border-white shadow-2xl relative overflow-hidden group hover:-translate-y-2 transition-all duration-500 ${pulse ? 'ring-8 ring-indigo-500/20 scale-[1.02] shadow-indigo-200' : 'shadow-indigo-100/30'}`}>
                  <div className="absolute top-0 right-0 w-40 h-40 bg-indigo-50/50 rounded-full -mr-20 -mt-20 group-hover:scale-150 transition-transform duration-1000"></div>
                  {pulse && <div className="absolute top-8 right-8 w-4 h-4 bg-rose-500 rounded-full animate-ping z-20"></div>}
                  <div className="relative">
                    <div className="w-16 h-16 bg-slate-900 text-white rounded-[1.5rem] flex items-center justify-center mb-10 shadow-2xl shadow-slate-200 group-hover:bg-indigo-600 transition-colors">
                      <i className={`ph ph-users-fill text-3xl ${pulse ? 'animate-bounce' : ''}`}></i>
                    </div>
                    <p className="text-[10px] font-black text-indigo-600 uppercase tracking-[0.3em] mb-3">Total Responses</p>
                    <div className="flex items-baseline gap-4">
                      <p className="text-7xl font-black text-slate-900 tracking-tighter">{stats?.totalCount || 0}</p>
                      <p className="text-slate-400 font-black text-xl">回覆</p>
                    </div>
                  </div>
                </div>

                <div className={`glass p-12 rounded-[4rem] border-4 border-white shadow-2xl relative overflow-hidden group hover:-translate-y-2 transition-all duration-500 ${pulse ? 'ring-8 ring-emerald-500/20 scale-[1.02] shadow-emerald-200' : 'shadow-emerald-100/30'}`}>
                  <div className="absolute top-0 right-0 w-40 h-40 bg-emerald-50/50 rounded-full -mr-20 -mt-20 group-hover:scale-150 transition-transform duration-1000"></div>
                  <div className="relative">
                    <div className="w-16 h-16 bg-emerald-500 text-white rounded-[1.5rem] flex items-center justify-center mb-10 shadow-2xl shadow-emerald-100 group-hover:bg-emerald-600 transition-colors">
                      <i className="ph ph-clock-fill text-3xl"></i>
                    </div>
                    <p className="text-[10px] font-black text-emerald-600 uppercase tracking-[0.3em] mb-3">Avg. Time</p>
                    <div className="flex items-baseline gap-4">
                      <p className="text-7xl font-black text-slate-900 tracking-tighter">{formatTime(stats?.avgCompletionTime || 0)}</p>
                    </div>
                  </div>
                </div>

                <div className={`glass p-12 rounded-[4rem] border-4 border-white shadow-2xl relative overflow-hidden group hover:-translate-y-2 transition-all duration-500 ${pulse ? 'ring-8 ring-amber-500/20 scale-[1.02] shadow-amber-200' : 'shadow-amber-100/30'} hidden lg:block`}>
                  <div className="absolute top-0 right-0 w-40 h-40 bg-amber-50/50 rounded-full -mr-20 -mt-20 group-hover:scale-150 transition-transform duration-1000"></div>
                  <div className="relative">
                    <div className="w-16 h-16 bg-amber-500 text-white rounded-[1.5rem] flex items-center justify-center mb-10 shadow-2xl shadow-amber-100 group-hover:bg-amber-600 transition-colors">
                      <i className={`ph ${pulse ? 'ph-lightning-fill text-rose-500 animate-pulse' : 'ph-trend-up-fill'} text-3xl`}></i>
                    </div>
                    <p className="text-[10px] font-black text-amber-600 uppercase tracking-[0.3em] mb-3">{pulse ? 'LIVE PULSE ACTIVE' : 'Status Monitoring'}</p>
                    <div className="flex items-center gap-3">
                      <div className={`w-4 h-4 rounded-full ${pulse ? 'bg-rose-500 animate-ping' : 'bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]'}`}></div>
                      <p className="text-3xl font-black text-slate-900 tracking-tighter uppercase">{pulse ? 'Receiving...' : 'Connected'}</p>
                    </div>
                  </div>
                </div>
              </div>

              {/* Timing Analysis */}
              <div className="space-y-10">
                <div className="flex items-center justify-between px-4">
                  <div>
                    <h3 className="text-3xl font-black text-slate-900 tracking-tight">題目耗時分析</h3>
                    <p className="text-slate-400 font-bold mt-1">了解填答者在哪些題目停留最久</p>
                  </div>
                  <div className="w-12 h-12 rounded-2xl bg-slate-50 flex items-center justify-center text-slate-300">
                    <i className="ph ph-timer-bold text-2xl"></i>
                  </div>
                </div>
                
                <div className="grid gap-6">
                  {(survey?.questions || []).map((q, idx) => {
                    const qs = (stats?.questionStats || {})[q.id];
                    const avg = qs ? (qs.sum / qs.count) : 0;
                    // Calculate relative width for a mini bar chart
                    const maxTime = Math.max(...Object.values(stats?.questionStats || {}).map(s => s.sum / s.count), 1);
                    const widthPercent = Math.max(5, (avg / maxTime) * 100);

                    return (
                      <div key={q.id} className="group glass p-8 rounded-[2.5rem] border-2 border-white hover:border-indigo-100 transition-all bg-white/40 backdrop-blur-md">
                        <div className="flex flex-col md:flex-row md:items-center gap-8">
                          <div className="w-16 h-16 bg-slate-900 text-white rounded-2xl flex items-center justify-center font-black text-xl flex-shrink-0 group-hover:bg-indigo-600 transition-colors shadow-lg">
                            {idx + 1}
                          </div>
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-3 mb-2">
                              <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest bg-slate-100 px-3 py-1 rounded-lg">
                                {q.type === 'choice' ? '🔘 Choice' : '💬 Text'}
                              </span>
                              <span className="text-sm font-black text-indigo-600 tabular-nums">平均 {formatTime(avg)}</span>
                            </div>
                            <h4 className="text-xl font-black text-slate-900 truncate mb-4">{q.title}</h4>
                            
                            {/* Mini Bar Chart */}
                            <div className="h-3 w-full bg-slate-100 rounded-full overflow-hidden shadow-inner">
                              <div 
                                className="h-full bg-gradient-to-r from-indigo-500 to-indigo-400 rounded-full transition-all duration-1000 ease-out"
                                style={{ width: `${widthPercent}%` }}
                              ></div>
                            </div>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>

              {/* Respondent List */}
              <div className="space-y-10">
                <div className="flex items-center justify-between px-4">
                  <div>
                    <h3 className="text-3xl font-black text-slate-900 tracking-tight">詳細填答名單</h3>
                    <p className="text-slate-400 font-bold mt-1">共 {responses.length} 筆回覆數據</p>
                  </div>
                  <div className="w-12 h-12 rounded-2xl bg-slate-50 flex items-center justify-center text-slate-300">
                    <i className="ph ph-users-bold text-2xl"></i>
                  </div>
                </div>

                <div className="card-modern overflow-hidden bg-white/70 backdrop-blur-xl border-2 border-white">
                  <div className="overflow-x-auto">
                    <table className="w-full text-left border-collapse whitespace-nowrap">
                      <thead>
                        <tr className="bg-slate-50/50 text-slate-400 text-[10px] font-black uppercase tracking-[0.3em]">
                          <th className="p-10">填答者資訊</th>
                          <th className="p-10">作答總時長</th>
                          <th className="p-10">提交時間</th>
                          <th className="p-10 text-right">操作</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-slate-50">
                        {responses
                          .sort((a, b) => (b.submittedAt || 0) - (a.submittedAt || 0))
                          .map((r) => {
                            const totalTime = Object.values(r.timings || {}).reduce((a, b) => a + (Number(b) || 0), 0);
                            return (
                              <tr key={r.id} className="group hover:bg-white transition-all duration-300">
                                <td className="p-10">
                                  <div className="flex items-center gap-6">
                                    <div className="w-16 h-16 bg-slate-50 rounded-[1.5rem] flex items-center justify-center text-slate-300 group-hover:bg-indigo-600 group-hover:text-white transition-all duration-500 shadow-inner">
                                      <i className="ph ph-user-fill text-2xl"></i>
                                    </div>
                                    <div>
                                      <div className="font-black text-slate-900 text-xl mb-1">{r.respondent?.name || "匿名"}</div>
                                      <div className="text-sm text-slate-400 font-bold tracking-tight">{r.respondent?.email || "無信箱資訊"}</div>
                                    </div>
                                  </div>
                                </td>
                                <td className="p-10">
                                  <div className="inline-flex items-center gap-3 px-5 py-2.5 bg-indigo-50 text-indigo-600 rounded-2xl font-black text-lg">
                                    <i className="ph ph-clock-fill"></i>
                                    {formatTime(totalTime)}
                                  </div>
                                </td>
                                <td className="p-10">
                                  <div className="space-y-1">
                                    <div className="text-slate-900 font-black text-lg">{new Date(r.submittedAt || 0).toLocaleDateString()}</div>
                                    <div className="text-slate-400 font-bold text-xs uppercase tracking-widest">
                                      {new Date(r.submittedAt || 0).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                    </div>
                                  </div>
                                </td>
                                <td className="p-10 text-right">
                                  <button
                                    onClick={() => setSelected(r)}
                                    className="inline-flex items-center gap-3 px-10 py-5 bg-slate-900 text-white rounded-2xl font-black text-sm hover:bg-indigo-600 transition-all active:scale-95 shadow-2xl shadow-slate-200 group-hover:shadow-indigo-500/20"
                                  >
                                    查看詳情 <i className="ph ph-eye-fill text-xl"></i>
                                  </button>
                                </td>
                              </tr>
                            );
                          })}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Response Detail Modal */}
          {selected && (
            <Modal
              title="填答詳情回顧"
              onClose={() => setSelected(null)}
              footer={
                <div className="flex justify-end w-full">
                  <Button onClick={() => setSelected(null)} className="px-14 py-5 rounded-[2rem] shadow-2xl shadow-indigo-200">
                    關閉詳情
                  </Button>
                </div>
              }
            >
              <div className="space-y-12">
                {/* User Profile Header */}
                <div className="relative overflow-hidden glass p-10 rounded-[3.5rem] border-4 border-white shadow-2xl shadow-indigo-100/20 group">
                  <div className="absolute top-0 right-0 w-40 h-40 bg-indigo-50 rounded-full -mr-20 -mt-20 group-hover:scale-110 transition-transform duration-1000"></div>
                  <div className="relative flex flex-col sm:flex-row items-center justify-between gap-8">
                    <div className="flex items-center gap-8">
                      <div className="w-20 h-20 bg-slate-900 text-white rounded-[2rem] flex items-center justify-center shadow-2xl shadow-slate-200 group-hover:bg-indigo-600 transition-colors">
                        <i className="ph ph-user-circle-fill text-5xl"></i>
                      </div>
                      <div>
                        <div className="font-black text-3xl text-slate-900 mb-2">{selected.respondent?.name || "匿名"}</div>
                        <div className="flex items-center gap-2 text-slate-500 font-bold">
                          <i className="ph ph-envelope-simple-fill text-indigo-400"></i>
                          {selected.respondent?.email || "未提供信箱"}
                        </div>
                      </div>
                    </div>
                    <div className="flex flex-col items-center sm:items-end gap-2">
                      <div className="text-[10px] font-black text-slate-300 uppercase tracking-[0.2em]">Total Time Spent</div>
                      <div className="px-8 py-4 bg-white rounded-2xl shadow-sm border border-slate-100 text-3xl font-black text-indigo-600 tabular-nums">
                        {formatTime(Object.values(selected.timings || {}).reduce((a, b) => a + (Number(b) || 0), 0))}
                      </div>
                    </div>
                  </div>
                </div>

                {/* Question Responses */}
                <div className="space-y-8">
                  <div className="flex items-center gap-4 px-4">
                    <div className="w-10 h-10 bg-slate-900 text-white rounded-xl flex items-center justify-center">
                      <i className="ph ph-list-checks-bold text-xl"></i>
                    </div>
                    <h4 className="text-2xl font-black text-slate-900 tracking-tight">逐題回答詳情</h4>
                  </div>
                  
                  <div className="space-y-8">
                    {(survey?.questions || []).map((q, idx) => {
                      const ans = (selected.answers || {})[q.id];
                      const t = (selected.timings || {})[q.id];
                      return (
                        <div key={q.id} className="group glass p-10 rounded-[3.5rem] border-2 border-white hover:border-indigo-100 transition-all bg-white/50 backdrop-blur-md">
                          <div className="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-8">
                            <div className="flex items-center gap-5">
                              <div className="w-12 h-12 bg-slate-100 text-slate-400 rounded-2xl flex items-center justify-center font-black group-hover:bg-indigo-600 group-hover:text-white transition-all">
                                {idx + 1}
                              </div>
                              <div className="inline-flex items-center gap-2 px-4 py-1.5 rounded-xl bg-slate-50 border border-slate-100 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                {q.type === 'choice' ? '🔘 Choice Question' : '💬 Text Question'}
                              </div>
                            </div>
                            <div className="inline-flex items-center gap-2 px-5 py-2.5 bg-white rounded-2xl border border-slate-100 shadow-sm text-xs font-black text-indigo-600 uppercase tracking-widest tabular-nums">
                              <i className="ph ph-timer-bold text-lg"></i>
                              {formatTime(t || 0)}
                            </div>
                          </div>
                          <h5 className="font-black text-slate-900 mb-8 text-2xl tracking-tight leading-tight group-hover:text-indigo-600 transition-colors">{q.title}</h5>
                          <div className="bg-white/80 rounded-[2rem] p-8 border-2 border-slate-50 text-slate-700 font-bold text-xl leading-relaxed shadow-inner">
                            {ans ? (
                              <div className="flex items-start gap-5">
                                <div className="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center flex-shrink-0">
                                  <i className="ph ph-chat-centered-dots-fill text-indigo-400 text-2xl"></i>
                                </div>
                                <div className="pt-1">{String(ans)}</div>
                              </div>
                            ) : (
                              <div className="flex items-center gap-5 text-slate-300 italic">
                                <div className="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center flex-shrink-0">
                                  <i className="ph ph-prohibit-bold text-2xl"></i>
                                </div>
                                <span>填答者跳過了此題</span>
                              </div>
                            )}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            </Modal>
          )}
        </div>
      );
    };

    const DebugStatus = () => {
      const [online, setOnline] = useState(navigator.onLine ? "Online" : "Offline");
      useEffect(() => {
        const on = () => setOnline("Online");
        const off = () => setOnline("Offline");
        window.addEventListener("online", on);
        window.addEventListener("offline", off);
        return () => {
          window.removeEventListener("online", on);
          window.removeEventListener("offline", off);
        };
      }, []);
      return (
        <div className="fixed bottom-2 right-2 text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded opacity-50 hover:opacity-100 pointer-events-none">
          Network: {online} | Domain: {window.location.hostname}
        </div>
      );
    };

    const Footer = () => (
      <footer className="py-8 text-center">
        <p className="text-[10px] text-gray-400 font-medium tracking-widest uppercase">By Owen</p>
      </footer>
    );

    // --- App ---
    const App = () => {
      const [user, setUser] = useState(null);
      const [route, setRoute] = useState(getHashRoute());
      const [activeSurveyId, setActiveSurveyId] = useState(null);
      const [booting, setBooting] = useState(true);
      const [authLoading, setAuthLoading] = useState(true);
      const [isInAppBrowser, setIsInAppBrowser] = useState(false);
      const [globalToast, setGlobalToast] = useState(null);

      // 檢測是否為 App 內建瀏覽器 (LINE, FB, Messenger, etc.)
      useEffect(() => {
        const ua = navigator.userAgent || navigator.vendor || window.opera;
        const isInApp = /Line|FBAN|FBAV|Instagram|Messenger/.test(ua);
        setIsInAppBrowser(isInApp);
      }, []);

      // 處理 Firebase Redirect 登入結果
      useEffect(() => {
        const handleRedirect = async () => {
          try {
            const result = await auth.getRedirectResult();
            if (result && result.user) {
              console.log("Redirect login success:", result.user.email);
              setUser(result.user);
              // 成功登入後，主動導向儀表板
              if (getHashRoute() === "/login" || getHashRoute() === "/") {
                navigateHash("/dashboard");
              }
            }
          } catch (error) {
            console.error("Redirect login error:", error);
            if (error.code === 'auth/unauthorized-domain') {
              setGlobalToast({ message: mapAuthErrorToZh(error), type: "error" });
            }
          } finally {
            // 延遲一點點關閉 authLoading，確保狀態同步
            setTimeout(() => setAuthLoading(false), 100);
          }
        };
        handleRedirect();
      }, []);

      // 1) Public mode: ?s={surveyId} 無需登入
      const publicSurveyId = useMemo(() => {
        const params = new URLSearchParams(window.location.search);
        return params.get("s");
      }, []);

      // 2) Public Analytics Mode
      const publicToken = useMemo(() => {
        const r = getHashRoute();
        if (r.startsWith("/analytics/public/")) {
          return r.replace("/analytics/public/", "");
        }
        return null;
      }, [route]);

      useEffect(() => {
        const onHashChange = () => setRoute(getHashRoute());
        window.addEventListener("hashchange", onHashChange);
        return () => window.removeEventListener("hashchange", onHashChange);
      }, []);

      useEffect(() => {
        // Hide boot-loading once React is alive
        const bootEl = document.getElementById("boot-loading");
        if (bootEl) bootEl.style.display = "none";
        setBooting(false);
      }, []);

      useEffect(() => {
        // PWA: register service worker (best-effort)
        if (!("serviceWorker" in navigator)) return;
        const isLocalhost = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1";
        // GitHub Pages 與 localhost 都可註冊；失敗就忽略（不影響主功能）
        navigator.serviceWorker.register("./sw.js").catch((err) => {
          console.warn("Service worker 註冊失敗：", err);
          if (isLocalhost) {
            // localhost 才提示，避免正式站干擾
            console.warn("（本機提示）若你用 file:// 開啟，SW 會無法註冊，請用 http server。");
          }
        });
      }, []);

      useEffect(() => {
        if (publicSurveyId || publicToken) return; // public mode 不用等 auth
        const unsub = auth.onAuthStateChanged(
          (u) => {
            setUser(u);
            if (!u) {
              // 只有在非 redirect 處理中，才跳轉登入
              if (!authLoading) navigateHash("/login");
            } else {
              if (getHashRoute() === "/" || getHashRoute() === "/login") navigateHash("/dashboard");
            }
          },
          (err) => {
            console.error("Auth State Error:", err);
            if (!authLoading) navigateHash("/login");
          }
        );
        return () => unsub();
      }, [publicSurveyId, authLoading]);

      if (booting || (authLoading && !publicSurveyId && !publicToken)) return <Loading text="正在確認身分..." />;

      if (publicSurveyId) {
        return (
          <React.Fragment>
            {globalToast && <Toast message={globalToast.message} type={globalToast.type} onClose={() => setGlobalToast(null)} />}
            <TakeSurvey surveyId={publicSurveyId} />
            <Footer />
            <DebugStatus />
          </React.Fragment>
        );
      }

      if (publicToken) {
        return (
          <React.Fragment>
            {globalToast && <Toast message={globalToast.message} type={globalToast.type} onClose={() => setGlobalToast(null)} />}
            <Analytics surveyId={null} user={null} onBack={null} publicToken={publicToken} />
            <Footer />
            <DebugStatus />
          </React.Fragment>
        );
      }

      // Protected SPA routes via hash
      const isAuthed = !!user;
      const current = route;

      if (isInAppBrowser && !publicSurveyId) {
        return (
          <React.Fragment>
            {globalToast && <Toast message={globalToast.message} type={globalToast.type} onClose={() => setGlobalToast(null)} />}
            <InAppBrowserNotice />
            <Footer />
            <DebugStatus />
          </React.Fragment>
        );
      }

      if (!isAuthed) {
        return (
          <React.Fragment>
            {globalToast && <Toast message={globalToast.message} type={globalToast.type} onClose={() => setGlobalToast(null)} />}
            <LoginView />
            <Footer />
            <DebugStatus />
          </React.Fragment>
        );
      }

      if (current === "/create") {
        return (
          <React.Fragment>
            {globalToast && <Toast message={globalToast.message} type={globalToast.type} onClose={() => setGlobalToast(null)} />}
            <CreateSurvey user={user} onBack={() => navigateHash("/dashboard")} />
            <Footer />
            <DebugStatus />
          </React.Fragment>
        );
      }

      if (current.startsWith("/analytics")) {
        // /analytics?s= is public param; 我們用 hash query 的方式：#/analytics/{id}
        const parts = current.split("/");
        const sid = parts.length >= 3 ? parts[2] : activeSurveyId;
        if (!sid) {
          return (
            <React.Fragment>
              {globalToast && <Toast message={globalToast.message} type={globalToast.type} onClose={() => setGlobalToast(null)} />}
              <div className="max-w-xl mx-auto p-6">
                <Notice variant="danger">找不到問卷 ID，請從儀表板進入分析頁。</Notice>
                <Button className="mt-4" onClick={() => navigateHash("/dashboard")}>返回儀表板</Button>
              </div>
              <Footer />
              <DebugStatus />
            </React.Fragment>
          );
        }
        return (
          <React.Fragment>
            {globalToast && <Toast message={globalToast.message} type={globalToast.type} onClose={() => setGlobalToast(null)} />}
            <Analytics surveyId={sid} user={user} onBack={() => navigateHash("/dashboard")} />
            <Footer />
            <DebugStatus />
          </React.Fragment>
        );
      }

      // default dashboard
      return (
        <React.Fragment>
          {globalToast && <Toast message={globalToast.message} type={globalToast.type} onClose={() => setGlobalToast(null)} />}
          <Dashboard
            user={user}
            onCreate={() => navigateHash("/create")}
            onAnalytics={(sid) => { setActiveSurveyId(sid); navigateHash("/analytics/" + sid); }}
          />
          <Footer />
          <DebugStatus />
        </React.Fragment>
      );
    };

    const rootEl = document.getElementById("root");
    const root = ReactDOM.createRoot(rootEl);
    root.render(<App />);
  </script>
</body>
</html>

